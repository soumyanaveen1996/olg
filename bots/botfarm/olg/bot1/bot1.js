(function(){
/*! For license information please see main.js.LICENSE.txt */
!function(){var t={d:function(e,r){for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r:function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};!function(){"use strict";t.r(e),t.d(e,{asyncRequest:function(){return ji},asyncResult:function(){return hi},done:function(){return Mi},init:function(){return Ei},isActiveWithMessage:function(){return Bi},next:function(){return li},open:function(){return Ui},version:function(){return ni}});var r="PERSISTED_FIELD_",n="AUTO_SAVE_BUFFER_",o="PERSISTENT_STORAGE_",i="toSyncWithBackend",a="_activity",s="change",c="changeFilter",u="renameFilter",l="multipleSelection",h="clearFilter",f="clearSearch",p="audit",y="index",v="LOOKUP_FIELD_",m="filter_prefix_",g="insert",b="upsert",w="delete",S="query",k="form_response",E="table_response",x="container_response",I="videoCall",T="search",O="onAction",C="onRefresh",L="onDiscard",P="move",F="click",A="completion",R="confirm",N="onConfirm",j="cancel",M="close",U="results",B="change",G="deleteRow",q="append",V="changeColumnTemplate",K="validation",Y="quickAction",W="onFieldAction",z="onSelection",H="onMenuAction",Q="onDownload",J="onDelete",$="onSave",X="previousPage",Z="nextPage",tt="filter",et="editFilter",rt="filterDelete",nt="createOverlay",ot="editOverlay",it="deleteOverlay",at="topMenu",st="showAreas",ct="object",ut="calendar",lt="table",ht="map",ft="frontmai",dt="lastMainTimeStamp",pt="_messageProcessingStart",yt="mobile",vt="web",mt="web2",gt="Edge",bt="Cloud",_t="input.unknown",wt="collection",St="doc",kt="field",Et={OPEN_AI:"openAI",LEX:"lex",DIALOGFLOW:"dialogflow"},xt={EMMA_PROMPT_KEY:"emmaPrompt",DEFAULT_PROMPT_KEY:"defaultPrompt",DEFAULT_CHAT_PROMPT_KEY:"defaultChatPrompt",EMMA_NLP_KEY:"emmaNLP",DEFAULT_NLP_KEY:"defaultNLP",DEFAULT_CHAT_NLP_KEY:"defaultChatNLP",WEB_BROWSER_COMMON_PROMPT:"webBrowserCommonPrompt"},It="CHAT",Tt="_getRelevantQuestions",Ot="main",Ct="system";function Lt(t){return Lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Lt(t)}function Pt(){Pt=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Lt(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Lt(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Dt(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Ft(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Lt(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Lt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Lt(o)?o:String(o)),n)}var o}var At=function(){function t(e,r,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._intentId=e,this._runLocation=gt,this._edgeEvents=[],this._cloudEvents=[],this._presentEvent="",this._nlpId="",this._smartSuggestions=[],this._dependencies=[],this._logHistory=!0,this._silentIntent=!1,this._onPrediction=function(){},this.tabId=n||e,this.onInit=function(){var t,e=(t=Pt().mark((function t(e){return Pt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)})),function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Dt(i,n,o,a,s,"next",t)}function s(t){Dt(i,n,o,a,s,"throw",t)}a(void 0)}))});return function(t){return e.apply(this,arguments)}}(),r&&(this._state=r,this._state.setIntentWithId(e,this))}var e,r,n;return e=t,n=[{key:"SPEECH",value:function(){return"speech"}},{key:"LOCATION",value:function(){return"__location_"}},{key:"CONTACT",value:function(){return"__contact_"}},{key:"IMAGE",value:function(){return"__image_"}},{key:"VIDEO",value:function(){return"__video_"}},{key:"FILE",value:function(){return"__file_"}}],(r=[{key:"resetProperties",value:function(){}},{key:"runOnCloud",value:function(){this._runLocation=bt}},{key:"runOnCloudWithEdgeEvents",value:function(t){t&&Array.isArray(t)&&t.length>0&&(this._edgeEvents=t),this._runLocation=bt}},{key:"runOnEdge",value:function(){this._runLocation=gt}},{key:"runOnEdgeWithCloudEvents",value:function(t){t&&Array.isArray(t)&&t.length>0&&(this._cloudEvents=t),this._runLocation=gt}},{key:"disableHistoryLogging",value:function(){this._logHistory=!1}},{key:"silenceIntent",value:function(){this._silentIntent=!0}},{key:"silentIntent",get:function(){return this._silentIntent}},{key:"logHistory",get:function(){return this._logHistory}},{key:"runLocation",get:function(){return this._edgeEvents.indexOf(this._presentEvent)>-1||this._cloudEvents.indexOf(this._presentEvent)>-1?gt:this._runLocation}},{key:"onValidation",get:function(){return this._onValidation},set:function(t){this._onValidation=t}},{key:"onError",get:function(){return this._onError},set:function(t){this._onError=t}},{key:"id",get:function(){return this._intentId}},{key:"intentId",get:function(){return this._intentId}},{key:"nlpId",get:function(){return this._nlpId},set:function(t){this._nlpId=t}},{key:"suggestionsArray",get:function(){return this._smartSuggestions},set:function(t){this._smartSuggestions=t}},{key:"setEnglishSmartSuggestions",value:function(t){Array.isArray(t)?this._smartSuggestions=[{lang:"en",list:t.reverse()}]:this._state.developer.warning({message:"The suggestions argument must be an array",data:this._intentId})}},{key:"setEnglishSmartSuggestionsWithCondition",value:function(t,e,r){Array.isArray(e)&&Array.isArray(t)?r()?this._smartSuggestions=[{lang:"en",list:e.reverse()}]:this._smartSuggestions=[{lang:"en",list:t.reverse()}]:this._smartSuggestions=[{lang:"en",list:["Invalid smart suggestion type. Must be array"]}]}},{key:"setSmartSuggestions",value:function(t,e){this._smartSuggestions=[{lang:t,list:e}]}},{key:"matchSuggestions",value:function(){var t=this;return"string"==typeof this._state.messageFromUser&&!!this._smartSuggestions.find((function(e){return e.list.includes(t._state.messageFromUser)}))}},{key:"onMatching",get:function(){return this._onMatching},set:function(t){this._onMatching=t}},{key:"onResolution",get:function(){return this._onResolution},set:function(t){this._onResolution=t}},{key:"onPrediction",get:function(){return this._onPrediction},set:function(t){this._onPrediction=t}}])&&Ft(e.prototype,r),n&&Ft(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Rt(t){return Rt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Rt(t)}function Nt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Rt(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Rt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Rt(o)?o:String(o)),n)}var o}var jt=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}var e,r;return e=t,r=[{key:"SYSTEM_ERROR",value:function(){return"SYSTEM_ERROR"}},{key:"USER_ERROR",value:function(){return"USER_ERROR"}},{key:"WARNING",value:function(){return"WARNING"}},{key:"INFO",value:function(){return"INFO"}},{key:"DEBUG",value:function(){return"DEBUG"}},{key:"LOG",value:function(){return"LOG"}},{key:"PERF",value:function(){return"PERF"}}],null&&Nt(e.prototype,null),r&&Nt(e,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Mt(t){return Mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Mt(t)}function Ut(){Ut=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Mt(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Mt(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Bt(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Gt(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Bt(i,n,o,a,s,"next",t)}function s(t){Bt(i,n,o,a,s,"throw",t)}a(void 0)}))}}function qt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Mt(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Mt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Mt(o)?o:String(o)),n)}var o}function Vt(t,e){return Vt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Vt(t,e)}function Kt(t){return Kt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Kt(t)}var Yt=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Vt(t,e)}(s,t);var e,r,n,o,i,a=(o=s,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=Kt(o);if(i){var r=Kt(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===Mt(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(this,t)});function s(t,e){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),(r=a.call(this,t,e)).onTest=Gt(Ut().mark((function t(){return Ut().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onVerification=Gt(Ut().mark((function t(){return Ut().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r}return e=s,r=[{key:"unitTestIntent",get:function(){return!0}},{key:"onMatching",get:function(){var t=this;return function(e){return"string"===e.messageTypeFromUser&&e.messageFromUser.substring(0,5)===s.RUN_COMMAND()&&e.R.toLower(e.messageFromUser.substring(6,e.messageFromUser.length))===e.R.toLower(t.intentId)}}},{key:"onResolution",get:function(){var t=this;return function(){var e=Gt(Ut().mark((function e(r){return Ut().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.onTest();case 2:0===r.responsesArray.length&&r.addStringResponse(s.TEST_RUN_MSG());case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}}],n=[{key:"RUN_COMMAND",value:function(){return"@@run"}},{key:"TEST_RUN_MSG",value:function(){return"Test request submitted successfully"}},{key:"VERIFICATION_RUN_MSG",value:function(){return"Verification process finished"}},{key:"TEST_CASES_FIELD",value:function(){return"testCases"}},{key:"CURRENT_TEST_FIELD",value:function(){return"currentTest"}}],r&&qt(e.prototype,r),n&&qt(e,n),Object.defineProperty(e,"prototype",{writable:!1}),s}(At);function Wt(t){return Wt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Wt(t)}function zt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Wt(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Wt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Wt(o)?o:String(o)),n)}var o}var Ht=function(){function t(e,r,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._errorCode=r,this._errorMessage=r<1e3?n?t.getErrorMessageforCodeAndLang(r,e.lang)+" "+n:t.getErrorMessageforCodeAndLang(r,e.lang):n}var e,r,n;return e=t,n=[{key:"getErrorMessageforCodeAndLang",value:function(t,e){return{0:{en:"No error"},1:{en:"The valid values for RunLocation are Edge and Cloud"},2:{en:"RunLocation attribute is mandatory"},3:{en:"The onResolution function is mandatory"},4:{en:"To process your request, I need to reach the cloud and you appear to be offline at this moment. Please try again later"},5:{en:"Error in edge bot logic with message "},6:{en:"NLP.js cannot be called with other data than string"},7:{en:"Error processing botResolver in backend"},8:{en:"Error in cloud bot logic with message "},9:{en:"The name for the bot name already exists for your domain, please change it and try again"},10:{en:"An unknown problem has appeared during the bot publication process. Please contact FrontM support."},11:{en:"Logic error in onError function"},12:{en:"Wrong debug command"},13:{en:"I Cannot run inApp purchases in the cloud"},14:{en:"Invalid message adding a response"},15:{en:"I have not received the authorisation to activate the notifications. You can request me to activate the notifications in any time."},16:{en:"I could not register your device for notifications at this moment. Please try again later"},17:{en:"I could not modify your password. Please be sure that your old password is correct and that you are following the FrontM password policy"},18:{en:"Capability not available on the cloud"},19:{en:"I encountered a problem unregistering your device for notifications"},20:{en:"I could not deregister your device for notifications at this moment. Please try again later"},21:{en:"Invalid intent object found"},22:{en:"Ambiguous NLP.js results"},23:{en:"This method requires an array of Strings"},24:{en:"Invalid NLP.js Id"},25:{en:"Invalid backend capability"},26:{en:"Backend capabilities are not present on edge"},27:{en:"Error running predictors with message "},28:{en:"Bad table action "},29:{en:"Bad form action "},30:{en:"Action not recognized during video call"},31:{en:"Error while encrypting data"},32:{en:"Error while decrypting data"},33:{en:"Could not send push notification "},34:{en:"Ambiguous intent matching. Please review your forms, tables and containers looking for duplicated names"},35:{en:"Ambiguous intent matching. Please review your intentIds looking for duplicated names or check your matching rules"},36:{en:"Could not write data in DB"},37:{en:"Error calling service"},38:{en:"Unidentified intent or control"},39:{en:"Bad data from cache in backend"},40:{en:"The Record you are trying to open is not available offline"},41:{en:"Invalid coordinates"},42:{en:"Error synchronising data "},43:{en:"Error sending a message in backend"},45:{en:"Error building document"},46:{en:"Bad field action "},47:{en:"Bad container action "},48:{en:"Bad map action "},49:{en:"Bad geofence action "},50:{en:"The data property is too big and it cannot be logged. Message: "},51:{en:"Duplicated entries in autoSave buffer"},52:{en:"The autoSave buffer is empty"},53:{en:"Location not available or with very weak signal"},54:{en:"Location not available on the cloud"},55:{en:"SQS Messages can only be sent from the cloud"},56:{en:"Your system appears to be offline. Please check your internet connection and try again later"},57:{en:"Field value error"},58:{en:"Error in video meeting"},59:{en:"Error in timelines response"},60:{en:"OpenAI response in error"},61:{en:"The Main intent running on cloud doesn't have an onResolution event"},62:{en:"getMultipleStaticDataKeys requires an array of keys"},63:{en:"NO INTENT MATCHED"},999:{en:""}}[t][e]}}],(r=[{key:"errorCode",get:function(){return this._errorCode}},{key:"errorMessage",get:function(){return this._errorMessage}}])&&zt(e.prototype,r),n&&zt(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Qt(t){return Qt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Qt(t)}function Jt(){Jt=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Qt(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Qt(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function $t(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Xt(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function Zt(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?Xt(Object(r),!0).forEach((function(e){var n,o,i;n=t,o=e,i=r[e],(o=ee(o))in n?Object.defineProperty(n,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[o]=i})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Xt(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function te(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,ee(n.key),n)}}function ee(t){var e=function(t,e){if("object"!==Qt(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Qt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===Qt(e)?e:String(e)}var re=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._debugMode=!1,this._command=[],this._runProfile=t.PROD(),this._performanceLogs=!1}var e,r,n,o,i;return e=t,r=[{key:"init",value:function(){this._=this._state._,this.R=this._state.R}},{key:"runProfile",get:function(){return this._runProfile},set:function(t){this._runProfile=t,this._state.client!==yt||this._state.location!==gt||this._state.v1Compatibility||this._state.context.devMode()}},{key:"callBotPublisher",value:function(t,e){var r=this,n={action:e,conversation:this._state.conversation,botMetadata:t,userId:this._state.user.userId};return this._state.callLambda("BotPublisher",n,"RequestResponse").then((function(t){var e=JSON.parse(t.Payload);return 0!==e.error&&(9===e.error?r._state.addSystemErrorToStack(9):(console.log("1. adding system error"),r._state.addSystemErrorToStack(7,e.error))),e.error}))}},{key:"publishBot",value:function(t){return this.callBotPublisher(t,"publishNewBot")}},{key:"updateBot",value:function(t){return this.callBotPublisher(t,"updateBot")}},{key:"deleteBotFromCatalogue",value:function(t){return this.callBotPublisher(t,"deleteBot")}},{key:"publishApp",value:function(t){return this.callBotPublisher(t,"publishNewBotInNewFormat")}},{key:"updateApp",value:function(t){return this.callBotPublisher(t,"updateBotInNewFormat")}},{key:"deleteAppFromCatalogue",value:function(t){return this.callBotPublisher(t,"deleteBotInNewFormat")}},{key:"setDebugActive",value:function(){this.log({message:"Activating debug mode"}),this._debugMode=!0}},{key:"validDeveloperDomains",value:function(){var t=this,e=[];return"frontmai"===this._state.conversation.userDomain?this._state._.each(this._state.userDomains,(function(r){t._state._.findIndex(r.roles,(function(t){return"developer"}))>-1&&e.push(r.domain)})):e.push(this._state.conversation.userDomain),e}},{key:"isDeveloperIntent",value:function(){return"string"==typeof this._state.messageFromUser&&"@@"===this._state.messageFromUser.substring(0,2)&&"@@run"!==this._state.messageFromUser.substring(0,5)}},{key:"identifyDeveloperIntent",value:function(){if("string"==typeof this._state.messageFromUser){var t=this._state.messageFromUser.toLowerCase();switch(t){case"@@reset conversation":return"_dev_reset_conversation";case"@@debug on":return"_dev_debug_switch_on";case"@@debug off":return"_dev_debug_switch_off";case"@@inspect all":return"_dev_inspect_all";case"@@inspect nlp":return"_dev_inspect_nlp";case"@@inspect history":return"_dev_inspect_history";case"@@inspect messages":return"_dev_inspect_messages";case"@@inspect old fields":return"_dev_inspect_old";default:if(this.R.includes("@@inspect state",t))return"_dev_inspect_state";if(this.R.includes("@@inspect",t))return"_dev_inspect"}}return null}},{key:"debug",value:function(e){var r=e.message,n=e.errorCode,o=e.data,i=e.more;this.runProfile===t.DEBUG()&&this.addEntryInES({level:jt.DEBUG(),message:r,errorCode:n,data:o,more:i})}},{key:"log",value:function(e){var r=e.message,n=e.errorCode,o=e.data,i=e.more;this.runProfile!==t.DEV()&&this.runProfile!==t.DEBUG()||this.addEntryInES({level:jt.LOG(),message:r,errorCode:n,data:o,more:i})}},{key:"info",value:function(e){var r=e.message,n=e.errorCode,o=e.data,i=e.more;this.runProfile===t.DEBUG()&&this.addEntryInES({level:jt.INFO(),message:r,errorCode:n,data:o,more:i})}},{key:"warning",value:function(t){var e=t.message,r=t.errorCode,n=t.data,o=t.more;this.addEntryInES({level:jt.WARNING(),message:e,errorCode:r,data:n,more:o})}},{key:"perf",value:function(e){var r=e.message,n=e.errorCode,o=e.data,i=e.more;this.runProfile!==t.DEBUG()&&this.runProfile!==t.PERF()||this.addEntryInES({level:jt.PERF(),message:r,errorCode:n,data:o,more:i})}},{key:"systemError",value:function(t){var e=t.message,r=t.errorCode,n=t.data,o=t.more;this.addEntryInES({level:jt.SYSTEM_ERROR(),message:e,errorCode:r,data:n,more:o})}},{key:"userError",value:function(t){var e=t.message,r=t.errorCode,n=t.data,o=t.more;this.addEntryInES({level:jt.USER_ERROR(),message:e,errorCode:r,data:n,more:o})}},{key:"addEntryInES",value:function(e){var r=e.level,n=e.errorCode,o=e.message,i=e.data,a=e.more;try{var s;""!==this._state.activeIntent&&(s=this._state.activeIntent);var c={type:"USER",entry:{userDomain:this._state.currentUserDomain,userId:this._state.user.userId,userEmail:this._state.user.userEmail,botId:this._state.conversation.bot,conversationId:this._state.conversationId,entity:"Micro-App",intent:s,client:this._state.client,location:this._state.location,timestamp:Date.now(),level:r,errorCode:n,message:o,data:i&&"string"!=typeof i?JSON.stringify(i):i}};if(a&&(c.entry=Zt(Zt({},c.entry),a)),this._state.sizeOfObject(JSON.stringify(c))>2e5)return void this.warning({message:Ht.getErrorMessageforCodeAndLang(50,"en"),data:o});if(this._state.location===bt||this._state.location===gt&&this._state.v1Compatibility)try{var u="Event";return this.runProfile===t.DEBUG()&&(u="RequestResponse"),this._state.frontmlib.invokeLambda("logger",u,c)}catch(t){this._state.context.log(c)}else c.data=c.entry.data,this._state.context.log(c)}catch(t){console.log(t)}}},{key:"processCommand",value:function(t){switch(t){case"_dev_reset_conversation":this.resetConversation();break;case"_dev_debug_switch_on":this.debugSwitch(!0);break;case"_dev_debug_switch_off":this.debugSwitch(!1);break;case"_dev_inspect":this.inspectField();break;case"_dev_inspect_all":this.inspectAllFields();break;case"_dev_inspect_nlp":this.inspectNLPFields();break;case"_dev_inspect_state":this.inspectStateField();break;case"_dev_inspect_history":this.inspectHistory();break;case"_dev_inspect_messages":return this.inspectMessages();case"_dev_inspect_old":return this.inspectOldFields()}}},{key:"inspectField",value:function(){var t=this.R.head(this.R.drop(1,this.R.split(" ")(this._state.messageFromUser)));if(t){var e=this.R.toString(this._.get(this._state.fields,t));if(e)return void this._state.addStringResponse(e)}this._state.addStringResponse("Could not find "+t)}},{key:"inspectAllFields",value:function(){var t=this.R.toString(this._state.fields);this._state.addStringResponse(t)}},{key:"inspectOldFields",value:function(){var t=this.R.toString(this._state._oldFields);this._state.addStringResponse(t)}},{key:"inspectNLPFields",value:function(){var t=this.R.toString(this._state._lastNLPResults);this._state.addStringResponse(t)}},{key:"inspectStateField",value:function(){this._state.addStringResponse(this._state.R.toString(this._state.getAllProperties()))}},{key:"inspectHistory",value:function(){this._state.addStringResponse(this._state.R.toString(this._state._intentHistory))}},{key:"inspectMessages",value:function(){this._state.addStringResponse(this._state.R.toString(this._state._inputHistory))}},{key:"debugSwitch",value:function(t){this._debugMode&&t?this._state.addStringResponse("Debug mode is already active"):this._debugMode===t?this._state.addStringResponse("Debug mode is already inactive"):(this._debugMode=t,this._debugMode?(this.log({message:"Debug mode set to active"}),this._state.addStringResponse("Debug mode activated")):(this.log({message:"Debug mode set to inactive"}),this._state.addStringResponse("Debug mode deactivated")))}},{key:"resetConversation",value:function(){console.log("Resetting conversation"),this._state._activeIntent="",this._state.requestIdsArray=[],this._state._intentHistory=[],this._state._intentStats={},this._state.lastGreetingTime=0,this._state.errorStack=[],this._state.fields={},this._state.sessionFields={},this._state.waitingCustomCap=0,this._state._currentSearchBox="",this._state._inSilence=!1,this._state._lastNLPResults={},this._state.clearSmartSuggestionsArray(),this._state.blockSuggestions=!0,this._state._silentIntent=!1,this._state.clearAutoSaveBuffer(),this._state.clearAutoSaveBufferChanges(),this._state.addStringResponse("The conversation has been reset"),this._state.sendMessage({intentId:"@@reset"})}},{key:"logCurrentEventDurationWithStartTime",value:function(t,e,r,n,o){try{if(this._performanceLogs){var i={event:t,startTime:e,duration:r-e};this.perf({message:n,more:i,data:o})}}catch(t){}}},{key:"generateTestCaseStep",value:function(t){var e=t.message,r={state:this._state.getAllProperties(),schedule:Date.now()};return r.state.messageTypeFromUser=e.type,r.state.messageFromUser=e.content,r.state.client=this._state.client,r.state.userName=this._state.userName,r.state.lang="en",r.state.waitingCustomCap=0,r.state.messageFromUser.page=0,r.state.unitTestMode=!0,r}},{key:"submitTest",value:(o=Jt().mark((function t(e){var r,n,o,i,a;return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.testCases,n=r[0],this._state.setField(Yt.TEST_CASES_FIELD(),r),this._state.setField(Yt.CURRENT_TEST_FIELD(),this._state.activeIntent),o=this.generateTestCaseStep({message:n}),i=this._state.getUniqueId(),t.next=8,this._state.jobScheduler.addNewJob(this._state.client,o,i,null);case 8:if((a=t.sent).jobId===i){t.next=13;break}this._state.addErrorToStack(1e3,"Problems submitting test case"),t.next=14;break;case 13:return t.abrupt("return",a.jobId);case 14:case"end":return t.stop()}}),t,this)})),i=function(){var t=this,e=arguments;return new Promise((function(r,n){var i=o.apply(t,e);function a(t){$t(i,r,n,a,s,"next",t)}function s(t){$t(i,r,n,a,s,"throw",t)}a(void 0)}))},function(t){return i.apply(this,arguments)})}],n=[{key:"DEBUG",value:function(){return"Debug"}},{key:"DEV",value:function(){return"Dev"}},{key:"PROD",value:function(){return"Prod"}},{key:"TEST",value:function(){return"Test"}},{key:"PERF",value:function(){return"Perf"}}],r&&te(e.prototype,r),n&&te(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function ne(t){return ne="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ne(t)}function oe(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==ne(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==ne(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===ne(o)?o:String(o)),n)}var o}var ie=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this.context=e.context,this.userId=e.user.userId,this.conversation=e.conversation,this.location=e.location}var e,r;return e=t,(r=[{key:"getBalance",value:function(t){var e=this.conversation,r={capability:"MessageQuotaCapability",capabilityFileName:"messageQuotaCapability",action:"getSpecificQuota",sync:!0,userId:this.userId,conversation:e,botId:t};return this._state.callCapability(r)}},{key:"storeBalance",value:function(t,e){var r=this.conversation,n={capability:"MessageQuotaCapability",capabilityFileName:"messageQuotaCapability",action:"incrementUserAssignedQuota",sync:!0,userId:this.userId,conversation:r,stats:{}};return n.stats[t]=e,this._state.callCapability(n)}},{key:"updateBalance",value:function(t,e){var r=this.conversation,n={capability:"MessageQuotaCapability",capabilityFileName:"messageQuotaCapability",action:"updateUserUsedQuota",sync:!0,userId:this.userId,conversation:r,stats:{}};return n.stats[t]=e,this._state.callCapability(n)}},{key:"resetBalance",value:function(t,e){var r=this.conversation,n={capability:"MessageQuotaCapability",capabilityFileName:"messageQuotaCapability",action:"setUserAssignedClearUsedQuota",sync:!0,userId:this.userId,conversation:r,stats:{}};return n.stats[t]=e,this._state.callCapability(n)}},{key:"getCallRates",value:function(t){try{var e=this.conversation,r=this.userId,n={capability:"VoipCapability",capabilityFileName:"voipCapability",action:"getCallTariffsForCountry",isoCountry:t,userDomains:this._state.userDomains,sync:!0,userId:r,conversation:e};return this._state.callCapability(n)}catch(t){this._state.addSystemErrorToStack(8,null,t.message)}}},{key:"getCallHistory",value:function(){try{var t={action:"getCallHistory",capability:"VoipCapability",capabilityFileName:"voipCapability",userId:this.userId,conversation:this.conversation,sync:!0,email:this._state.user.userEmail};return this._state.callCapability(t)}catch(t){this._state.addSystemErrorToStack(8,null,t.message)}}}])&&oe(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function ae(t){return ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ae(t)}function se(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==ae(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==ae(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===ae(o)?o:String(o)),n)}var o}var ce=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this.context=e.context,this.userId=e.user.userId,this.conversation=e.conversation,this.location=e.location,this._state.developer.log({message:"Initialising Orders"}),this._state.client===yt&&this.location===gt&&(this._state.client===yt?(this._state.developer.log({message:"Initialising InAppPurchases"}),this.inAppPurchaseCap=this.context.getCapability("InAppPurchase"),this.productTypes=this.inAppPurchaseCap.ProductTypes):(this.inAppPurchaseCap="false",this.productTypes=[]))}var e,r,n;return e=t,n=[{key:"PAYMENT_CODES",value:function(){return{TOP_UP_WALLET:"100",PURCHASE_PRODUCT:"101"}}},{key:"CURRENT_STRIPE_TRANSACTIONS",value:function(){return"currentStripeTransactions"}}],(r=[{key:"createNewStripeTransaction",value:function(e,r,n){var o=this._state.getField(t.CURRENT_STRIPE_TRANSACTIONS())||[],i=this._state.UUID();return o.push({transactionId:i,amount:e,currency:r,description:n}),this._state.setField(t.CURRENT_STRIPE_TRANSACTIONS(),o),i}},{key:"getStripeTransaction",value:function(e){var r=this._state.getField(t.CURRENT_STRIPE_TRANSACTIONS())||[],n=this._state._.findIndex(r,(function(t){return t.transactionId===e}));return-1===n?null:r[n]}},{key:"removeStripeTransaction",value:function(e){var r=this._state.getField(t.CURRENT_STRIPE_TRANSACTIONS())||[],n=this._state._.findIndex(r,(function(t){return t.transactionId===e}));this._state._.pullAt(r,[n]),this._state.setField(t.CURRENT_STRIPE_TRANSACTIONS(),r)}},{key:"inAppPurchase",value:function(t){if(this.location!==bt&&this._state.client!==vt)return this._state.developer.log({message:"About to buy product "+t+" of type "+this.productTypes.VOIP}),this.inAppPurchaseCap.buyProduct({productCode:t,productName:this.productTypes.VOIP});this._state.addSystemErrorToStack(13)}},{key:"processStripePayment",value:function(){var t=this._state.messageFromUser,e=t.transactionId,r=t.currency,n=t.amount;if(t.paymentSuccessful){var o=this.getStripeTransaction(e);if(null===o)return{error:"Invalid transaction id"};var i=o.transactionId,a=o.currency,s=o.amount;return i!==e?{error:"Invalid transaction id"}:s!==n?{error:"There is a discrepancy in amounts. Please report to the support team"}:a!==r?{error:"There is a discrepancy in currencies. Please report to the support team"}:(this.removeStripeTransaction(e),{error:0})}return this.removeStripeTransaction(e),{error:"Your stripe payment was not successful"}}}])&&se(e.prototype,r),n&&se(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function ue(t){return ue="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ue(t)}function le(){le=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==ue(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(ue(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function he(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function fe(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){he(i,n,o,a,s,"next",t)}function s(t){he(i,n,o,a,s,"throw",t)}a(void 0)}))}}function de(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==ue(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==ue(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===ue(o)?o:String(o)),n)}var o}var pe=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._,e.context.capabilities.capabilities?(this._context=e.context.capabilities,this._sftpClient=e.context.capabilities.ssh2SftpClient):(this._context=e.context,this._sftpClient=e.context.ssh2SftpClient)}var e,r,n,o,i,a,s;return e=t,r=[{key:"connect",value:(s=fe(le().mark((function t(e,r,n,o){var i;return le().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,i=new this._sftpClient,t.next=4,i.connect({host:e,port:r,username:n,password:o});case 4:return t.abrupt("return",i);case 7:throw t.prev=7,t.t0=t.catch(0),t.t0;case 10:case"end":return t.stop()}}),t,this,[[0,7]])}))),function(t,e,r,n){return s.apply(this,arguments)})},{key:"disconnect",value:(a=fe(le().mark((function t(e){return le().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.end();case 3:t.next=8;break;case 5:throw t.prev=5,t.t0=t.catch(0),t.t0;case 8:case"end":return t.stop()}}),t,null,[[0,5]])}))),function(t){return a.apply(this,arguments)})},{key:"getFilesList",value:(i=fe(le().mark((function t(e,r){return le().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.list(r);case 3:return t.abrupt("return",t.sent);case 6:throw t.prev=6,t.t0=t.catch(0),t.t0;case 9:case"end":return t.stop()}}),t,null,[[0,6]])}))),function(t,e){return i.apply(this,arguments)})},{key:"downloadFileToS3",value:(o=fe(le().mark((function t(e,r,n,o,i){var a,s,c,u;return le().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=this._.get(this._context,"capabilities.config"),s=this._.get(this._context,"capabilities.env"),a||(a=this._.get(this._context,"config"),s=this._.get(this._context,"env")),t.next=6,e.get("".concat(n,"/").concat(i));case 6:return c=t.sent,u={Bucket:a[s].CONVERSATIONS_BUCKET,Key:"".concat(o,"/").concat(i),Body:c},t.next=10,r.putObject(u).promise();case 10:t.next=15;break;case 12:throw t.prev=12,t.t0=t.catch(0),t.t0;case 15:case"end":return t.stop()}}),t,this,[[0,12]])}))),function(t,e,r,n,i){return o.apply(this,arguments)})},{key:"putFileToFTPServer",value:(n=fe(le().mark((function t(e,r,n){return le().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,this._state.developer,t.next=4,e.put(r,n);case 4:t.next=10;break;case 6:throw t.prev=6,t.t0=t.catch(0),D.systemError({message:"putFileToFTPServer:Error occurred while putting the file to the server",errorCode:t.t0.message,data:t.t0}),t.t0;case 10:case"end":return t.stop()}}),t,this,[[0,6]])}))),function(t,e,r){return n.apply(this,arguments)})}],r&&de(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function ye(t){return ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ye(t)}function ve(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,o,i,a,s=[],c=!0,u=!1;try{if(i=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=i.call(r)).done)&&(s.push(n.value),s.length!==e);c=!0);}catch(t){u=!0,o=t}finally{try{if(!c&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(u)throw o}}return s}}(t,e)||ge(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function me(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=ge(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw i}}}}function ge(t,e){if(t){if("string"==typeof t)return be(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?be(t,e):void 0}}function be(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function _e(){_e=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==ye(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(ye(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function we(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Se(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){we(i,n,o,a,s,"next",t)}function s(t){we(i,n,o,a,s,"throw",t)}a(void 0)}))}}function ke(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==ye(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==ye(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===ye(o)?o:String(o)),n)}var o}var Ee=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._,this._state.client===yt&&(this.notification=this._state.context.getCapability("Notification"))}var e,r,n,o,i,a,s,c,u,l;return e=t,r=[{key:"sendEmail",value:function(t,e,r,n,o,i){var a={capability:"SendEmailCustomCapability",capabilityFileName:"email",address:t,cc:i,fromEmail:o,htmlBody:r,title:e,sync:!0,userId:this._state.user.userId,conversation:this._state.conversation,attachments:[]},s=[];return n&&(this._.each(n,(function(t){var e={fileContentName:t.name};"csv"===t.type||"string"===t.type?e.stringContent=t.content:e.jsonContent=t.content,s.push(e)})),a.attachments=s),this._state.callCapability(a)}},{key:"sendIMMessage",value:function(){var t={messageId:this._state.messageIdFromUser,contentType:this._state.messageTypeIntFromUser,createdOn:this._state.messageCreatedOnFromUser,createdBy:this._state.user.userId,content:this._state.messageContentFromUser,options:this._state.messageOptionsFromUser},e={capability:"SendIMMessage",capabilityFileName:"sendIMMessage",sync:!0,userId:this._state.user.userId,conversation:this._state.conversation,messages:[t],isNewConversation:!1};return this._state.callCapability(e)}},{key:"sendVoipPushNotificationToUserDevices",value:(l=Se(_e().mark((function t(e,r,n,o,i){var a,s,c,u=this;return _e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=this._state._,this._state.developer,s=function(t){var e={aps:{alert:o,data:{videoSessionId:a.get(i,"videoSessionId"),botId:a.get(i,"botId"),userDomain:a.get(i,"userDomain"),userId:a.get(i,"userId"),videoControlId:a.get(i,"videoControlId"),video:a.get(i,"video"),mediasoupHost:a.get(i,"mediasoupHost"),codec:a.get(i,"codec"),iAmHost:a.get(i,"iAmHost"),startWithVideoMuted:a.get(i,"startWithVideoMuted"),preConnectCallCheck:a.get(i,"preConnectCallCheck"),uid:a.get(i,"uid"),ur:a.get(i,"ur"),callAction:a.get(i,"callAction"),conversationId:t,roomName:a.get(i,"roomName"),brand:a.get(i,"brand")},sound:a.get(i,"soundName","default")}},r={data:{message:o,conversationId:t,videoSessionId:a.get(i,"videoSessionId"),botId:a.get(i,"botId"),userDomain:a.get(i,"userDomain"),userId:a.get(i,"userId"),videoControlId:a.get(i,"videoControlId"),video:a.get(i,"video"),mediasoupHost:a.get(i,"mediasoupHost"),iAmHost:a.get(i,"iAmHost"),startWithVideoMuted:a.get(i,"startWithVideoMuted"),preConnectCallCheck:a.get(i,"preConnectCallCheck"),uid:a.get(i,"uid"),ur:a.get(i,"ur"),callAction:a.get(i,"callAction"),codec:a.get(i,"codec"),soundName:a.get(i,"soundName"),roomName:a.get(i,"roomName"),brand:a.get(i,"brand")},time_to_live:10,priority:"high"},n={default:o,GCM:JSON.stringify(r),APNS_VOIP:JSON.stringify(e),APNS_VOIP_SANDBOX:JSON.stringify(e)};return JSON.stringify(n)},c=function(t,e,r,n){var o={Message:s(t),MessageStructure:"json",MessageAttributes:{"AWS.SNS.MOBILE.APNS.TTL":{DataType:"String",StringValue:"10"},"AWS.SNS.MOBILE.APNS.PRIORITY":{DataType:"String",StringValue:"10"},"AWS.SNS.MOBILE.APNS.PUSH_TYPE":{DataType:"String",StringValue:"voip"}},TargetArn:n};return e.publish(o).promise()},a.forEach(e,(function(t){c(n,r,0,t).then((function(){u._state.developer.info({message:"Push notification sent with no error"})})).catch((function(e){return u._state.developer.warning({message:"Could not send push notification to a device",data:JSON.stringify(e)}),"error occurred while sending notification to :"+t}))}));case 5:case"end":return t.stop()}}),t,this)}))),function(t,e,r,n,o){return l.apply(this,arguments)})},{key:"sendVoipCallPushNotifications",value:(u=Se(_e().mark((function t(e,r,n,o,i,a){var s,c,u,l,h,f,d,p,y,v,m,g,b,_,w,S,k,E,x,I,T,O;return _e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:(s=this._state).R,c=s._,u=s.developer,l=new this._state.aws.SNS({apiVersion:"2010-03-31"}),h={},f=[],d=0;case 9:if(!(d<e.length)){t.next=32;break}p=e[d],y=c.get(p,"participants")||[],v=0;case 13:if(!(v<y.length)){t.next=29;break}if((m=y[v])===c.get(p,"bot")){t.next=26;break}return g="PUSH_NOTIFICATION_KEY_".concat(m),t.next=19,this._state.getSharedField(g);case 19:if(b=t.sent,!(Date.now()-c.get(b,"timeStamp",0)>1e4||a)){t.next=26;break}return t.next=23,this._state.setSharedField(g,{timeStamp:Date.now()},10);case 23:_="People_".concat(m),f.push(_),h[_]={conversationId:p.conversationId};case 26:v++,t.next=13;break;case 29:d++,t.next=9;break;case 32:if(!c.isEmpty(h)){t.next=34;break}return t.abrupt("return");case 34:return t.next=36,this._state.db.getMultipleValuesFromCache(f);case 36:return w=t.sent,S=[],t.next=40,this._state.getStaticData("webPushAppType");case 40:return k=t.sent,E=function(t){if(u.log({message:"webPushAppType",data:k}),k){var e={pushType:"WEB_PUSH",action:"SendNotification",webPushAppType:k,userId:c.get(t,"userId"),userEmail:c.get(t,"emailAddress"),message:{title:"FrontM Notifications",text:r}};return u.log({message:"params",data:e}),s.callLambda("PushNotificationHandler",e,"Event")}},x=[],c.forEach(w,(function(t,e){var r,n=JSON.parse(t.content),a=c.get(n,"voipDevices",[]),s=me(a.entries());try{var u=function(){var t=ve(r.value,2),e=t[0],n=t[1];c.findIndex(S,(function(t){return t===n}))>-1?a.splice(e,1):(o?n.includes("APN")&&a.splice(e,1):i&&n.includes("GCM")&&a.splice(e,1),S.push(n))};for(s.s();!(r=s.n()).done;)u()}catch(t){s.e(t)}finally{s.f()}c.size(a)>0?h[e].devices=a:delete h[e],x.push(E(n))})),t.next=46,Promise.all(x);case 46:I=0;case 47:if(!(I<c.keys(h).length)){t.next=56;break}return T=c.keys(h)[I],O=h[T],t.next=52,this.sendVoipPushNotificationToUserDevices(c.get(O,"devices"),l,c.get(O,"conversationId"),r,n);case 52:u.info({message:"Sent to device",data:O});case 53:I++,t.next=47;break;case 56:case"end":return t.stop()}}),t,this)}))),function(t,e,r,n,o,i){return u.apply(this,arguments)})},{key:"sendPushNotificationToUserDevices",value:(c=Se(_e().mark((function t(e,r,n,o,i){var a,s,c,u=this;return _e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=this._state._,s=function(t){var e={aps:{alert:o,sound:a.get(i,"soundName","default")},videoSessionId:a.get(i,"videoSessionId"),botId:a.get(i,"botId"),userDomain:a.get(i,"userDomain"),userId:a.get(i,"userId"),videoControlId:a.get(i,"videoControlId"),video:a.get(i,"video"),conversationId:t},r={collapse_key:"FrontM messages",notification:{title:o,conversationId:t,botId:a.get(i,"botId"),userDomain:a.get(i,"userDomain"),userId:a.get(i,"userId"),soundName:a.get(i,"soundName")},data:{message:o,conversationId:t,videoSessionId:a.get(i,"videoSessionId"),botId:a.get(i,"botId"),userDomain:a.get(i,"userDomain"),userId:a.get(i,"userId"),videoControlId:a.get(i,"videoControlId"),video:a.get(i,"video"),soundName:a.get(i,"soundName")}},n={default:o,GCM:JSON.stringify(r),APNS:JSON.stringify(e),APNS_SANDBOX:JSON.stringify(e)};return JSON.stringify(n)},c=function(t,e,r,n){var o={Message:s(t),MessageStructure:"json",Subject:"New Message",TargetArn:n};return e.publish(o).promise()},a.forEach(e,(function(t){c(n,r,0,t).then((function(){u._state.developer.info({message:"Push notification sent with no error"})})).catch((function(e){return u._state.developer.warning({message:"Could not send push notification to a device",data:JSON.stringify(e)}),"error occurred while sending notification to :"+t}))}));case 4:case"end":return t.stop()}}),t,this)}))),function(t,e,r,n,o){return c.apply(this,arguments)})},{key:"sendPushNotifications",value:(s=Se(_e().mark((function t(e,r,n){var o,i,a,s,c,u,l,h=this;return _e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._state.R,o=this._state._,(i=this._state.developer).debug({message:"Sending push",data:{conversations:e,message:r,data:n}}),a=new this._state.aws.SNS({apiVersion:"2010-03-31"}),s=[],c={},u=[],o.forEach(e,(function(t){o.forEach(o.get(t,"participants"),(function(e){if(e!==o.get(t,"bot")){var r="People_".concat(e);u.push(r),c[r]={conversationId:t.conversationId}}}))})),!(u.length>0)){t.next=17;break}return t.next=12,this._state.db.getMultipleValuesFromCache(u);case 12:l=t.sent,o.forEach(l,(function(t,e){var r=JSON.parse(t.content);c[e].devices=s.concat(o.get(r,"devices",[]))})),o.forEach(c,(function(t){h.sendPushNotificationToUserDevices(o.get(t,"devices"),a,o.get(t,"conversationId"),r,n).then((function(){}))})),t.next=18;break;case 17:i.warning({message:"No participants within the conversation"});case 18:case"end":return t.stop()}}),t,this)}))),function(t,e,r){return s.apply(this,arguments)})},{key:"ringParticipantsInConversationList",value:(a=Se(_e().mark((function t(e,r,n){var o,i,a,s,c,u,l;return _e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:o=this._state._,this._state.developer,i=0;case 3:if(!(i<e.length)){t.next=20;break}a=e[i],s=o.get(a,"conversationId"),c=o.get(a,"participants"),u=0;case 8:if(!(u<c.length)){t.next=17;break}if(l=c[u],n.conversationId=s,l===this._state.user.userId){t.next=14;break}return t.next=14,this.sendVoipPushNotifications(l,r,n);case 14:u++,t.next=8;break;case 17:i++,t.next=3;break;case 20:case"end":return t.stop()}}),t,this)}))),function(t,e,r){return a.apply(this,arguments)})},{key:"sendVoipPushNotifications",value:(i=Se(_e().mark((function t(e,r,n){var o,i,a,s,c,u,l,h,f=this;return _e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this._state.R,o=this._state._,i=this._state.developer,t.prev=3,a=function(t,e){var r={aps:{alert:t,data:e}},n={notification:{title:t,body:e.message,sound:"incallmanager_ringback.mp3",android_channel_id:"500"},data:e,priority:"high"},o={APNS_VOIP_SANDBOX:JSON.stringify(r),APNS_VOIP:JSON.stringify(r),GCM:JSON.stringify(n)};return JSON.stringify(o)},s=function(t,e,r,n){var o={Message:a(t,e),MessageStructure:"json",MessageAttributes:{"AWS.SNS.MOBILE.APNS.PRIORITY":{DataType:"String",StringValue:"10"},"AWS.SNS.MOBILE.APNS.PUSH_TYPE":{DataType:"String",StringValue:"voip"}},TargetArn:r};return n.publish(o).promise()},c=this._state.frontmlib,t.next=9,c.dbGetWithKey("People",{userId:e});case 9:u=t.sent,l=o.get(u,"Item.voipDevices",[]),h=new this._state.aws.SNS({apiVersion:"2010-03-31"}),o.forEach(l,(function(t){s(r,n,t,h).then((function(){f._state.developer.info({message:"Voip Push notification sent with no error: ".concat(t)})})).catch((function(e){f._state.developer.warning({message:"Could not send voip push notification to a device to: ".concat(t),data:JSON.stringify(e)})}))})),t.next=18;break;case 15:t.prev=15,t.t0=t.catch(3),i.warning({message:"Fail voip push",data:t.t0.message});case 18:case"end":return t.stop()}}),t,this,[[3,15]])}))),function(t,e,r){return i.apply(this,arguments)})},{key:"endCall",value:function(t){var e=t.receiverUserId,r=t.videoSessionId,n=t.video,o={capability:"VoipCapability",capabilityFileName:"voipCapability",action:"sendVoipPushNotification",callAction:"CallEnd",callerUserId:this._state.user.userId,receiverUserId:e,videoSessionId:r,video:n};return this._state.callCapability(o)}},{key:"ringMultipleUsers",value:(o=Se(_e().mark((function t(e,r,n){var o,i;return _e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this._state._,this._state.developer,this._state.user.userId,o=0;case 5:if(!(o<e.length)){t.next=12;break}return i=e[o],t.next=9,this.sendVoipCallPushNotifications(i,r,n);case 9:o++,t.next=5;break;case 12:case"end":return t.stop()}}),t,this)}))),function(t,e,r){return o.apply(this,arguments)})},{key:"ringSingleUser",value:function(t,e,r){this._state._,this._state.developer;var n={capability:"VoipCapability",capabilityFileName:"voipCapability",action:"sendVoipPushNotification",callAction:"CallStart",callerUserId:this._state.user.userId,receiverUserId:t,videoSessionId:r.videoSessionId,video:r.video||!1,alertMessage:e};return this._state.callCapability(n)}},{key:"handleCallConnected",value:function(t){var e={capability:"VoipCapability",capabilityFileName:"voipCapability",action:"handleMultiUserCalls",callAction:"CallConnected",callerUserId:t.callerUserId,receiverUserId:t.receiverUserId};return this._state.callCapability(e)}},{key:"inviteUsers",value:function(t){var e={capability:"InviteUsers",capabilityFileName:"userInvitation",emailIds:t,sync:!0,userId:this._state.user.userId,conversation:this._state.conversation},r=this._state.context.capabilities.capabilities[e.capabilityFileName];return r?r.execute(e,this._state.context.capabilities):this._state.callLambda("EmailLambda",e,"RequestResponse").then((function(t){return JSON.parse(t.Payload)}))}},{key:"isDeviceRegisteredForPush",value:function(){var t=this;return this.notification.deviceInfo().then((function(e){return!t._state._.isEmpty(e)&&e.isRegistered}))}},{key:"registerDeviceForPushOnEdge",value:function(){this._state.client===yt&&this.notification.requestPermission()}},{key:"deregisterDeviceForPushOnEdge",value:function(){var t=this;if(this._state.client===yt)return this.notification.deregister().then((function(t){return t})).catch((function(e){t._state.addSystemErrorToStack(19,JSON.stringify(e))}));this._state.addSystemErrorToStack(18)}},{key:"registerDeviceForPushOnBackend",value:function(t){try{var e=this._state.conversation,r=this._state.user.userId,n={capability:"RegisterDevice",capabilityFileName:"deviceRegistration",deviceToken:t.deviceId,deviceType:t.deviceType,sync:!0,userId:r,conversation:e};return this._state.callCapability(n)}catch(t){this._state.addSystemErrorToStack(16,null,t.message)}}},{key:"deregisterDeviceForPushOnBackend",value:function(t){try{var e=this._state.conversation,r=this._state.user.userId,n={capability:"DeregisterDevice",capabilityFileName:"deviceRegistration",deviceToken:t.deviceId,deviceType:t.deviceType,sync:!0,userId:r,conversation:e};return this._state.callCapability(n)}catch(t){this._state.addSystemErrorToStack(16,null,t.message)}}},{key:"sendDelayedNotification",value:function(t){return this._state.callCapability(t)}},{key:"generateFullMessageForMessage",value:function(t,e,r,n,o){var i=this._state._,a=this._state.developer,s=this._state.getUniqueId(),c=t;if(!n){var u=i.get(e,"bot")===this._state.botId?this._state.stateToBackEnd():{state:{}};u.state.messageFromUser=t,u.state.messageTypeFromUser="object",u.state.fromGreeting=!1,u.state.responsesArray=[],u.state._syncToCloud={},u.state._syncToEdge={},u.state._activeIntent="",u.state.responseToClient=vt,!n&&o&&(u.state.v1Compatibility=!0),c=u}var l=this._state.sizeOfObject(JSON.stringify(c));return l>=2e5&&a.log({message:"********** Danger danger danger!! Your PARAMS is too big!! **********",data:l}),{content:[c],contentType:r,requestUuid:s,createdBy:this._state.user.userId,createdOn:Date.now(),messageId:this._state.getUniqueId()}}},{key:"sendNotification",value:function(t,e,r,n,o){var i=this;try{var a=this._state._,s=[];Array.isArray(r)?a.forEach(r,(function(r){s.push(i.generateFullMessageForMessage(r,t,e,n,o))})):s.push(this.generateFullMessageForMessage(r,t,e,n,o));var c=this._state.getUniqueId(),u={target:t,capability:"BroadCastMessageCapability",capabilityFileName:"broadCastMessage",action:"get",bot:this._state.conversation.bot||a.get(this._state.context,"botManifest.botId"),userDomain:this._state.conversation.userDomain,requestUuid:c,sync:!0,email:this._state.user.userEmail,conversation:this._state.conversation,realTimeMessage:n,messages:s};return this._state.online().then((function(t){return t?i._state.callLambda("CapabilityExecutorLambda",u,"Event"):(i._state.addDelayedNotification(u),Promise.resolve())}))}catch(t){this._state.addSystemErrorToStack(16,null,t.message)}}},{key:"sendMessageToUserInBot",value:function(t,e,r,n,o,i,a,s){var c=this,u=this._state._,l=this._state.developer;r&&!u.isEmpty(r)||l.warning({message:"The userIds array is empty. This request acts as a broadcast and could duplicate messages"});var h={bot:n||this._state.botId,userDomain:o||this._state.currentUserDomain,users:r};if(l.debug({message:"Sending bot to bot to",data:h}),l.debug({message:"Sending bot to bot with message",data:e}),!a)return this.sendNotification(h,t,e,i,s);setTimeout((function(){return c.sendNotification(h,t,e,i,s)}),a)}},{key:"sendQueueMessageToUserInBot",value:(n=Se(_e().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d,p,y,v,m,g=this;return _e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.type,n=e.message,o=e.userIds,i=e.botId,a=e.userDomain,s=e.realTimeMessage,c=void 0!==s&&s,u=e.queue,l=this._state._,h=this._state.developer,u){t.next=6;break}return h.systemError({message:"Missing queue url, not sending the message"}),t.abrupt("return");case 6:o&&!l.isEmpty(o)||h.warning({message:"The userIds array is empty. This request acts as a broadcast and could duplicate messages"}),f={bot:i||this._state.botId,userDomain:a||this._state.currentUserDomain,users:o},Array.isArray(n)||(n=[n]),d=l.map(n,(function(t){return g.generateFullMessageForMessage(t,f,r,c,!1)})),p={target:f,botId:this._state.conversation.bot||l.get(this._state.context,"botManifest.botId"),userDomain:this._state.conversation.userDomain,email:this._state.user.userEmail,conversation:this._state.conversation,realTimeMessage:c},y=me(d),t.prev=12,y.s();case 14:if((v=y.n()).done){t.next=21;break}return m=v.value,p.messages=[m],t.next=19,this._state.sendMessageToQueue(u,p);case 19:t.next=14;break;case 21:t.next=26;break;case 23:t.prev=23,t.t0=t.catch(12),y.e(t.t0);case 26:return t.prev=26,y.f(),t.finish(26);case 29:case"end":return t.stop()}}),t,this,[[12,23,26,29]])}))),function(t){return n.apply(this,arguments)})},{key:"sendBroadcastNotificationToBot",value:function(t,e,r,n,o,i,a){var s=this,c={bot:t||this._state.botId,userDomain:e||this._state.currentUserDomain};if(!i)return this.sendNotification(c,r,n,o,a);setTimeout((function(){return s.sendNotification(c,r,n,o,a)}),i)}}],r&&ke(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function xe(t){return xe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},xe(t)}function Ie(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==xe(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==xe(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===xe(o)?o:String(o)),n)}var o}var Te=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._}var e,r;return e=t,(r=[{key:"validateActivationCode",value:function(t,e,r){var n={capability:"SubscribeDomainRole",capabilityFileName:"subscribeDomainRole",verificationCode:t,sync:!0,userId:e||this._state.user.userId,userEmail:r||this._state.user.userEmail,conversation:this._state.conversation};return this._state.callCapability(n)}},{key:"activateDomainsOnEdge",value:function(t){return this._state.context.getCapability("authContext").setDomains(t,this._state.context)}},{key:"autoInstallAllBotsOnEdge",value:function(){return this._state.context.getCapability("RemoteBotInstall").syncronizeBots()}}])&&Ie(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Oe(t){return Oe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Oe(t)}function Ce(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Oe(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Oe(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Oe(o)?o:String(o)),n)}var o}var Le=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}var e,r;return e=t,r=[{key:"MESSAGE_TYPE_STRING",value:function(){return 10}},{key:"MESSAGE_TYPE_IMAGE",value:function(){return 30}},{key:"MESSAGE_TYPE_VIDEO",value:function(){return 40}},{key:"MESSAGE_TYPE_AUDIO",value:function(){return 60}},{key:"MESSAGE_TYPE_HTML",value:function(){return 140}},{key:"BACKEND_RESPONSE",value:function(){return 150}},{key:"BOT_TO_BOT",value:function(){return 160}},{key:"SOCKET_RECONNECTION",value:function(){return 170}},{key:"MESSAGE_TYPE_LIST",value:function(){return 200}},{key:"MESSAGE_TYPE_SLIDER",value:function(){return 210}},{key:"MESSAGE_TYPE_BUTTON",value:function(){return 220}},{key:"MESSAGE_TYPE_FORM",value:function(){return 230}},{key:"MESSAGE_TYPE_MAP",value:function(){return 240}},{key:"MESSAGE_TYPE_SMART_SUGGESTIONS",value:function(){return 250}},{key:"MESSAGE_TYPE_WEB_CARD",value:function(){return 260}},{key:"MESSAGE_TYPE_STD_NOTIFICATION",value:function(){return 270}},{key:"MESSAGE_TYPE_CRITICAL_NOTIFICATION",value:function(){return 280}},{key:"MESSAGE_TYPE_LOCATION",value:function(){return 290}},{key:"MESSAGE_TYPE_PDF",value:function(){return 300}},{key:"MESSAGE_TYPE_TEXT",value:function(){return 320}},{key:"MESSAGE_TYPE_OTHER_FILE",value:function(){return 330}},{key:"MESSAGE_TYPE_CSV",value:function(){return 340}},{key:"MESSAGE_TYPE_JAVASCRIPT",value:function(){return 350}},{key:"MESSAGE_TYPE_FORM2",value:function(){return 400}},{key:"MESSAGE_TYPE_MENU",value:function(){return 410}},{key:"MESSAGE_TYPE_TABLE",value:function(){return 420}},{key:"MESSAGE_TYPE_CONTACT_CARD",value:function(){return 430}},{key:"MESSAGE_TYPE_DATA_CARD",value:function(){return 440}},{key:"MESSAGE_TYPE_FORM_RESPONSE",value:function(){return 450}},{key:"MESSAGE_TYPE_STRIPE",value:function(){return 460}},{key:"MESSAGE_TYPE_STRIPE_RESPONSE",value:function(){return 470}},{key:"MESSAGE_TYPE_CLOSE_FORM",value:function(){return 480}},{key:"MESSAGE_TYPE_MAP_RESPONSE",value:function(){return 490}},{key:"MESSAGE_TYPE_SEARCH_BOX",value:function(){return 510}},{key:"MESSAGE_TYPE_SEARCH_BOX_RESPONSE",value:function(){return 520}},{key:"MESSAGE_TYPE_CARDS",value:function(){return 530}},{key:"MESSAGE_TYPE_CARD_ACTION",value:function(){return 540}},{key:"MESSAGE_RUN_MODE",value:function(){return 550}},{key:"SHORT_TABLE_RESPONSE",value:function(){return 1e3}},{key:"SHORT_CONTAINER_RESPONSE",value:function(){return 1100}},{key:"MESSAGE_VOICE_CALL",value:function(){return 1200}},{key:"SHORT_FORM_RESPONSE",value:function(){return 1300}},{key:"MESSAGE_TYPE_TIMELINE_LIST",value:function(){return 2e3}},{key:"MESSAGE_TYPE_TIMELINE_POST",value:function(){return 2100}},{key:"MESSAGE_TYPE_AICC",value:function(){return 2500}},{key:"MESSAGE_TYPE_AICC_STRING",value:function(){return"aiccPlayer"}},{key:"MESSAGE_TYPE_SURVEY",value:function(){return 3e3}},{key:"MESSAGE_TYPE_SURVEY_RESPONSE",value:function(){return 3001}},{key:"DASHBOARD",value:function(){return 5e3}}],null&&Ce(e.prototype,null),r&&Ce(e,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Pe(t){return Pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Pe(t)}function De(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Pe(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Pe(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Pe(o)?o:String(o)),n)}var o}var Fe=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._}var e,r;return e=t,(r=[{key:"addNewJob",value:function(t,e,r,n){var o={jobId:r,capability:"ScheduleBatchJob",conversation:this._state.conversation,params:this._state.cleanFieldsForSave(e),repeats:n,requestUuid:this._state.getUniqueId(),scheduledCapability:this._state.conversation.bot+"_CustomCap",userEmail:this._state.user.userEmail,userId:this._state.user.userId,userDomain:this._state.conversation.userDomain,botId:this._state.conversation.bot,client:t,schedule:this._.get(e,"schedule")};return this._state.callLambda("SystemCapabilities",o,"RequestResponse").then((function(t){return JSON.parse(t.Payload)}))}},{key:"scheduleMessage",value:function(t){var e=this,r=t.toBot,n=void 0===r?this._state.conversation.bot:r,o=t.toUser,i=t.messages,a=t.jobId,s=void 0===a?this._state.getUniqueId():a,c=t.schedule,u=void 0===c?Date.now():c,l=t.repeats,h=t.client,f=void 0===h?vt:h,d=t.realTimeMessage,p=void 0===d||d,y=t.v1Compatibility,v=void 0!==y&&y,m=this._state.getUniqueId(),g=function(t){var r=t;if(!p){var o=n===e._state.botId?e._state.stateToBackEnd():{state:{}};o.state.messageFromUser=t,o.state.messageTypeFromUser="object",o.state.fromGreeting=!1,o.state.responsesArray=[],o.state._syncToCloud={},o.state._syncToEdge={},o.state._activeIntent="",!p&&v&&(o.state.v1Compatibility=!0),r=o}return{content:[r],contentType:Le.BOT_TO_BOT(),requestUuid:m,createdBy:e._state.user.userId,createdOn:Date.now(),messageId:e._state.getUniqueId()}},b=this._state._,_=[];Array.isArray(i)?b.forEach(i,(function(t){_.push(g(t))})):_.push(g(i));var w={target:{bot:n,users:Array.isArray(o)?o:o?[o]:o,userDomain:this._state.currentUserDomain},action:"get",bot:this._state.conversation.bot||b.get(this._state.context,"botManifest.botId"),sync:!0,userDomain:this._state.conversation.userDomain,email:this._state.user.userEmail,conversation:this._state.conversation,requestUuid:m,messages:_,realTimeMessage:p},S={jobId:s,capability:"ScheduleBatchJob",conversation:this._state.conversation,params:w,repeats:l,requestUuid:m,scheduledCapability:"BroadCastMessageCapability",userEmail:this._state.user.userEmail,userId:this._state.user.userId,userDomain:this._state.conversation.userDomain,botId:this._state.conversation.bot,client:f,schedule:u};return this._state.callLambda("SystemCapabilities",S,"RequestResponse").then((function(t){return JSON.parse(t.Payload)}))}},{key:"deleteJob",value:function(t){var e={jobId:t,capability:"DeleteBatchJob"};return this._state.callLambda("SystemCapabilities",e,"RequestResponse")}},{key:"scheduleLocalJob",value:function(t,e){var r={key:t,botId:this._state.context.botManifest.botId,timeInterval:e,conversationId:this._state.conversationId};return this._state.context.getCapability("BackgroundTaskQueue").enqueue(r)}},{key:"stopLocalJob",value:function(t){var e=this._state.context.getCapability("BackgroundTaskQueue"),r={key:t,botId:this._state.context.botManifest.botId,conversationId:this._state.conversationId};return e.dequeue(r)}}])&&De(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Ae(t){return Ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ae(t)}function Re(){Re=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Ae(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Ae(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Ne(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function je(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Ae(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Ae(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Ae(o)?o:String(o)),n)}var o}var Me=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._,this._state.client===yt&&(this.contactCapability=this._state.context.getCapability("Contact"))}var e,r,n,o;return e=t,r=[{key:"refreshContactsOnEdge",value:function(){this._state.client===yt?this.contactCapability.refreshContacts():this._state.addSystemErrorToStack(18)}},{key:"getAllContactsFromEdge",value:function(){return this.contactCapability.getAddedContacts().then((function(t){return t}))}},{key:"getAllContactsFromBackend",value:function(){var t={capability:"GetContacts",capabilityFileName:"contactsListCapability",userDomain:this._state.conversation.userDomain,sync:!0,userId:this._state.user.userId,conversation:this._state.conversation};return this._state.callCapability(t)}},{key:"syncContacts",value:(n=Re().mark((function t(e,r){var n,o,i;return Re().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n={userId:r||this._state.user.userId,usersToSync:e},t.prev=1,o=this._state.frontmlib,t.next=5,o.invokeLambda("SyncContacts","RequestResponse",n);case 5:return i=t.sent,t.abrupt("return",i);case 9:t.prev=9,t.t0=t.catch(1),this._state.addSystemErrorToStack(7,"Error in sync contacts");case 12:case"end":return t.stop()}}),t,this,[[1,9]])})),o=function(){var t=this,e=arguments;return new Promise((function(r,o){var i=n.apply(t,e);function a(t){Ne(i,r,o,a,s,"next",t)}function s(t){Ne(i,r,o,a,s,"throw",t)}a(void 0)}))},function(t,e){return o.apply(this,arguments)})}],r&&je(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Ue(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function Be(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?Ue(Object(r),!0).forEach((function(e){var n,o,i;n=t,o=e,i=r[e],(o=We(o))in n?Object.defineProperty(n,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[o]=i})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Ue(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function Ge(t){return Ge="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ge(t)}function qe(){qe=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Ge(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Ge(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Ve(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Ke(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Ve(i,n,o,a,s,"next",t)}function s(t){Ve(i,n,o,a,s,"throw",t)}a(void 0)}))}}function Ye(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,We(n.key),n)}}function We(t){var e=function(t,e){if("object"!==Ge(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Ge(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===Ge(e)?e:String(e)}var ze=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._}var e,r,n,o,i,a,s,c;return e=t,r=[{key:"loadServicesForMyDomains",value:function(){var t=[{operand:"userDomain",value:this._state.currentUserDomain,operator:"eq"}];return this._state.db.getData("APIParameters",t)}},{key:"createNewService",value:(c=Ke(qe().mark((function t(e){var r;return qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=3,this._state.db.writeData("APIParameters",e);case 3:r=t.sent,this._.get(r,"errorMessage")&&this._state.addSystemErrorToStack(36);case 5:case"end":return t.stop()}}),t,this)}))),function(t){return c.apply(this,arguments)})},{key:"callService",value:function(t,e){var r=this,n={capability:"GetDataFromAPI",capabilityFileName:"getDataFromApi",userDomain:this._state.conversation.userDomain,serviceName:t,queryParams:this._.get(e,"queryParams"),pathParams:this._.get(e,"pathParams"),header:this._.get(e,"header"),body:this._.get(e,"body"),sync:!0,userId:this._state.user.userId,conversation:this._state.conversation};try{return this._state.callCapability(n).then((function(t){return r._state.developer.info({message:"Returned from service successfully",data:r._state.R.toString(t)}),r._.get(t,"error")&&r._state.addSystemErrorToStack(37,t.error,t),t})).catch((function(t){return r._state.addSystemErrorToStack(37,t.message,n),t}))}catch(t){this._state.addSystemErrorToStack(37,t.message,n)}}},{key:"createUser",value:function(t,e,r){var n=this,o={users:t,domain:this._state.currentUserDomain,delayRequired:void 0===Ge(r)||r,emailTemplateName:e},i="RequestResponse";return"payload"===this._state.messageTypeFromUser&&(i="Event"),this._state.callLambda("CreateUserLambda",o,i).then((function(t){n._state.developer.info({message:"Returned from service create user",data:t});var e=JSON.parse(n._state._.get(t,"Payload"));return n._.get(e,"error")&&n._state.addSystemErrorToStack(7,e.error),e})).catch((function(t){return n._state.addSystemErrorToStack(7,t.message),n._state.developer.log({message:"Returned with error",data:t}),t}))}},{key:"userExistenceCheck",value:(s=Ke(qe().mark((function t(e){var r,n,o,i,a;return qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.loginUserName,n=e.emailAddress,o=e.appType,t.prev=1,i={capability:"CheckUserExists",capabilityFileName:"checkUserExists",appType:o,loginUserName:r,emailAddress:n},t.next=5,this._state.callCapability(i);case 5:return a=t.sent,this._state.developer.info({message:"Returned from service create user",data:a}),t.abrupt("return",a);case 10:return t.prev=10,t.t0=t.catch(1),this._state.addSystemErrorToStack(7,t.t0.message),this._state.developer.log({message:"Returned with error",data:t.t0}),t.abrupt("return",t.t0);case 15:case"end":return t.stop()}}),t,this,[[1,10]])}))),function(t){return s.apply(this,arguments)})},{key:"deleteUser",value:(a=Ke(qe().mark((function t(e){var r,n=this;return qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r={capability:"DeleteUser",capabilityFileName:"deleteUser",appType:this._state.currentUserDomain},!Array.isArray(e)){t.next=4;break}return 1===e.length?(r.action="deleteUser",r.userId=e[0]):(r.action="deleteMultipleUsers",r.userIdsToDelete=e),t.abrupt("return",this._state.callCapability(r).then((function(t){return n._state.developer.info({message:"DeleteUser response",data:t}),n._.get(t,"error")&&n._state.addSystemErrorToStack(7,t.error),t})).catch((function(t){return n._state.addSystemErrorToStack(7,t.message),n._state.developer.log({message:"DeleteUser Returned with error",data:t}),t})));case 4:return t.abrupt("return",!1);case 5:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"authenticateUser",value:(i=Ke(qe().mark((function t(e){var r,n,o,i,a,s,c=this;return qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.appType,n=void 0===r?"frontmai":r,o=e.userEmail,i=e.password,a=e.otpToken,s={capability:"AuthCapability",capabilityFileName:"authCapability",appType:n,userEmail:o,password:i,action:"AuthenticateUser",otpToken:a},t.abrupt("return",this._state.callCapability(s).then((function(t){return c._.get(t,"success")})).catch((function(t){return c._state.developer.log({message:"Authenticate user returned with error",data:t}),c._.get(t,"success")})));case 3:case"end":return t.stop()}}),t,this)}))),function(t){return i.apply(this,arguments)})},{key:"encodeFile",value:(o=Ke(qe().mark((function t(e){var r;return qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r={capability:"ConversationFilesCapability",capabilityFileName:"conversationFilesCapability",targetConversationId:this._state.conversationId,targetFileName:e,conversation:this._state.conversation,sync:!0,email:this._state.user.userEmail,userId:this._state.user.userId},t.next=3,this._state.callCapability(r);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(t){return o.apply(this,arguments)})},{key:"sendResponse",value:(n=Ke(qe().mark((function t(e){var r,n,o,i;return qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=e.code,n=void 0===r?200:r,o=e.response,i=Be({code:n},void 0===o?{}:o),this._state.apiResponse=!0,this._state.addResponse("payload_response",i);case 4:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})}],r&&Ye(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function He(t){return He="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},He(t)}function Qe(){Qe=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==He(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(He(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Je(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function $e(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Je(i,n,o,a,s,"next",t)}function s(t){Je(i,n,o,a,s,"throw",t)}a(void 0)}))}}function Xe(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==He(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==He(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===He(o)?o:String(o)),n)}var o}var Ze=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._}var e,r,n,o,i,s,c,u,l,h,f,d,y,v,m,_,k;return e=t,r=[{key:"checkMongoResponse",value:(k=$e(Qe().mark((function t(e,r,n,o,i,a,s){var c,u,l,h,f;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._state.developer,c=e.Payload,500!==(u=c?JSON.parse(c):{statusCode:200}).statusCode){t.next=7;break}this._state.addSystemErrorToStack(7,"Error in database with error "+e.Payload),t.next=12;break;case 7:return l=r.document,r.query&&(h=this._state._,l=h.merge(l,r.query)),t.next=11,this.writeAuditIndex(r.collection,l,o,a,s);case 11:n&&(("success"===(f=u.body)&&r.document||Array.isArray(f)&&f.length>0&&i)&&"success"===f&&(u.body=[r.document]),this._state.addObjectToSyncMessage(r.collection,JSON.stringify(r),u));case 12:return t.abrupt("return",u);case 13:case"end":return t.stop()}}),t,this)}))),function(t,e,r,n,o,i,a){return k.apply(this,arguments)})},{key:"countDataFromCollection",value:(_=$e(Qe().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.collection,n=e.query,o=void 0===n?{}:n,i=e.projection,a=void 0===i?{}:i,s=e.collation,c=e.system,u={action:"count",db:void 0!==c&&c?ft:this._state.currentUserDomain,collection:r,query:o,projection:a,collation:s,userId:this._state.user.userId},t.t0=this._state.location===bt||this._state.client===vt,t.t0){t.next=7;break}return t.next=6,this._state.online();case 6:t.t0=t.sent;case 7:if(!t.t0){t.next=19;break}return l=this._state.frontmlib,t.next=11,l.invokeLambda("MongoDBManager","RequestResponse",u);case 11:if(h=t.sent,f=h.Payload,500!==(d=JSON.parse(f)).statusCode){t.next=18;break}this._state.addSystemErrorToStack(7,"Error in database with error "+h.Payload),t.next=19;break;case 18:return t.abrupt("return",d);case 19:case"end":return t.stop()}}),t,this)}))),function(t){return _.apply(this,arguments)})},{key:"getDataFromCollection",value:(m=$e(Qe().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d,p,y,v,m,g,b,_,w,k,E,x,I,T,O,C,L;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.collection,n=e.action,o=void 0===n?"query":n,i=e.query,a=void 0===i?{}:i,s=e.projection,c=void 0===s?{}:s,u=e.sort,l=void 0===u?{}:u,h=e.skip,f=void 0===h?0:h,d=e.limit,p=void 0===d?20:d,y=e.collation,v=e.expectOneResult,m=void 0!==v&&v,g=e.cache,b=void 0===g||g,_=e.system,w=void 0!==_&&_,k=e.local,E=void 0!==k&&k,x=e.securedFields,t.prev=1,I={action:o,db:w?ft:this._state.currentUserDomain,collection:r,query:a,projection:c,sort:l,skip:f,limit:p,collation:y,userId:this._state.user.userId,securedFields:x},t.t1=this._state.location===bt||this._state.client===vt,t.t1){t.next=8;break}return t.next=7,this._state.online();case 7:t.t1=t.sent;case 8:if(t.t0=t.t1,!t.t0){t.next=11;break}t.t0=!E;case 11:if(!t.t0){t.next=19;break}return T=this._state.frontmlib,t.next=15,T.invokeLambda("MongoDBManager","RequestResponse",I);case 15:return O=t.sent,t.abrupt("return",this.checkMongoResponse(O,I,b,!1,m,S));case 19:if(C=this._state.sha1(JSON.stringify(I)),!m){t.next=26;break}return t.next=23,this._state.deviceStorage.loadDocument(I.collection,C);case 23:L=t.sent,t.next=29;break;case 26:return t.next=28,this._state.deviceStorage.queryCollection(I.collection,C);case 28:L=t.sent;case 29:return L||(L={statusCode:200,body:[]}),t.abrupt("return",L);case 31:t.next=36;break;case 33:t.prev=33,t.t2=t.catch(1),this._state.addSystemErrorToStack(26,"3 "+t.t2.name+": "+t.t2.message);case 36:case"end":return t.stop()}}),t,this,[[1,33]])}))),function(t){return m.apply(this,arguments)})},{key:"archiveMessages",value:(v=$e(Qe().mark((function t(){var e,r,n,o,i;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this._state,r=e._,n=e.frontmlib,o={conversationId:e.conversationId,messageId:e.messageIdFromUser||e.getUniqueId(),content:[e.messageFromUser],contentType:"10",createdOn:Date.now(),ttl:Date.now()+2592e6,deleted:[],delivered:[],opened:[],userDomain:e.currentUserDomain,createdBy:e.user.userId},i=[],Qn.debug({message:"Responses array",data:e.responsesArray}),r.isEmpty(e.responsesArray)?"10"!==e.messageTypeFromUser&&"string"!==e.messageTypeFromUser||i.push(o):(Qn.debug({message:"messageToArchive",data:o}),Qn.debug({message:"nlpResults",data:e.nlpResults}),r.isEmpty(e.nlpResults)||i.push(o),r.forEach(e.responsesArray,(function(t){if("string"===t.type){var n=r.clone(o);delete n.createdBy,n.messageId=t.messageId||e.getUniqueId(),n.content=[t.message],n.createdOn=Date.now(),i.push(n)}}))),Qn.debug({message:"Messages to archive",data:i}),!(i.length>0)){t.next=12;break}return t.next=12,n.insertMessages(i);case 12:case"end":return t.stop()}}),t,this)}))),function(){return v.apply(this,arguments)})},{key:"writeAuditIndex",value:(y=$e(Qe().mark((function t(e,r,n,o,i){var s,c,u;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!n){t.next=9;break}return s={operation:o,location:i?gt:bt,timestamp:Date.now(),userId:this._state.user.userId,userEmail:this._state.user.userEmail,client:this._state.client,appVersion:this._state.appVersion,botId:this._state.botId,userDomain:this._state.currentUserDomain},{},c=e===a?this._state.R.merge(s,r):this._state.R.merge(s,{document:r}),u="".concat(p,"_").concat(this._state.currentUserDomain,"_").concat(e),t.next=7,this._state.db.writeDataIntoIndex({index:u,doc:c});case 7:return t.next=9,this.archiveMessages();case 9:case"end":return t.stop()}}),t,this)}))),function(t,e,r,n,o){return y.apply(this,arguments)})},{key:"insertDocumentInCollection",value:(d=$e(Qe().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d,p,y=this;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.collection,n=e.document,o=e.audit,i=e.sync,a=void 0!==i&&i,s=e.system,c=void 0!==s&&s,u=e.securedFields,l=e.cache,h=void 0!==l&&l,f=e.asyncCall,d=void 0!==f&&f,p={action:"insertOne",db:c?ft:this._state.currentUserDomain,collection:r,document:n,userId:this._state.user.userId,securedFields:u},t.abrupt("return",this._state.callLambda("MongoDBManager",p,this.getLambdaInvocationType(d)).then((function(t){return y.checkMongoResponse(t,p,h,o,!1,g,a)})).catch((function(t){console.log("6. adding system error"),y._state.addSystemErrorToStack(7,t.message)})));case 3:case"end":return t.stop()}}),t,this)}))),function(t){return d.apply(this,arguments)})},{key:"insertManyDocumentsInCollection",value:(f=$e(Qe().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d,p,y=this;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.collection,n=e.documents,o=e.audit,i=e.sync,a=void 0!==i&&i,s=e.system,c=void 0!==s&&s,u=e.securedFields,l=e.cache,h=void 0!==l&&l,f=e.asyncCall,d=void 0!==f&&f,p={action:"insertArray",db:c?ft:this._state.currentUserDomain,collection:r,documents:n,userId:this._state.user.userId,securedFields:u},t.abrupt("return",this._state.callLambda("MongoDBManager",p,this.getLambdaInvocationType(d)).then((function(t){return y.checkMongoResponse(t,p,h,o,!1,g,a)})).catch((function(t){console.log("6. adding system error"),y._state.addSystemErrorToStack(7,t.message)})));case 3:case"end":return t.stop()}}),t,this)}))),function(t){return f.apply(this,arguments)})},{key:"getLambdaInvocationType",value:function(t){return t?"Event":"RequestResponse"}},{key:"updateDataInCollection",value:(h=$e(Qe().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d,p,y,v,m,g,_,w,S,k,E,x,I,T,O,C,L=this;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.collection,n=e.document,o=e.query,i=e.options,a=e.audit,s=e.sync,c=void 0!==s&&s,u=e.system,l=void 0!==u&&u,h=e.securedFields,f=e.cache,d=void 0!==f&&f,p=e.updateMany,y=void 0===p||p,v=e.local,m=void 0!==v&&v,g=e.updateOperator,_=void 0===g?"$set":g,w=e.asyncCall,S=void 0!==w&&w,k=this._state._,E={action:y?"updateMany":"update",db:l?ft:this._state.currentUserDomain,collection:r,document:n,query:o,options:i,userId:this._state.user.userId,updateOperator:_,securedFields:h},t.t0=this._state.location===bt||this._state.client===vt,t.t0){t.next=11;break}return t.next=7,this._state.online();case 7:if(t.t1=t.sent,!t.t1){t.next=10;break}t.t1=!(this._state.location===gt);case 10:t.t0=t.t1;case 11:if(!t.t0){t.next=15;break}return t.abrupt("return",this._state.callLambda("MongoDBManager",E,this.getLambdaInvocationType(S)).then((function(t){return L.checkMongoResponse(t,E,d,a,!1,b,c)})).catch((function(t){L._state.addSystemErrorToStack(7,t.message)})));case 15:return x=this._state.sha1(JSON.stringify(E)),t.next=18,this._state.deviceStorage.loadDocument(r,x);case 18:if(t.t2=t.sent,t.t2){t.next=21;break}t.t2={};case 21:if(I=t.t2,k.size(I)>0)if(T=k.get(I,"body"),Array.isArray(T)){for(O=[],C=0;C<T.length;C++)O.push(k.merge(T[C],n));I.body=O}else this._state.addSystemErrorToStack(7,"Error updating document in local storage");else I={statusCode:200,body:[n]};return t.next=25,this._state.deviceStorage.saveDocument(r,x,I);case 25:m||this._state.addObjectToSyncMessage(r,JSON.stringify(E),I);case 26:case"end":return t.stop()}}),t,this)}))),function(t){return h.apply(this,arguments)})},{key:"updateManyDataInCollection",value:(l=$e(Qe().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d,p,y,v,m,g,_,w,S,k,E,x,I=this;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.collection,n=e.document,o=e.query,i=e.options,a=e.audit,s=e.sync,c=void 0!==s&&s,u=e.system,l=void 0!==u&&u,h=e.securedFields,f=e.updateOperator,d=void 0===f?"$set":f,p=e.cache,y=void 0!==p&&p,v=e.asyncCall,m=void 0!==v&&v,g=this._state._,_={action:"updateMany",db:l?ft:this._state.currentUserDomain,collection:r,document:n,query:o,options:i,userId:this._state.user.userId,updateOperator:d,securedFields:h},t.t0=this._state.location===bt||this._state.client===vt,t.t0){t.next=11;break}return t.next=7,this._state.online();case 7:if(t.t1=t.sent,!t.t1){t.next=10;break}t.t1=!(this._state.location===gt);case 10:t.t0=t.t1;case 11:if(!t.t0){t.next=15;break}return t.abrupt("return",this._state.callLambda("MongoDBManager",_,this.getLambdaInvocationType(m)).then((function(t){return console.log("6.9 in then"),I.checkMongoResponse(t,_,y,a,!1,b,c)})).catch((function(t){console.log("7. adding system error "+JSON.stringify(t)),I._state.addSystemErrorToStack(7,t.message)})));case 15:return w=this._state.sha1(JSON.stringify(_)),t.next=18,this._state.deviceStorage.loadDocument(r,w);case 18:if(t.t2=t.sent,t.t2){t.next=21;break}t.t2={};case 21:if(S=t.t2,g.size(S)>0)if(k=g.get(S,"body"),Array.isArray(k)){for(E=[],x=0;x<k.length;x++)E.push(g.merge(k[x],n));S.body=E}else this._state.addSystemErrorToStack(7,"Error updating document in local storage");else S={statusCode:200,body:[n]};return t.next=25,this._state.deviceStorage.saveDocument(r,w,S);case 25:this._state.addObjectToSyncMessage(r,JSON.stringify(_),S);case 26:case"end":return t.stop()}}),t,this)}))),function(t){return l.apply(this,arguments)})},{key:"deleteDataFromCollection",value:(u=$e(Qe().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d,p=this;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.collection,n=e.query,o=e.sync,i=e.audit,a=e.system,s=void 0!==a&&a,c=e.deleteMany,u=void 0!==c&&c,l=e.local,h=void 0!==l&&l,f={action:u?"deleteMany":"delete",db:s?ft:this._state.currentUserDomain,collection:r,query:n,userId:this._state.user.userId},!h){t.next=7;break}return d=this._state.sha1(JSON.stringify(f)),t.next=6,this._state.deviceStorage.deleteDocument(r,d);case 6:return t.abrupt("return",t.sent);case 7:return t.abrupt("return",this._state.callLambda("MongoDBManager",f,"RequestResponse").then((function(t){return p.checkMongoResponse(t,f,!1,i,!1,w,o)})).catch((function(t){console.log("8. adding system error"),p._state.addSystemErrorToStack(7,t.message)})));case 8:case"end":return t.stop()}}),t,this)}))),function(t){return u.apply(this,arguments)})},{key:"deleteManyDataFromCollection",value:(c=$e(Qe().mark((function t(e){var r,n,o,i,a,s,c=this;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.collection,n=e.query,o=e.sync,i=e.audit,a=e.system,s={action:"deleteMany",db:void 0!==a&&a?ft:this._state.currentUserDomain,collection:r,query:n,userId:this._state.user.userId},t.abrupt("return",this._state.callLambda("MongoDBManager",s,"RequestResponse").then((function(t){return c.checkMongoResponse(t,s,!1,i,!1,w,o)})).catch((function(t){console.log("8. adding system error"),c._state.addSystemErrorToStack(7,t.message)})));case 3:case"end":return t.stop()}}),t,this)}))),function(t){return c.apply(this,arguments)})},{key:"getCatalogue",value:(s=$e(Qe().mark((function t(e){var r,n,o,i;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.query,n=e.userDomain,t.prev=1,o={query:r,isAllBotsRequest:!0,selectedDomain:n,email:this._state.user.userEmail},t.next=5,this._state.callLambda("catalogueLambda",o,"RequestResponse");case 5:if(!(i=t.sent)){t.next=8;break}return t.abrupt("return",JSON.parse(i.Payload));case 8:t.next=14;break;case 10:t.prev=10,t.t0=t.catch(1),console.log("9. adding system error"),this._state.addSystemErrorToStack(7,null,t.t0.message);case 14:case"end":return t.stop()}}),t,this,[[1,10]])}))),function(t){return s.apply(this,arguments)})},{key:"getStaticData",value:function(t,e,r,n){var o="KeyValues_"+this._state.currentUserDomain;return this.getData(o,t,e,r,n)}},{key:"getData",value:function(t,e,r,n,o){var i=this,a={collection:t,query:e,scan:r,capability:"GetData",pagination:n,sort:o,sync:!0};return this._state.callLambda("SystemCapabilities",a,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("10. adding system error"),i._state.addSystemErrorToStack(7,t.message)}))}},{key:"getDataFromIndex",value:function(t,e,r,n,o){var i=this,a={method:"GET",action:"search",index:this._state._.toLower(t),q:e,size:r,sort:n,exact:o};return this._state.callLambda("elastiSearch",a,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("11. adding system error"),i._state.addSystemErrorToStack(7,t.message)}))}},{key:"getDataFromIndexWithID",value:function(t,e,r){var n=this,o={method:"GET_WITH_ID",index:this._state._.toLower(t),docType:e,id:r};return this._state.callLambda("elastiSearch",o,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("12. adding system error"),n._state.addSystemErrorToStack(7,t.message)}))}},{key:"getDataFromIndexWithSQL",value:function(t){var e=this,r={method:"SQL",q:t};return this._state.callLambda("elastiSearch",r,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("13. adding system error"),e._state.addSystemErrorToStack(7,t.message)}))}},{key:"deleteDataFromIndex",value:function(t,e,r){var n=this,o={method:"DELETE",index:this._state._.toLower(t),q:r,docType:e};return this._state.callLambda("elastiSearch",o,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("14. adding system error"),n._state.addSystemErrorToStack(7,t.message)}))}},{key:"deleteDataFromIndexByID",value:function(t,e,r){var n=this,o={method:"DELETE",index:this._state._.toLower(t),docType:e,id:r};return this._state.callLambda("elastiSearch",o,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("15. adding system error"),n._state.addSystemErrorToStack(7,t.message)}))}},{key:"getDataFromIndexWithQueryObject",value:function(t,e){var r=this,n={method:"GET",action:"bodySearch",index:this._state._.toLower(t),q:e};return this._state.callLambda("elastiSearch",n,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("16. adding system error"),r._state.addSystemErrorToStack(7,t.message)}))}},{key:"countDataInIndex",value:function(t,e){var r=this,n={method:"GET",action:"count",index:this._state._.toLower(t),q:e};return this._state.callLambda("elastiSearch",n,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("17. adding system error"),r._state.addSystemErrorToStack(7,t.message)}))}},{key:"writeDataIntoIndex",value:function(t){var e=this,r=t.index,n=t.docType,o=void 0===n?"_doc":n,i=t.doc,a={method:"POST",action:"insert",index:this._state._.toLower(r),docType:o,doc:i};return this._state.callLambda("elastiSearch",a,"Event").then((function(t){})).catch((function(t){console.log("18. adding system error"),e._state.addSystemErrorToStack(7,t.message)}))}},{key:"bulkWriteDataIntoIndex",value:function(t){var e=this,r=t.index,n=t.docType,o=void 0===n?"_doc":n,i=t.docs,a=t.docIdField,s={method:"BULK_INSERT",action:"insert",index:this._state._.toLower(r),docType:o,docs:i,docIdField:a};return this._state.callLambda("elastiSearch",s,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("19. adding system error"),e._state.addSystemErrorToStack(7,t.message)}))}},{key:"updateDataInIndex",value:function(t){var e=this,r=t.index,n=t.docType,o=void 0===n?"_doc":n,i=t.doc,a={method:"PUT",docType:o,index:this._state._.toLower(r),doc:i,id:i.id};return this._state.callLambda("elastiSearch",a,"Event").then((function(t){})).catch((function(t){console.log("20. adding system error"),e._state.addSystemErrorToStack(7,t.message)}))}},{key:"writeTransactionData",value:function(t){var e="Transactions_"+this._state.currentUserDomain;return this.writeData(e,t)}},{key:"writeStaticData",value:function(t){var e="KeyValues_"+this._state.currentUserDomain;return this.writeData(e,t)}},{key:"writeData",value:function(t,e){var r=this,n={collection:t,documents:e,capability:"WriteData"};return this._state.callLambda("SystemCapabilities",n,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("21. adding system error"),r._state.addSystemErrorToStack(7,t.message)}))}},{key:"updateStaticData",value:(i=$e(Qe().mark((function t(e,r,n,o){var i,a,s,c,u;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i="KeyValues_"+this._state.currentUserDomain,a=this._state,s=a.developer,t.prev=3,!(this._state.location===bt||this._state.location===gt&&this._state.v1Compatibility)){t.next=10;break}return c=this._state.frontmlib,t.next=8,c.dbUpdateItem(i,e,r,n,o);case 8:return u=t.sent,t.abrupt("return",u);case 10:t.next=17;break;case 12:t.prev=12,t.t0=t.catch(3),console.log("22. adding system error"),s.log({message:"Error updateStaticData::: ",data:JSON.stringify(t.t0)}),this._state.addSystemErrorToStack(7,null,t.t0.message);case 17:case"end":return t.stop()}}),t,this,[[3,12]])}))),function(t,e,r,n){return i.apply(this,arguments)})},{key:"deleteTransactionData",value:function(t){var e="Transactions_"+this._state.currentUserDomain;return this.deleteData(e,t)}},{key:"deleteStaticData",value:function(t){var e="KeyValues_"+this._state.currentUserDomain;return this.deleteData(e,t)}},{key:"deleteData",value:function(t,e){var r=this,n={collection:t,query:e,capability:"DeleteData"};return this._state.callLambda("SystemCapabilities",n,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("23. adding system error"),r._state.addSystemErrorToStack(7,t.message)}))}},{key:"strigifyValue",value:function(t){return this._.isString(t)?t:this._.isObjectLike(t)?JSON.stringify(t):this._.toString(t)}},{key:"createParamsForAdd",value:function(t){var e=this;return Array.isArray(t)||(t=[t]),t.map((function(t){var r=t.key,n=t.value,o=t.expiry,i=t.isArrayElement,a=t.index;return{key:r,value:n=e.strigifyValue(n),expiry:o,isArrayElement:i,index:a}}))}},{key:"callRedisWriteQueue",value:function(t){var e={action:"add",data:t};return this._state.sizeOfObject(JSON.stringify(e,null,0)),this._state.callLambda("RedisWriteQueue",e,"RequestResponse").then((function(t){return JSON.parse(t.Payload)}))}},{key:"callRedisDeleteQueue",value:function(t){var e={action:"delete",key:t};return this._state.callLambda("RedisWriteQueue",e,"RequestResponse").then((function(t){return JSON.parse(t.Payload)}))}},{key:"deleteOneKeyInCache",value:function(t){return this.callRedisDeleteQueue(t)}},{key:"setOneValueInCache",value:function(t,e){return this.callRedisWriteQueue(this.createParamsForAdd({key:t,value:e}))}},{key:"setOneValueInCacheWithExpiry",value:function(t,e,r){var n=this.createParamsForAdd({key:t,value:e,expiry:r});return this.callRedisWriteQueue(n)}},{key:"setMultipleValuesInCache",value:function(t){return this.callRedisWriteQueue(this.createParamsForAdd(t))}},{key:"addOneListElementInCache",value:function(t,e){return this.addMultipleListElementInCache({key:t,value:e})}},{key:"updateOneListElementInCache",value:function(t,e,r){return this.addMultipleListElementInCache({key:t,value:e,index:r})}},{key:"addMultipleListElementInCache",value:function(t){return Array.isArray(t)||(t=[t]),t=t.map((function(t){return t.isArrayElement=!0,t})),this.callRedisWriteQueue(this.createParamsForAdd(t))}},{key:"getValueFromCache",value:function(t){return this.getMultipleValuesFromCache(t).then((function(e){return e[t]}))}},{key:"getObjectFromCache",value:function(t){return this.getMultipleValuesFromCache(t).then((function(e){var r,n=null===(r=e[t])||void 0===r?void 0:r.content;if(n)try{return JSON.parse(n)}catch(t){return n}}))}},{key:"getMultipleValuesFromCache",value:function(t){Array.isArray(t)||(t=[t]);var e={multiKeys:t};return this._state.callLambda("RedisReadQueue",e,"RequestResponse").then((function(t){return JSON.parse(t.Payload)}))}},{key:"getKeysOnPattern",value:function(t){var e={pattern:t};return this._state.callLambda("RedisReadQueue",e,"RequestResponse").then((function(t){return JSON.parse(t.Payload)}))}},{key:"getUser",value:(o=$e(Qe().mark((function t(e){var r;return Qe().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,!(this._state.location===bt||this._state.location===gt&&this._state.v1Compatibility)){t.next=6;break}return r=this._state.frontmlib,t.next=5,r.getUser(e);case 5:return t.abrupt("return",t.sent);case 6:t.next=12;break;case 8:t.prev=8,t.t0=t.catch(0),console.log("24. adding system error"),this._state.addSystemErrorToStack(7,null,t.t0.message);case 12:case"end":return t.stop()}}),t,this,[[0,8]])}))),function(t){return o.apply(this,arguments)})}],n=[{key:"CONVERSATIONS_INDEX",value:function(){return"conversations*"}}],r&&Xe(e.prototype,r),n&&Xe(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function tr(t){return tr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},tr(t)}function er(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,or(n.key),n)}}function rr(t,e,r){return e&&er(t.prototype,e),r&&er(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function nr(t,e,r){return(e=or(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function or(t){var e=function(t,e){if("object"!==tr(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==tr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===tr(e)?e:String(e)}var ir=rr((function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}));function ar(t){return ar="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ar(t)}function sr(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return cr(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?cr(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw i}}}}function cr(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function ur(){ur=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==ar(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(ar(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function lr(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function hr(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){lr(i,n,o,a,s,"next",t)}function s(t){lr(i,n,o,a,s,"throw",t)}a(void 0)}))}}function fr(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==ar(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==ar(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===ar(o)?o:String(o)),n)}var o}nr(ir,"TEXT_FIELD","text_field"),nr(ir,"NUMBER_FIELD","number"),nr(ir,"TEXT_AREA","text_area"),nr(ir,"RICH_TEXT_AREA","rich_text_area"),nr(ir,"CHECKBOX","checkbox"),nr(ir,"RADIOBUTTON","radiobutton"),nr(ir,"DROPDOWN","dropdown"),nr(ir,"SWITCH","switch"),nr(ir,"SLIDER","slider"),nr(ir,"DATE","date"),nr(ir,"DATETIME","datetime"),nr(ir,"TIME","time"),nr(ir,"MULTI_SELECTION","multi_selection"),nr(ir,"PASSWORD_FIELD","password_field"),nr(ir,"LOOKUP","lookup"),nr(ir,"IMAGE_FIELD","image_field"),nr(ir,"VIDEO_FIELD","video_field"),nr(ir,"FILE_FIELD","file_field"),nr(ir,"BUTTONS_FIELD","buttons_field"),nr(ir,"CHAT_FIELD","chat_field"),nr(ir,"VIDEO_CALL_FIELD","video_call_field"),nr(ir,"VOICE_CALL_FIELD","voice_call_field"),nr(ir,"ROW_MENU_FIELD","row_menu_field"),nr(ir,"COLOR_FIELD","color_field"),nr(ir,"ALERT_FIELD","alert_field"),nr(ir,"COORDINATES","coordinates_field"),nr(ir,"GEO_POINT_FIELD","geo_point_field"),nr(ir,"GEO_AREA_FIELD","geo_area_field"),nr(ir,"OBJECT_DROPDOWN","object_dropdown"),nr(ir,"OBJECT_LOOKUP","object_lookup"),nr(ir,"OBJECT_MULTI_SELECTION","object_multi_selection"),nr(ir,"MAP_AREA","map_area"),nr(ir,"MAP_DATA","map_data"),nr(ir,"PHONE_NUMBER_FIELD","phone_number"),nr(ir,"EMAIL_FIELD","email_field"),nr(ir,"COLOR_PICKER_FIELD","color_picker"),nr(ir,"ICON_FIELD","icon_field");var dr=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._;var r;r=e.context.capabilities.capabilities?e.context.capabilities:e.context,this._context=r}var e,r,n,o,i,a,s;return e=t,r=[{key:"read",value:function(){var t={Bucket:envConfig.BOT_LOGO_BUCKET,CopySource:conversationBucket+"/"+conversationId+"/"+fileName,Key:botName.replace(/[^A-Z0-9]+/gi,"_")+"_"+botId+"."+fileExtension,ACL:"public-read"};return s3.copyObject(t).promise()}},{key:"createQRCode",value:(s=hr(ur().mark((function t(e,r){var n,o,i,a,s,c,u,l,h,f,d;return ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e){t.next=2;break}throw new Error("qrText is required");case 2:return r||(r="".concat(this._state.getUniqueId(),".png")),t.prev=3,n=this._context,o=n.QRCode,i=n.config,a=n.env,s=n.aws,c=new s.S3,u=o.toDataURL(e),l=Buffer.from(u.replace(/^data:image\/\w+;base64,/,""),"base64"),h=i[a].CONVERSATIONS_BUCKET,f=this._state.conversationId,d={Bucket:h,Key:"".concat(f,"/").concat(r),Body:l,ContentType:"image/png",ContentEncoding:"base64"},this._state.developer.log({message:"createQRCode",data:{bucket:h,conversationId:f,qrImageName:r}}),t.next=14,c.upload(d).promise();case 14:return t.abrupt("return",r);case 17:throw t.prev=17,t.t0=t.catch(3),new Error("Error while creating QR Code"+t.t0.message);case 20:case"end":return t.stop()}}),t,this,[[3,17]])}))),function(t,e){return s.apply(this,arguments)})},{key:"generateCsvFileFromMongo",value:(a=hr(ur().mark((function t(e,r,n,o,i){var a,s,c,u,l,h,f,d,p,y,v,m,g,b,_,w,S,k,E,x;return ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r&&r.headers&&r.headerTitles&&r.collection&&o&&n)){t.next=42;break}return Date.now(),(a=this._context).stream,s=a.config,c=a.env,a.frontmlib,u=a.aws,a.moment,l=r.headers,h=r.headerTitles,f=r.collection,d=r.limit,p=r.sort,r.projection,y=r.skip,v="",m=h.join(",")+"\n",this._state.developer.log({message:"generateCsvFileFromMongo: Header String Logging",data:{headerString:m}}),v+=m,g={},l.map((function(t){g[t]=1})),f.document.cache=!1,this._state.developer.log({message:"generateCsvFileFromMongo: query",data:e}),t.next=14,f.loadCollectionWithQuery({query:e||{},projection:g,sort:p||{},skip:y||0,limit:d||100,collation:{}});case 14:if(!(f.rows.length>0)){t.next=39;break}return b=new u.S3,_=this._state.moment,w=f.rows.map((function(t){return l.map((function(e){var r,n,o=sr(t.fields);try{for(o.s();!(n=o.n()).done;){var i=n.value;if(i.id===e||i.dbName===e)if(i.type===ir.DATETIME||i.type===ir.DATE){var a=new Date(i.value);r=isNaN(a)?" ":_(a).format("YYYY/MM/DD hh:mm:ss Z")}else r="string"!=typeof i.value&&void 0!==i.value?i.value.toString():i.value}}catch(t){o.e(t)}finally{o.f()}return r||'" "'}))})),S=w.map((function(t){return t.join(",")})).join("\n"),v+=S,this._state.developer.log({message:"generateCsvFileFromMongo: final csv string before upload",data:{stringCSV:v}}),o=o||"mongoUpload".concat(this._state.UUID(),".csv"),k=s[c].CONVERSATIONS_BUCKET,E={Bucket:k,Key:"".concat(n,"/").concat(o),Body:v},i&&(E.ContentDisposition='attachment;filename="'.concat(o,'"'),E.ACL="public-read"),t.prev=25,t.next=28,b.upload(E).promise();case 28:return x=t.sent,this._state.developer.log({message:"generateCsvFileFromMongo: Successfully Uploaded to S3",data:{datafromUpload:x}}),t.abrupt("return",x);case 33:return t.prev=33,t.t0=t.catch(25),this._state.developer.log({message:"generateCsvFileFromMongo: Error Uploading to S3",data:{err:t.t0}}),t.abrupt("return",{error:t.t0});case 37:t.next=40;break;case 39:this._state.developer.log({message:"generateCsvFileFromMongo: No Data from MongoDb"});case 40:t.next=43;break;case 42:this._state.developer.log({message:"generateCsvFileFromMongo: Validation failed"});case 43:case"end":return t.stop()}}),t,this,[[25,33]])}))),function(t,e,r,n,o){return a.apply(this,arguments)})},{key:"generateCsvFileFromDynamo",value:(i=hr(ur().mark((function t(e,r,n,o){var i,a,s,c,u,l,h,f,d,p,y,v,m,g,b,w,S,k,E=this;return ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=Date.now(),a=this._context,s=a.stream,c=a.config,u=a.env,l=a.frontmlib,h=a.aws,f=a.moment,d=new h.S3,p=r.headers,y=r.specialFields,v=Object.keys(r.specialFields||{}),m=this._(p).mapKeys().mapValues((function(){return""})).value(),g=new s.Readable({read:function(){}}),b=c[u].CONVERSATIONS_BUCKET,w={Bucket:b,Key:"".concat(n,"/").concat(o),Body:g},this._state.developer.log({message:"generateCsvFileFromDynamo",data:{bucket:b,conversationId:n,fileName:o}}),S=new Promise(function(){var t=hr(ur().mark((function t(r,n){var o,a,s,c;return ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:d.upload(w,(function(t,e){null!==t?n(t):r(e)})),o='"'+p.join('","')+'"\n',g.push(o),E._state.developer.log({message:"generateCsvFileFromDynamo: Wrote header to the csv file"});case 4:return t.next=6,l.dbGetWithPagination(e.TableName,e.IndexName,e.KeyConditionExpression,e.FilterExpression,e.ExpressionAttributeValues,e.ExclusiveStartKey||null,e.Fields,e.options);case 6:if(a=t.sent,s=a.Items,c=a.LastEvaluatedKey,E._state.developer.log({message:"generateCsvFileFromDynamo: got items from dynamo",data:{size:E._.size(s),LastEvaluatedKey:c}}),E._.map(s,(function(t){var e=E._({}).assign(m,E._.pick(t,p)).value();v&&E._.forEach(v,(function(t){var r=y[t],n=e[t];if(!E._.isNumber(n)&&E._.isEmpty(n))return!0;"dateTime"===r.type&&(e[t]=f(E._.toNumber(n)).format(r.format||"DD/MMMM/YYYY hh:mm a"))}));var r=E._(e).values().join('","');g.push('"'.concat(r,'"\n'))})),c&&0!==_.size(s)){t.next=13;break}return t.abrupt("break",15);case 13:e.ExclusiveStartKey=c;case 14:if(null!==e.ExclusiveStartKey){t.next=4;break}case 15:g.push(null),g.on("end",(function(){var t=Date.now()-i;E._state.developer.log({message:"generateCsvFileFromDynamo: totalTime to create csv in generateCsvFileFromDynamo:",data:{totalTime:t}})})),g.on("error",(function(t){E._state.developer.log({message:"generateCsvFileFromDynamo: Stream erred",data:t}),n(t)}));case 18:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}()),t.prev=11,t.next=14,S;case 14:return k=t.sent,this._state.developer.log({message:"generateCsvFileFromDynamo: final response:",data:k}),t.abrupt("return",k);case 19:t.prev=19,t.t0=t.catch(11);case 21:case"end":return t.stop()}}),t,this,[[11,19]])}))),function(t,e,r,n){return i.apply(this,arguments)})},{key:"compressVideo",value:(o=hr(ur().mark((function t(e,r){var n,o=this;return ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n={Records:[{s3:{bucket:{name:e},object:{key:r}}}]},t.abrupt("return",this._state.callLambda("videoConverterLambda",n,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){o._state.addSystemErrorToStack(7,t.message)})));case 2:case"end":return t.stop()}}),t,this)}))),function(t,e){return o.apply(this,arguments)})},{key:"validateGeoJSON",value:(n=hr(ur().mark((function t(e,r){var n,o=this;return ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n={bucket:e,fileName:r},t.abrupt("return",this._state.callLambda("geoJSONValidationLambda",n,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})).catch((function(t){console.log("26. adding system error"),o._state.addSystemErrorToStack(7,t.message)})));case 2:case"end":return t.stop()}}),t,this)}))),function(t,e){return n.apply(this,arguments)})}],r&&fr(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function pr(t){return pr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},pr(t)}function yr(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==pr(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==pr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===pr(o)?o:String(o)),n)}var o}var vr=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this.context=e.context,this.userId=e.user.userId,this.conversation=e.conversation,this._=e._}var e,r;return e=t,r=[{key:"getBaseParams",value:function(){return{capability:"SitesCapability",capabilityFileName:"sitesCapability",sync:!0,userId:this.userId,conversation:this.conversation}}},{key:"getSites",value:function(){var t=this.getBaseParams();return t.action="GetUserSites",this._state.callCapability(t)}},{key:"searchLocalSites",value:function(t,e){var r=this.getBaseParams();return r.action="SearchSites",r.searchTerm=t,r.siteType=e,this._state.callCapability(r)}},{key:"searchGlobalSites",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["IMO","MMSI"],n=this.getBaseParams();return n.action="SearchGlobalSites",n.searchTerm=t,n.siteType=e,n.searchFields=r,this._state.callCapability(n)}},{key:"deleteSite",value:function(t){var e=this.getBaseParams();return e.action="DeleteSite",e.siteId=t.siteId,this._state.callCapability(e)}},{key:"updateSite",value:function(t){var e=this.getBaseParams();return e.action="UpdateSite",e.site=t,this._state.callCapability(e)}},{key:"createSites",value:function(t,e){var r=this.getBaseParams();return r.action="CreateSites",r.sites=t,r.siteType=e,this._state.callCapability(r)}}],r&&yr(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function mr(t){return mr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},mr(t)}function gr(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==mr(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==mr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===mr(o)?o:String(o)),n)}var o}var br=function(){function t(e){(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")})(this,t),this._state=e,this._=e._,this.R=e.R}return e=t,(r=[{key:"startMotionDetection",value:function(t){this._state.context.getCapability("Accelerometer").startUpdates(this._state.context.botManifest.botId,this._state.conversationId,t)}},{key:"stopMotionDetection",value:function(){this._state.context.getCapability("Accelerometer").stopUpdates(this._state.context.botManifest.botId,this._state.conversationId)}}])&&gr(e.prototype,r),n&&gr(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t;var e,r,n}();function _r(t){return _r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_r(t)}function wr(){wr=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==_r(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(_r(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Sr(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function kr(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Sr(i,n,o,a,s,"next",t)}function s(t){Sr(i,n,o,a,s,"throw",t)}a(void 0)}))}}function Er(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==_r(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==_r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===_r(o)?o:String(o)),n)}var o}var xr=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._;var r=e.context.capabilities.capabilities;this._turf=r?e.context.capabilities.turf:e.context.turf,this.offlineMaps={},this._state.client===yt&&this._state.location===gt&&(this.offlineMaps=this._state.context.getCapability("OfflineMap"))}var e,r,n,o,i,a,s,c;return e=t,r=[{key:"getDeviceLocation",value:function(){var t=this;return this._state.location===gt?this._state.context.getCapability("DeviceLocation").getDeviceLocation().catch((function(e){t._state.addSystemErrorToStack(53,null,e)})):(this._state.addSystemErrorToStack(54),Promise.resolve())}},{key:"getLocationWithQuery",value:(c=kr(wr().mark((function t(e){var r,n;return wr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,"string"!=typeof(r=e)&&(r=JSON.stringify(e)),t.next=5,this._state.api.callService("Geocode",{queryParams:"q="+r});case 5:if(n=t.sent){t.next=8;break}return t.abrupt("return",[]);case 8:return t.abrupt("return",JSON.parse(n));case 11:return t.prev=11,t.t0=t.catch(0),this._state.developer.log({message:"Getting error while calling Geocode: "+t.t0.message}),t.abrupt("return",{error:"err"});case 15:case"end":return t.stop()}}),t,this,[[0,11]])}))),function(t){return c.apply(this,arguments)})},{key:"startLocationTracking",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:180;return this._state.context.getCapability("LocationTracker").start_tracking({botId:this._state.context.botManifest.botId,conversationId:this._state.conversationId},t,e)}},{key:"stopLocationTracking",value:function(){return this._state.context.getCapability("LocationTracker").stop_tracking({botId:this._state.context.botManifest.botId,conversationId:this._state.conversationId})}},{key:"saveMap",value:(s=kr(wr().mark((function t(e){var r,n,o,i,a,s,c,u,l;return wr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.name,n=e.neBound,o=e.swBound,i=e.minZoom,a=void 0===i?12:i,s=e.maxZoom,c=void 0===s?16:s,void 0===e.progressListener&&this.progressListener,void 0===e.errorListener&&this.errorListener,u=this._state,l=u.developer,u.client!==yt){t.next=18;break}if(t.prev=4,!u.maps[r]){t.next=8;break}return t.next=8,this.deleteMap(r);case 8:return u.maps[r]=!0,t.next=11,this.offlineMaps.saveMap(r,n,o,a,c,(function(t,e,r,n,o,i,a,s){l.log({message:"Progress being made downloading map",data:i})}),(function(t,e){l.log({message:"Error downloading map",data:e})}));case 11:t.next=16;break;case 13:t.prev=13,t.t0=t.catch(4),l.log({message:"Error downloading map",data:t.t0});case 16:t.next=19;break;case 18:l.warning({message:"Maps cannot be downloaded on web app for now"});case 19:case"end":return t.stop()}}),t,this,[[4,13]])}))),function(t){return s.apply(this,arguments)})},{key:"deleteMap",value:(a=kr(wr().mark((function t(e){return wr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.offlineMaps.deleteMap(e);case 2:delete this._state.maps[e];case 3:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"startTracking",value:(i=kr(wr().mark((function e(r,n,o,i){var a,s;return wr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this._state.getUniqueId(),s={intentId:t.START_TRACKING(),jobId:a,assetType:r,assetDetails:n},o&&(s.repeats=o),i&&(s.respondsTo={userId:this._state.user.userId,botId:this._state.conversation.bot,userDomain:this._state.conversation.userDomain,intentId:i}),e.next=6,this._state.notification.sendBroadcastNotificationToBot(t.TRACKER_BOT(),this._state.conversation.userDomain,Le.BOT_TO_BOT(),s);case 6:return e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(t,e,r,n){return i.apply(this,arguments)})},{key:"startTrackingVessel",value:function(e,r,n){return this.startTracking(t.VESSEL(),e,r,n)}},{key:"startTrackingFlight",value:function(e,r,n){return this.startTracking(t.FLIGHT(),e,r,n)}},{key:"stopTracking",value:function(t){}},{key:"getLatestKnownLocation",value:function(t,e,r){var n={capability:"AssetTrackerCapability",capabilityFileName:"assetTrackerCapability",action:"getLatestAssetLocation",assetId:t,sessionId:e,userId:this._state.user.userId,conversation:this._state.conversation};return r&&(n.tableName=r),this._state.callCapability(n)}},{key:"getLocation",value:function(t,e,r,n,o){var i={capability:"AssetTrackerCapability",capabilityFileName:"assetTrackerCapability",action:"getAssetLocationForDuration",assetId:t,sessionId:e,from:r,to:n,userId:this._state.user.userId,conversation:this._state.conversation};return o&&(i.tableName=o),this._state.callCapability(i)}},{key:"getLocationWithPagination",value:function(t,e){var r=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0,o={capability:"AssetTrackerCapability",capabilityFileName:"assetTrackerCapability",action:"getAssetLocationsWithPagination",assetId:t,sessionId:e,pageSize:arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,userId:this._state.user.userId,conversation:this._state.conversation};return r&&(o.last=r),n&&(o.tableName=n),this._state.callCapability(o)}},{key:"storeNewLocation",value:function(t,e,r,n,o){var i={capability:"AssetTrackerCapability",capabilityFileName:"assetTrackerCapability",action:"addNewLocation",assetId:e,sessionId:t,details:r,userId:this._state.user.userId,conversation:this._state.conversation};return n&&(i.createdOn=n),o&&(i.tableName=o),this._state.callCapability(i)}},{key:"getWeatherOnLocation",value:(o=kr(wr().mark((function t(e,r){var n,o;return wr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n="".concat(e,",").concat(r),t.prev=2,o=this._state.api.callService("MaritimeWeather",{queryParams:"q="+n}),t.abrupt("return",o);case 7:return t.prev=7,t.t0=t.catch(2),d.log({message:"Getting error while calling WEATHER_SERVICE "+JSON.stringify(t.t0)}),t.abrupt("return",{error:t.t0});case 11:case"end":return t.stop()}}),t,this,[[2,7]])}))),function(t,e){return o.apply(this,arguments)})},{key:"getPolygonsThatContainsLocation",value:function(t,e){var r=this,n=[],o=this._turf.point(t);try{return this._.forEach(e,(function(t){var e=r._turf.polygon(t.coordinates);r._turf.booleanPointInPolygon(o,e)&&n.push(t)})),n}catch(t){throw t}}}],n=[{key:"START_TRACKING",value:function(){return"startTracking"}},{key:"STOP_TRACKING",value:function(){return"stopTracking"}},{key:"VESSEL",value:function(){return"vessel"}},{key:"FLIGHT",value:function(){return"flight"}},{key:"TRACKER_BOT",value:function(){return"tracker-bot"}}],r&&Er(e.prototype,r),n&&Er(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Ir(t){return Ir="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ir(t)}function Tr(){Tr=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Ir(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Ir(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Or(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Cr(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Or(i,n,o,a,s,"next",t)}function s(t){Or(i,n,o,a,s,"throw",t)}a(void 0)}))}}function Lr(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Ir(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Ir(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Ir(o)?o:String(o)),n)}var o}var Pr=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._,this._frontmlib=e.frontmlib}var e,r,n,o,i,a;return e=t,r=[{key:"createNewVerificationCode",value:(a=Cr(Tr().mark((function t(e,r,n,o){var i,a,s,c,u=arguments;return Tr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=!(u.length>4&&void 0!==u[4])||u[4],a=u.length>5&&void 0!==u[5]&&u[5],s=this._state.UUID().substr(0,10),this._.isUndefined(o)&&(o=[]),Array.isArray(o)||(o=[o]),i&&o.push(this._state.conversation.bot),c={codeUsage:{existing:0},domain:this._state.conversation.userDomain,role:e,verificationCode:s,customAction:r,botsToInstall:o,allowAnonValidation:a},n>0&&(c.codeUsage.maximum=n),t.prev=8,t.next=11,this._frontmlib.dbPutItem("DomainVerification",c);case 11:return t.abrupt("return",s);case 14:return t.prev=14,t.t0=t.catch(8),t.abrupt("return",null);case 17:case"end":return t.stop()}}),t,this,[[8,14]])}))),function(t,e,r,n){return a.apply(this,arguments)})},{key:"getVerificationCode",value:(i=Cr(Tr().mark((function t(e){var r;return Tr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this._frontmlib.dbGetWithIndex("DomainVerification","domain-role-index","#domain = :domain AND #role = :role",{":domain":this._state.conversation.userDomain,":role":e},null,{"#domain":"domain","#role":"role"});case 3:return r=t.sent,t.abrupt("return",r.Items[0].verificationCode);case 7:return t.prev=7,t.t0=t.catch(0),t.abrupt("return",null);case 10:case"end":return t.stop()}}),t,this,[[0,7]])}))),function(t){return i.apply(this,arguments)})},{key:"encryptData",value:(o=Cr(Tr().mark((function t(e){var r;return Tr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this._state.cc.getConfigurationForKey("encryptionKey");case 3:return r=t.sent,t.abrupt("return",this._frontmlib.encryptData(r,e));case 7:t.prev=7,t.t0=t.catch(0),this._state.addSystemErrorToStack(31,t.t0.message);case 10:case"end":return t.stop()}}),t,this,[[0,7]])}))),function(t){return o.apply(this,arguments)})},{key:"decryptData",value:(n=Cr(Tr().mark((function t(e){return Tr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.abrupt("return",this._frontmlib.decryptData(e));case 4:t.prev=4,t.t0=t.catch(0),this._state.addSystemErrorToStack(32,t.t0.message);case 7:case"end":return t.stop()}}),t,this,[[0,4]])}))),function(t){return n.apply(this,arguments)})}],r&&Lr(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Dr(t){return Dr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Dr(t)}function Fr(){Fr=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Dr(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Dr(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Ar(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Rr(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Ar(i,n,o,a,s,"next",t)}function s(t){Ar(i,n,o,a,s,"throw",t)}a(void 0)}))}}function Nr(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Dr(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Dr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Dr(o)?o:String(o)),n)}var o}var jr=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._nlpEngine=Et.OPEN_AI,this._nlpAlias="",this._assistantName=e.systemId||t.DEFAULT_ASSISTANT_NAME(),this._nlpIds=[this._assistantName],this._automaticSuggestions=!0}var e,r,n,o,i,a;return e=t,r=[{key:"getKeyForPrompt",value:function(){return"".concat("LLM_CONTEXT_").concat(this._state.conversationId,"_").concat(this._assistantName)}},{key:"clearConversationContext",value:(a=Rr(Fr().mark((function t(){return Fr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._state.db.deleteOneKeyInCache(this.getKeyForPrompt());case 2:case"end":return t.stop()}}),t,this)}))),function(){return a.apply(this,arguments)})},{key:"assistantName",get:function(){return this._assistantName},set:function(t){this._assistantName=t}},{key:"nlpEngine",get:function(){return this._nlpEngine},set:function(t){this._nlpEngine=t}},{key:"nlpIds",get:function(){return this._nlpIds}},{key:"automaticSuggestions",get:function(){return this._automaticSuggestions},set:function(t){this._automaticSuggestions=t}},{key:"addNlp",value:function(t){-1===this._state._.findIndex(this.nlpIds,(function(e){return e===t}))&&this._nlpIds.push(t)}},{key:"nlpAlias",get:function(){return this._nlpAlias},set:function(t){this._nlpAlias=t}},{key:"getNlpParameters",value:function(t){return t}},{key:"runNlpForMessage",value:function(t){var e=this,r=this._state,n=r.developer,o=r._,i=(r.R,this.nlpIds);if(n.info({message:"Starting NLP.js event",data:i}),this.nlpEngine===Et.DIALOGFLOW){if(i.length>0){var a={capability:"NLP2",capabilityFileName:"nlpv2",queryString:t,nlpIds:i,sync:!0,userId:r.user.userId,conversation:r.conversation};return r.callCapability(a).then((function(t){var i=Date.now();o.each(t,(function(t){if(n.info({message:"Response from NLP.js",data:t}),"Invalid NLP.js ID"!==t.error){var i="",a=t.action,s=t.nlpId;n.info({message:"Found NLP.js action: ",data:a}),t.parameters&&o.size(t.parameters)>0&&(i=t.parameters,n.info({message:"Found NLP.js parameters: ",data:i}));var c=[];t.messages&&o.forEach(t.messages,(function(t){4===t.type&&t.payload.messages&&(r.addSmartSuggestionsArray([{lang:r.lang,list:t.payload.messages}]),c=t.payload.messages)})),r.nlpResults[s]={speech:""},t.speech&&""!==t.speech&&(r.nlpResults[s].speech=t.speech),r.nlpResults[s].action=a,r.nlpResults[s].nlpParameters=e.getNlpParameters(i),r.nlpResults[s].nlpSuggestions=c}else r.addSystemErrorToStack(24,t.nlpId)})),n.logCurrentEventDurationWithStartTime("nlpAnalysis",i,Date.now())}))}n.warning({message:"No NLP.js Engine added to the bot"})}return[]}},{key:"addContextPromptsToChat",value:(i=Rr(Fr().mark((function t(e){var r,n,o;return Fr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=this._state.developer,(n=[]).push({role:"system",content:"The name of the user talking with you is ".concat(this._state.user.userName,". Today is ").concat((new Date).toLocaleDateString()," and the current time is ").concat((new Date).toLocaleTimeString(),". The user is running a micro-app called ").concat(this._state.botName," with description and purpose of ").concat(this._state.botDescription,".")}),this._state.client!==yt){t.next=11;break}n.push({role:"system",content:"The user talking to you is connected from a mobile phone using a mobile app called onship. When you give instructions take that in consideration"}),""!==this._state.platform&&n.push({role:"system",content:"The mobile platform that the user is using is ".concat(this._state.platform)}),""!==this._state.osVersion&&n.push({role:"system",content:"The mobile operating system version that the user is using is ".concat(this._state.osVersion)}),""!==this._state.phoneModel&&n.push({role:"system",content:"The mobile phone model that the user is using is ".concat(this._state.phoneModel)}),""!==this._state.brand&&n.push({role:"system",content:"The mobile phone brand that the user is using is ".concat(this._state.brand)}),t.next=16;break;case 11:return t.next=13,this._state.getSystemStaticData(xt.WEB_BROWSER_COMMON_PROMPT);case 13:o=t.sent,r.debug({message:"webBrowserCommonPrompt",data:o}),o&&Array.isArray(o)&&(n=n.concat(o));case 16:return n=n.concat(e),t.abrupt("return",n);case 18:case"end":return t.stop()}}),t,this)}))),function(t){return i.apply(this,arguments)})},{key:"extractObjectFromMessage",value:function(t){try{var e=t.indexOf("{"),r=t.lastIndexOf("}"),n=t.substring(e,r+1);return JSON.parse(n)}catch(t){return!1}}},{key:"formatMarkdownAsHTML",value:function(t){var e=this._state.developer,r=this._state;if(r.marked){var n=new r.marked.Renderer;return n.link=function(t,e,n){return r.marked.Renderer.prototype.link.call(this,t,e,n).replace("<a","<a target='_blank' rel='noopener noreferrer'")},r.marked.setOptions({renderer:n}),r.marked.parse(t)}return e.warning({message:"Marked is not present"}),t}},{key:"getAPIKeyFromParameters",value:function(t){var e="NO_SERVICE";if(t){if(Array.isArray(t))return t[Math.floor(Math.random()*t.length)]||e;if("string"==typeof t)return t}return e}},{key:"callOpenAIWithMessageFromUser",value:(o=Rr(Fr().mark((function e(r){var n,o,i,a,s,c,u,l,h,f,d,p,y,v,m,g,b,_,w,S,k,E,x,I,T,O,C,L,P;return Fr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=r.service,i=void 0===o?It:o,a=r.userPrompt,s=r.role,c=void 0===s?"user":s,this._state._,(u=this._state.developer).debug({message:"Assistant Name",data:this._assistantName}),"string"!=typeof this._state.messageFromUser&&!a&&(null===(n=this._state.messageFromUser)||void 0===n?void 0:n.intentId)!==Tt){e.next=93;break}return l=i===It?xt.DEFAULT_CHAT_NLP_KEY:xt.DEFAULT_NLP_KEY,h=i===It?xt.DEFAULT_CHAT_PROMPT_KEY:xt.DEFAULT_PROMPT_KEY,f=[],d=this._assistantName!==t.DEFAULT_ASSISTANT_NAME()?"".concat(this._assistantName.toLowerCase(),"Prompt"):h,e.next=11,this._state.getStaticData(d,null,!0);case 11:if(e.t1=e.sent,e.t1){e.next=16;break}return e.next=15,this._state.getSystemStaticData(h);case 15:e.t1=e.sent;case 16:if(e.t0=e.t1,e.t0){e.next=19;break}e.t0=[];case 19:return p=e.t0,y=this._assistantName!==t.DEFAULT_ASSISTANT_NAME()?"".concat(this._assistantName.toLowerCase(),"NLP"):l,e.next=23,this._state.getStaticData(y,null,!0);case 23:if(e.t3=e.sent,e.t3){e.next=28;break}return e.next=27,this._state.getSystemStaticData(l);case 27:e.t3=e.sent;case 28:if(e.t2=e.t3,e.t2){e.next=31;break}e.t2={};case 31:if(v=e.t2,i!==It){e.next=49;break}return b={},(null===(m=this._state.messageFromUser)||void 0===m?void 0:m.intentId)===Tt?(b={role:Ct,content:'Generate 3 relevant follow up questions for the content above, impersonating the user, with each question in less than 8 words and in JSON object with the questions within an array identified as "q"'},this._state.addActiveIntent(Tt)):b={role:c,content:a||this._state.messageFromUser},e.next=37,this._state.db.getObjectFromCache(this.getKeyForPrompt());case 37:if(e.t4=e.sent,e.t4){e.next=40;break}e.t4=[];case 40:return f=e.t4,u.debug({message:"Context",data:f}),"string"==typeof f&&(f=[]),e.next=45,this.addContextPromptsToChat(p);case 45:p=e.sent,(null===(g=this._state.messageFromUser)||void 0===g?void 0:g.intentId)!==Tt?(f.push(b),p=p.concat(f)):p=p.concat(b),e.next=50;break;case 49:"string"==typeof p&&(p=p.concat(a));case 50:if(_={body:{model:v.model,messages:p,temperature:v.temperature,max_tokens:v.max_tokens,top_p:v.top_p,frequency_penalty:v.frequency_penalty,presence_penalty:v.presence_penalty,stop:v.stop,user:this._state.user.userId}},u.debug({message:"Call to openAI",data:_}),"NO_SERVICE"===(w=this.getAPIKeyFromParameters(null==v?void 0:v.apiServiceNames))){e.next=93;break}return e.next=56,this._state.api.callService(w,_);case 56:if(E=e.sent,u.debug({message:"Response from openAI",data:E}),x="We are not able to process your message at this time, please try again later",I=null==E||null===(S=E.choices[0])||void 0===S||null===(S=S.message)||void 0===S?void 0:S.content,T="",O=!0,"string"!=typeof I){e.next=69;break}T=(T=(T=(T=I).replace("OnShip","onship")).replace("Onship","onship")).trim(),e.next=75;break;case 69:if(O=!1,T=x,this._state.addSystemErrorToStack(60,null,E),this._state.clearError(),(null===(C=this._state.messageFromUser)||void 0===C?void 0:C.intentId)!==Tt){e.next=75;break}return e.abrupt("return");case 75:if((null===(k=this._state.messageFromUser)||void 0===k?void 0:k.intentId)===Tt){e.next=83;break}if(i!==It){e.next=83;break}return T===x?f.pop():f.push({role:Ct,content:T}),L=null!=v&&v.maxContextLength?v.maxContextLength:20,f.length>L&&f.splice(0,f.length-L),e.next=83,this._state.db.setOneValueInCache(this.getKeyForPrompt(),f);case 83:if(!1!==(P=this.extractObjectFromMessage(T))){e.next=92;break}if(!this._automaticSuggestions||"android"===this._state.platform){e.next=89;break}if(!O){e.next=89;break}return e.next=89,this._state.notification.sendMessageToUserInBot(Le.BOT_TO_BOT(),{intentId:Tt},[this._state.user.userId],this._state.botId,this._state.currentUserDomain,!1,null,!1);case 89:return e.abrupt("return",this.formatMarkdownAsHTML(T));case 92:return e.abrupt("return",P);case 93:case"end":return e.stop()}}),e,this)}))),function(t){return o.apply(this,arguments)})}],n=[{key:"OPEN_AI",value:function(){return"openAI"}},{key:"DEFAULT_ASSISTANT_NAME",value:function(){return"AI"}},{key:"CONVERSATION_CONTEXT_FIELD",value:function(){return"_conversationContextField"}}],r&&Nr(e.prototype,r),n&&Nr(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Mr(t){return Mr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Mr(t)}function Ur(){Ur=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Mr(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Mr(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Br(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Gr(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Br(i,n,o,a,s,"next",t)}function s(t){Br(i,n,o,a,s,"throw",t)}a(void 0)}))}}function qr(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Mr(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Mr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Mr(o)?o:String(o)),n)}var o}var Vr=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._}var e,r,n,o,i,a,s,c,u,l,h,f,d,p,y,v;return e=t,r=[{key:"getBotIDs",value:(v=Gr(Ur().mark((function t(e){var r,n,o,i;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=[{operand:"dataKey",value:e,operator:"eq"}],t.next=3,this._state.db.getStaticData(r);case 3:if(n=t.sent,o=this._.get(n,"items"),!(Array.isArray(o)&&o.length>0)){t.next=9;break}if(i=o[0].value,!(this._.size(i)>0)){t.next=9;break}return t.abrupt("return",i);case 9:case"end":return t.stop()}}),t,this)}))),function(t){return v.apply(this,arguments)})},{key:"loadContactCentreTeam",value:(y=Gr(Ur().mark((function t(e){var r,n;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e){t.next=13;break}return t.prev=1,r="".concat("CONTACT_CENTRE_SHIFT_","_").concat(e,"*"),t.next=6,this._state.db.getKeysOnPattern(r);case 6:return n=t.sent,t.abrupt("return",n);case 10:t.prev=10,t.t0=t.catch(1),state.addSystemErrorToStack(100,"Error reading call centre staff ".concat(this._state.R.toString(t.t0)));case 13:case"end":return t.stop()}}),t,this,[[1,10]])}))),function(t){return y.apply(this,arguments)})},{key:"getTranscriptionForCurrentConversation",value:(p=Gr(Ur().mark((function t(e){var r,n,o;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.epochTime,r=e.bot,n=e.conversation,o={capability:"ArchivedMessagesReader",action:"getPaginatedMessages",conversationId:this._state._.get(n,"conversationId")||this._state.conversationId,bot:r||this._state.conversation.bot,sync:!0,conversation:n||this._state.conversation,capabilityDomain:this._state.currentUserDomain,userEmail:this._state.user.userEmail,userId:this._state.user.userId,userDomain:this._state.userDomains},t.abrupt("return",this._state.callLambda("ArchivedMessagesReader",o,"RequestResponse").then((function(t){return JSON.parse(t.Payload)})));case 3:case"end":return t.stop()}}),t,this)}))),function(t){return p.apply(this,arguments)})},{key:"addEntryToContactCentreQueue",value:(d=Gr(Ur().mark((function e(r,n,o,i){var a,s,c;return Ur().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(a=this._state._.cloneDeep(r)).botDetails=this._state._.cloneDeep(n),a.userId=this._state.user.userId,s={ticket:Math.round(99999998*Math.random()+1),content:a,createdOn:Date.now(),open:!0,status:t.WAITING_STATUS(),botId:o||this._state.conversation.bot,conversationId:this._state.conversationId,userId:this._state.user.userId},c="".concat("CONTACT_CENTRE_","_").concat("open","_").concat(o||this._state.conversation.bot,"_").concat(i||"","_").concat(this._state.conversationId),e.next=10,this._state.db.setOneValueInCacheWithExpiry(c,s,604800);case 10:return e.abrupt("return",s);case 13:e.prev=13,e.t0=e.catch(0),this._state.addSystemErrorToStack(5,"Error adding entry to queue ".concat(e.t0));case 16:case"end":return e.stop()}}),e,this,[[0,13]])}))),function(t,e,r,n){return d.apply(this,arguments)})},{key:"closeEntryInContactCentreQueue",value:(f=Gr(Ur().mark((function t(e,r){var n;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.open=!1,e.owner=this._state.user.userId,n="".concat("CONTACT_CENTRE_","_").concat("open","_").concat(e.botId,"_").concat(r||"","_").concat(e.conversationId),t.next=7,this._state.db.setOneValueInCacheWithExpiry(n,e,604800);case 7:return t.abrupt("return",e);case 8:case"end":return t.stop()}}),t,this)}))),function(t,e){return f.apply(this,arguments)})},{key:"changeQueueEntryStatus",value:(h=Gr(Ur().mark((function t(e,r,n){var o;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.status=r,o="".concat("CONTACT_CENTRE_","_").concat("open","_").concat(e.botId,"_").concat(n||"","_").concat(e.conversationId),t.next=6,this._state.db.setOneValueInCacheWithExpiry(o,e,604800);case 6:return t.abrupt("return",e);case 7:case"end":return t.stop()}}),t,this)}))),function(t,e,r){return h.apply(this,arguments)})},{key:"changeQueueVideoSessionId",value:(l=Gr(Ur().mark((function t(e,r,n){var o;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.content.videoSessionId=r,o="".concat("CONTACT_CENTRE_","_").concat("open","_").concat(e.botId,"_").concat(n||"","_").concat(e.conversationId),t.next=6,this._state.db.setOneValueInCacheWithExpiry(o,e,604800);case 6:return t.abrupt("return",e);case 7:case"end":return t.stop()}}),t,this)}))),function(t,e,r){return l.apply(this,arguments)})},{key:"storeQueueEntry",value:(u=Gr(Ur().mark((function t(e,r){var n;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n="".concat("CONTACT_CENTRE_","_").concat("open","_").concat(e.botId,"_").concat(r||"","_").concat(e.conversationId),t.next=5,this._state.db.setOneValueInCacheWithExpiry(n,e,604800);case 5:return t.abrupt("return",e);case 6:case"end":return t.stop()}}),t,this)}))),function(t,e){return u.apply(this,arguments)})},{key:"loadConversationsInQueue",value:(c=Gr(Ur().mark((function t(e){var r,n,o,i;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=e||this._state.conversation.bot,n="".concat("CONTACT_CENTRE_","_").concat("open","_").concat(r,"*"),t.next=7,this._state.db.getKeysOnPattern(n);case 7:return o=t.sent,i=[],this._state.R,this._state._.forEach(o,(function(t){for(var e=JSON.parse(t.content),r=0;r<i.length&&e.createdOn>i[r].createdOn;)r++;i.splice(r,0,e)})),t.abrupt("return",i);case 14:t.prev=14,t.t0=t.catch(0),this._state.addSystemErrorToStack(100,"Error reading conversations ".concat(this._state.R.toString(t.t0)));case 17:case"end":return t.stop()}}),t,this,[[0,14]])}))),function(t){return c.apply(this,arguments)})},{key:"getQueueEntry",value:(s=Gr(Ur().mark((function t(e){var r,n,o,i,a,s;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.videoSessionId,n=e.botId,o=e.ticket,t.next=3,this.loadConversationsInQueue(n);case 3:for(i=t.sent,a=-1,s=0;s<i.length;s++)(r&&i[s].content.videoSessionId===r||o&&i[s].ticket===o)&&(a=s);return t.abrupt("return",i[a]);case 7:case"end":return t.stop()}}),t,this)}))),function(t){return s.apply(this,arguments)})},{key:"loadConversationsForBot",value:(a=Gr(Ur().mark((function t(e,r,n){var o,i,a,s,c,u;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,o=this._state._.get(r,"size")||6,i=this._state._.get(r,"from")||0,s={duration:{gte:1e4}},(a={_source:["conversationId","createdOn","modifiedOn","duration"],query:{bool:{must:{term:{bot:e}}}},sort:{createdOn:{order:"desc"}},size:o}).query.bool.filter=0===i?{range:s}:[{range:s},{range:{createdOn:{lt:i}}}],t.next=8,this._state.db.getDataFromIndexWithQueryObject(DB.CONVERSATIONS_INDEX(),a);case 8:return c=t.sent,u=[],this._state._.forEach(c,(function(t){u.push(t)})),t.abrupt("return",u);case 14:t.prev=14,t.t0=t.catch(0),this._state.addSystemErrorToStack(100,"Error reading conversations ".concat(this._state.R.toString(t.t0)));case 17:case"end":return t.stop()}}),t,this,[[0,14]])}))),function(t,e,r){return a.apply(this,arguments)})},{key:"loadConversationData",value:(i=Gr(Ur().mark((function t(e){var r;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=[{operand:"conversationId",value:e,operator:"eq"}],t.abrupt("return",this._state.db.getData("Conversations",r));case 6:t.prev=6,t.t0=t.catch(0),this._state.addSystemErrorToStack(100,"Error reading conversations ".concat(this._state.R.toString(t.t0)));case 9:case"end":return t.stop()}}),t,this,[[0,6]])}))),function(t){return i.apply(this,arguments)})},{key:"getConfigurationForKey",value:(o=Gr(Ur().mark((function t(e){var r,n,o,i,a,s=this;return Ur().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=[{operand:"dataKey",value:e,operator:"eq"}],n=function(t){var e=s._state._.get(t,"items");if(Array.isArray(e)&&e.length>0)return e[0].value},o="staticData",!(this._state.location===bt||this._state.client===vt||this._state.location===gt&&this._state.v1Compatibility)){t.next=11;break}return t.next=6,this._state.db.getStaticData(r);case 6:return i=t.sent,this._state.addObjectToSyncMessage(o,e,i),t.abrupt("return",n(i));case 11:return this._state.developer.log({message:"Reading from local"}),t.next=14,this._state.deviceStorage.loadDocument(o,this._state.sha1(e));case 14:return a=t.sent,t.abrupt("return",n(a));case 16:case"end":return t.stop()}}),t,this)}))),function(t){return o.apply(this,arguments)})}],n=[{key:"WAITING_STATUS",value:function(){return"Waiting"}},{key:"WAITING_VESSEL_STATUS",value:function(){return"WaitingVessel"}},{key:"ACTIVE_STATUS",value:function(){return"Active"}},{key:"ENDED_STATUS",value:function(){return"Ended"}},{key:"MISSED_STATUS",value:function(){return"Missed"}},{key:"MISSED_CALL_TEXT",value:function(){return"Missed call"}},{key:"CONTACT_CENTRE_APP",value:function(){return"callCentreBot"}},{key:"CLIENT_APP",value:function(){return"clientBot"}},{key:"MANAGER_APP",value:function(){return"shiftManagerBot"}}],r&&qr(e.prototype,r),n&&qr(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Kr(t){return Kr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Kr(t)}function Yr(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Kr(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Kr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Kr(o)?o:String(o)),n)}var o}var Wr=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._}var e,r;return e=t,(r=[{key:"callCreateCompanyCapability",value:function(t){return this._state.context.capabilities.capabilities[t.capabilityFileName].execute(t,this._state.context.capabilities)}},{key:"createChildCompany",value:function(t){var e=this,r=t.companyAddress,n=t.companyName,o=t.phoneNumbers,i=t.contractDuration,a=t.account,s=this._state.getUniqueId(),c={capability:"CompanyCapability",capabilityFileName:"companyCapability",sync:!0,userId:this._state.user.userId,conversation:this._state.conversation,action:"createCompany",company:{companyAddress:r,companyId:s,companyName:n,phoneNumbers:o,contractDuration:i,account:a},companyDomain:{userDomain:this._state.currentUserDomain}};return this.callCreateCompanyCapability(c).then((function(t){return e._state.developer.info({message:"After created company",data:t}),e._.get(t,"status")?{status:!0,companyId:s}:{status:!1,errorMessage:e._.get(e._state._.compact(t),"errorMessage","There was a problem creating the company")}}))}},{key:"addOfferToCompany",value:function(t){var e=this,r=t.companyId,n=t.verificationCode,o=t.validFrom,i=t.validTo,a=t.maxUsersPerLicense,s=t.offers,c=t.offerType,u=t.description,l=t.role,h={capability:"CompanyCapability",capabilityFileName:"companyCapability",sync:!0,userId:this._state.user.userId,conversation:this._state.conversation,action:"createCompany",company:{companyId:r},companyDomain:{userDomain:this._state.currentUserDomain},userOffers:[{verificationCode:n,offerType:c,description:u,role:l,valid_from:o,valid_to:i,codeUsage:{maximum:a},offers:s}]};return this.callCreateCompanyCapability(h).then((function(t){return e._state.developer.info({message:"After added offer to company",data:t}),e._.get(t,"status")?{status:!0,companyId:r}:{status:!1,errorMessage:e._.get(e._state._.compact(t),"errorMessage","There was a problem creating the company")}}))}}])&&Yr(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function zr(t){return zr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},zr(t)}function Hr(){Hr=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==zr(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(zr(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Qr(t){return function(t){if(Array.isArray(t))return Xr(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||$r(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Jr(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=$r(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw i}}}}function $r(t,e){if(t){if("string"==typeof t)return Xr(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Xr(t,e):void 0}}function Xr(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function Zr(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function tn(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Zr(i,n,o,a,s,"next",t)}function s(t){Zr(i,n,o,a,s,"throw",t)}a(void 0)}))}}function en(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==zr(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==zr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===zr(o)?o:String(o)),n)}var o}var rn=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this._=e._;var r;r=e.context.capabilities.capabilities?e.context.capabilities:e.context,this._context=r,this.userId=e.user.userId,this.conversation=e.conversation,this.location=e.location}var e,r,n,o,i,a,s,c,u,l,h,f,d,p,y,v,m,g,b,_,w,S,k,E;return e=t,r=[{key:"_validateResources",value:function(t){var e=t.domain,r=t.resourceName,n=t.resourceId,o=t.resourceType,i=t.resourceSubType,a=t.availStartTime,s=t.availEndTime,c=t.dailyStartTime,u=t.dailyEndTime,l=t.weeklyOffDays,h=t.adhocOffTime;return!(!(e&&r&&n&&o&&i&&a&&s)||a>=s||c&&c<0||u&&u>24||l&&!Array.isArray(l)||h&&!Array.isArray(h))}},{key:"_getWeekdaysBetweenDates",value:function(t,e,r){var n=this._context.momentTimeZone,o=n.tz(t,r),i=n.tz(e,r).diff(o,"days");if(i>=7)return n.weekdays();for(var a=o.day(),s=[],c=0;c<=i;c++)s.push(n.weekdays((a+c)%7));return s}},{key:"_extractTimeDetails",value:function(t,e,r){var n=r||"GMT +00:00 (Etc/GMT)",o=n?n.split("(")[1].substring(0,n.split("(")[1].length-1):"Etc/GMT",i=this._context,a=(i.moment,i.momentTimeZone);return{reqStartHrs:a.tz(t,o).hours(),reqEndHrs:a.tz(e,o).hours(),reqIsMultiDay:!a.tz(t,o).isSame(a.tz(e,o),"day"),reqWeekDays:this._getWeekdaysBetweenDates(t,e,o)}}},{key:"_checkAdhocOffTime",value:function(t,e,r){var n=this._,o=!1;return!t||!Array.isArray(t)||t.length<1||n.forEach(t,(function(t){return e>t.endTime||r<t.startTime||(o=!0,!1)})),o}},{key:"_checkConflictingBookings",value:(E=tn(Hr().mark((function e(r,n,o,i){var a,s,c,u,l,h,f,d,p,y,v,m,g;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this._,s=!1,r&&n&&o){e.next=4;break}return e.abrupt("return",s);case 4:if(c=[],u=[],!i||!i.length){e.next=27;break}l=Jr(i),e.prev=8,l.s();case 10:if((h=l.n()).done){e.next=18;break}return f=h.value,e.next=14,this._state.db.getDataFromCollection({collection:t.SCHD_DETAIL_DB(),action:"query",query:{_id:f},projection:{},sort:{},skip:0,limit:1,collation:{},expectOneResult:!1,cache:!1});case 14:(d=e.sent)&&200===d.statusCode&&d.body&&d.body.length&&c.push(d.body[0]);case 16:e.next=10;break;case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(8),l.e(e.t0);case 23:return e.prev=23,l.f(),e.finish(23);case 26:u=c.map((function(t){return{$and:[{bookedStartTime:{$eq:t.bookedStartTime}},{bookedEndTime:{$eq:t.bookedEndTime}}]}}));case 27:return p=[{$and:[{bookedStartTime:{$lte:n}},{bookedEndTime:{$gt:n}}]},{$and:[{bookedStartTime:{$lt:o}},{bookedEndTime:{$gt:o}}]},{$and:[{bookedStartTime:{$gt:n}},{bookedEndTime:{$lte:o}}]}],y={$and:[{origId:r},{$or:[].concat(Qr(u),p)}]},e.next=31,this._state.db.getDataFromCollection({collection:t.SCHD_DETAIL_DB(),action:"query",query:y,projection:{},sort:{},skip:0,limit:1,collation:{},expectOneResult:!1,cache:!1});case 31:return 200===(v=e.sent).statusCode&&v.body&&Array.isArray(v.body)?(m=v.body,g=[],m.map((function(t){-1===i.indexOf(t._id)&&g.push(t)})),s=a.size(g)>0):s=!0,e.abrupt("return",s);case 34:case"end":return e.stop()}}),e,this,[[8,20,23,26]])}))),function(t,e,r,n){return E.apply(this,arguments)})},{key:"_filterQueriedResources",value:(k=tn(Hr().mark((function t(e,r,n,o){var i,a,s,c,u,l,h,f,d,p,y,v,m,g,b;return Hr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=this._,a=[],e&&Array.isArray(e)&&!(e.length<1)){t.next=4;break}return t.abrupt("return",a);case 4:if(!(r>=n)){t.next=6;break}return t.abrupt("return",a);case 6:s=this._extractTimeDetails(r,n,e[0].resourceTimezone),c=s.reqStartHrs,u=s.reqEndHrs,l=s.reqIsMultiDay,h=s.reqWeekDays,this._state.developer.log({message:"From Schedules, extractTimeDetails resp",data:{reqStartHrs:c,reqEndHrs:u,reqIsMultiDay:l,reqWeekDays:h}}),f=Jr(e),t.prev=9,f.s();case 11:if((d=f.n()).done){t.next=36;break}if(p=d.value,y=p.id,v=p.dailyStartTime,m=p.dailyEndTime,g=p.weeklyOffDays,b=p.adhocOffTime,c>=v){t.next=17;break}return t.abrupt("return");case 17:if(u<=m){t.next=20;break}return t.abrupt("return");case 20:if(i.intersection(h,g),!(i.size(i.intersection(h,g))>0)){t.next=23;break}return t.abrupt("return");case 23:if(!l||0===v&&24===m){t.next=26;break}return t.abrupt("return");case 26:if(!this._checkAdhocOffTime(b,r,n)){t.next=28;break}return t.abrupt("return");case 28:return t.next=30,this._checkConflictingBookings(y,r,n,o);case 30:if(!t.sent){t.next=33;break}return t.abrupt("return");case 33:a.push(p);case 34:t.next=11;break;case 36:t.next=41;break;case 38:t.prev=38,t.t0=t.catch(9),f.e(t.t0);case 41:return t.prev=41,f.f(),t.finish(41);case 44:return t.abrupt("return",a);case 45:case"end":return t.stop()}}),t,this,[[9,38,41,44]])}))),function(t,e,r,n){return k.apply(this,arguments)})},{key:"createSingleResource",value:(S=tn(Hr().mark((function e(r){var n,o;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._state.developer.log({message:"From Schedules, createSingleRes with",data:r}),n={},!this._validateResources(r)){e.next=30;break}return n.id=this._state.getUniqueId(),n.domain=r.domain,n.resourceId=r.resourceId,n.resourceName=r.resourceName,n.resourceType=r.resourceType,n.resourceSubType=r.resourceSubType,n.availStartTime=r.availStartTime,n.availEndTime=r.availEndTime,n.dailyStartTime=parseInt(r.dailyStartTime)||0,n.dailyEndTime=parseInt(r.dailyEndTime)||24,n.weeklyOffDays=r.weeklyOffDays||[],n.adhocOffTime=r.adhocOffTime||[],n.resourceTimezone=r.resourceTimezone||"GMT +00:00 (Etc/GMT)",n.multiTask=r.multiTask,n.availableStatus=r.availableStatus,e.next=21,this._state.db.insertDocumentInCollection({collection:t.SCHD_MASTER_DB(),document:n,audit:!1,sync:!1});case 21:if(200!==(o=e.sent).statusCode||"success"!==o.body){e.next=26;break}return e.abrupt("return",{status:"success",newId:n.id});case 26:return this._state.developer.log({message:"From Schedules Class Create ERROR",data:o}),e.abrupt("return",{status:"error",newId:void 0});case 28:e.next=32;break;case 30:return this._state.developer.log({message:"From Schedules Class Create ERROR",data:"Incomplete details"}),e.abrupt("return",{status:"error",newId:void 0});case 32:case"end":return e.stop()}}),e,this)}))),function(t){return S.apply(this,arguments)})},{key:"updateSingleResource",value:(w=tn(Hr().mark((function e(r){var n,o,i,a;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n={},!this._validateResources(r)||!r.id){e.next=31;break}return n.id=r.id,n.domain=r.domain,n.resourceId=r.resourceId,n.resourceName=r.resourceName,n.resourceType=r.resourceType,n.resourceSubType=r.resourceSubType,n.availStartTime=r.availStartTime,n.availEndTime=r.availEndTime,n.dailyStartTime=parseInt(r.dailyStartTime)||0,n.dailyEndTime=parseInt(r.dailyEndTime)||24,n.weeklyOffDays=r.weeklyOffDays||[],n.adhocOffTime=r.adhocOffTime||[],n.multiTask=r.multiTask,n.availableStatus=r.availableStatus,n.resourceTimezone=r.resourceTimezone,o={id:r.id},i={upsert:!0},e.next=22,this._state.db.updateDataInCollection({collection:t.SCHD_MASTER_DB(),document:n,query:o,options:i,audit:!1,sync:!1});case 22:if(200!==(a=e.sent).statusCode||"success"!==a.body){e.next=27;break}return e.abrupt("return",!0);case 27:return this._state.developer.log({message:"From Schedules Class Update ERROR",data:a}),e.abrupt("return",!1);case 29:e.next=33;break;case 31:return this._state.developer.log({message:"From Schedules Class Update ERROR",data:"Incomplete details"}),e.abrupt("return",!1);case 33:case"end":return e.stop()}}),e,this)}))),function(t){return w.apply(this,arguments)})},{key:"deleteSingleResource",value:(_=tn(Hr().mark((function e(r){var n,o;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}return e.abrupt("return",!1);case 2:return n={id:r},e.next=5,this._state.db.deleteDataFromCollection({collection:t.SCHD_MASTER_DB(),query:n,audit:!1,sync:!1});case 5:if(200!==(o=e.sent).statusCode||"success"!==o.body){e.next=10;break}return e.abrupt("return",!0);case 10:return this._state.developer.log({message:"From Schedules Class Delete ERROR",data:o}),e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,this)}))),function(t){return _.apply(this,arguments)})},{key:"createRecurringResource",value:(b=tn(Hr().mark((function t(){return Hr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),function(){return b.apply(this,arguments)})},{key:"updateRecurringResource",value:(g=tn(Hr().mark((function t(){return Hr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),function(){return g.apply(this,arguments)})},{key:"deleteRecurringResource",value:(m=tn(Hr().mark((function t(){return Hr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),function(){return m.apply(this,arguments)})},{key:"searchResourcesByInterval",value:(v=tn(Hr().mark((function e(r,n){var o,i,a,s;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._state.developer.log({message:"From Schedules, searchResourcesByInterval with",data:{startTime:r,endTime:n}}),!(r>=n)){e.next=3;break}return e.abrupt("return",[]);case 3:return o={availStartTime:{$lte:r},availEndTime:{$gte:n},availableStatus:!0},i={availStartTime:1},this._state.developer.log({message:"From Schedules Class searchResourcesByInterval QUERY",data:o}),e.next=8,this._state.db.getDataFromCollection({collection:t.SCHD_MASTER_DB(),action:"query",query:o,projection:{},sort:i,skip:0,limit:999,collation:{},expectOneResult:!1,cache:!1});case 8:if(a=e.sent,this._state.developer.log({message:"From Schedules Class searchResourcesByInterval RESP",data:a}),!(200===a.statusCode&&a.body&&Array.isArray(a.body)&&a.body.length>0)){e.next=17;break}return e.next=13,this._filterQueriedResources(a.body,r,n);case 13:return s=e.sent,e.abrupt("return",s);case 17:return e.abrupt("return",[]);case 18:case"end":return e.stop()}}),e,this)}))),function(t,e){return v.apply(this,arguments)})},{key:"searchResourcesByIntervalByType",value:(y=tn(Hr().mark((function e(r,n,o){var i,a,s,c;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._state.developer.log({message:"From Schedules, searchResourcesByIntervalByType with",data:{resType:r,startTime:n,endTime:o}}),!(n>=o)&&r){e.next=3;break}return e.abrupt("return",[]);case 3:return i={resourceType:r,availStartTime:{$lte:n},availEndTime:{$gte:o},availableStatus:!0},a={availStartTime:1},this._state.developer.log({message:"From Schedules Class searchResourcesByIntervalByType QUERY",data:i}),e.next=8,this._state.db.getDataFromCollection({collection:t.SCHD_MASTER_DB(),action:"query",query:i,projection:{},sort:a,skip:0,limit:999,collation:{},expectOneResult:!1,cache:!1});case 8:if(!(200===(s=e.sent).statusCode&&s.body&&Array.isArray(s.body)&&s.body.length>0)){e.next=16;break}return e.next=12,this._filterQueriedResources(s.body,n,o);case 12:return c=e.sent,e.abrupt("return",c);case 16:return e.abrupt("return",[]);case 17:case"end":return e.stop()}}),e,this)}))),function(t,e,r){return y.apply(this,arguments)})},{key:"searchResourcesByIntervalBySubType",value:(p=tn(Hr().mark((function e(r,n,o){var i,a,s,c;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._state.developer.log({message:"From Schedules, searchResourcesByIntervalBySubType with",data:{resSubType:r,startTime:n,endTime:o}}),!(n>=o)&&r){e.next=3;break}return e.abrupt("return",[]);case 3:return i={resourceSubType:r,availStartTime:{$lte:n},availEndTime:{$gte:o},availableStatus:!0},a={availStartTime:1},e.next=7,this._state.db.getDataFromCollection({collection:t.SCHD_MASTER_DB(),action:"query",query:i,projection:{},sort:a,skip:0,limit:999,collation:{},expectOneResult:!1,cache:!1});case 7:if(s=e.sent,this._state.developer.log({message:"From Schedules Class searchResourcesByIntervalBySubType RESP",data:s}),!(200===s.statusCode&&s.body&&Array.isArray(s.body)&&s.body.length>0)){e.next=16;break}return e.next=12,this._filterQueriedResources(s.body,n,o);case 12:return c=e.sent,e.abrupt("return",c);case 16:return e.abrupt("return",[]);case 17:case"end":return e.stop()}}),e,this)}))),function(t,e,r){return p.apply(this,arguments)})},{key:"searchResourcesByIntervalByResId",value:(d=tn(Hr().mark((function e(r,n,o,i){var a,s,c,u;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n>=o)&&r){e.next=2;break}return e.abrupt("return",[]);case 2:return e.next=4,this._checkConflictingBookings(r,n,o,i);case 4:if(!e.sent){e.next=7;break}return e.abrupt("return",null);case 7:return a={resourceId:r,availStartTime:{$lte:n},availEndTime:{$gte:o},availableStatus:!0},s={availStartTime:1},e.next=11,this._state.db.getDataFromCollection({collection:t.SCHD_MASTER_DB(),action:"query",query:a,projection:{},sort:s,skip:0,limit:999,collation:{},expectOneResult:!1,cache:!1});case 11:if(!(200===(c=e.sent).statusCode&&c.body&&Array.isArray(c.body)&&c.body.length>0)){e.next=19;break}return e.next=15,this._filterQueriedResources(c.body,n,o,i);case 15:return u=e.sent,e.abrupt("return",u);case 19:return e.abrupt("return",[]);case 20:case"end":return e.stop()}}),e,this)}))),function(t,e,r,n){return d.apply(this,arguments)})},{key:"searchResourcesByIntervalByTypeSubType",value:(f=tn(Hr().mark((function e(r,n,o,i){var a,s,c,u;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._state.developer.log({message:"From Schedules, searchResourcesByIntervalByTypeSubType with",data:{resType:r,resSubType:n,startTime:o,endTime:i}}),!(o>=i)&&r&&n){e.next=3;break}return e.abrupt("return",[]);case 3:return a={resourceType:r,resourceSubType:n,availStartTime:{$lte:o},availEndTime:{$gte:i},availableStatus:!0},s={availStartTime:1},this._state.developer.log({message:"From Schedules Class searchResourcesByIntervalByTypeSubType QUERY",data:a}),e.next=8,this._state.db.getDataFromCollection({collection:t.SCHD_MASTER_DB(),action:"query",query:a,projection:{},sort:s,skip:0,limit:999,collation:{},expectOneResult:!1,cache:!1});case 8:if(c=e.sent,this._state.developer.log({message:"From Schedules Class searchResourcesByIntervalByTypeSubType RESP",data:c}),!(200===c.statusCode&&c.body&&Array.isArray(c.body)&&c.body.length>0)){e.next=17;break}return e.next=13,this._filterQueriedResources(c.body,o,i);case 13:return u=e.sent,e.abrupt("return",u);case 17:return e.abrupt("return",[]);case 18:case"end":return e.stop()}}),e,this)}))),function(t,e,r,n){return f.apply(this,arguments)})},{key:"searchResourcesByIntervalByTypeSubTypeResId",value:(h=tn(Hr().mark((function e(r,n,o,i,a){var s,c,u,l;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i>=a)&&r&&n&&o){e.next=2;break}return e.abrupt("return",[]);case 2:return s={resourceType:r,resourceSubType:n,resourceId:o,availStartTime:{$lte:i},availEndTime:{$gte:a},availableStatus:!0},c={availStartTime:1},e.next=6,this._state.db.getDataFromCollection({collection:t.SCHD_MASTER_DB(),action:"query",query:s,projection:{},sort:c,skip:0,limit:999,collation:{},expectOneResult:!1,cache:!1});case 6:if(!(200===(u=e.sent).statusCode&&u.body&&Array.isArray(u.body)&&u.body.length>0)){e.next=14;break}return e.next=10,this._filterQueriedResources(u.body,i,a);case 10:return l=e.sent,e.abrupt("return",l);case 14:return e.abrupt("return",[]);case 15:case"end":return e.stop()}}),e,this)}))),function(t,e,r,n,o){return h.apply(this,arguments)})},{key:"searchResourcesByEventId",value:(l=tn(Hr().mark((function e(r){var n,o,i;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._state.developer.log({message:"From Schedules, searchResourcesByEventId with",data:r}),r&&""!==r){e.next=3;break}return e.abrupt("return",[]);case 3:return n={eventId:r},o={availStartTime:1},this._state.developer.log({message:"From Schedules Class searchResourcesByEventId QUERY",data:n}),e.next=8,this._state.db.getDataFromCollection({collection:t.SCHD_DETAIL_DB(),action:"query",query:n,projection:{},sort:o,skip:0,limit:999,collation:{},expectOneResult:!1,cache:!1});case 8:if(i=e.sent,this._state.developer.log({message:"From Schedules Class searchResourcesByEventId RESP",data:i}),!(200===i.statusCode&&i.body&&Array.isArray(i.body)&&i.body.length>0)){e.next=14;break}return e.abrupt("return",i.body);case 14:return e.abrupt("return",[]);case 15:case"end":return e.stop()}}),e,this)}))),function(t){return l.apply(this,arguments)})},{key:"searchResourcesByIds",value:(u=tn(Hr().mark((function e(r){var n,o,i;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._state.developer.log({message:"From Schedules, searchResourcesByIds with",data:r}),r){e.next=3;break}return e.abrupt("return",[]);case 3:if(!((Array.isArray(r)?r:[r]).length<1)){e.next=6;break}return e.abrupt("return",[]);case 6:return n={resourceId:{$in:r},availableStatus:!0},o={availStartTime:1},this._state.developer.log({message:"From Schedules Class searchResourcesByInterval QUERY",data:n}),e.next=11,this._state.db.getDataFromCollection({collection:t.SCHD_MASTER_DB(),action:"query",query:n,projection:{},sort:o,skip:0,limit:999,collation:{},expectOneResult:!1,cache:!1});case 11:if(i=e.sent,this._state.developer.log({message:"From Schedules Class searchResourcesByIds RESP",data:i}),!(200===i.statusCode&&i.body&&Array.isArray(i.body)&&i.body.length>0)){e.next=17;break}return e.abrupt("return",i.body);case 17:return e.abrupt("return",[]);case 18:case"end":return e.stop()}}),e,this)}))),function(t){return u.apply(this,arguments)})},{key:"searchResourcesByResIdEventId",value:(c=tn(Hr().mark((function e(r,n){var o,i,a;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._state.developer.log({message:"From Schedules, searchResourcesByResIdEventId with",data:{eventId:r,resId:n}}),r&&""!==r&&n&&""!==n){e.next=3;break}return e.abrupt("return",[]);case 3:return o={origId:n,eventId:r},i={availStartTime:1},this._state.developer.log({message:"From Schedules Class searchResourcesByResIdEventId QUERY",data:o}),e.next=8,this._state.db.getDataFromCollection({collection:t.SCHD_DETAIL_DB(),action:"query",query:o,projection:{},sort:i,skip:0,limit:999,collation:{},expectOneResult:!1,cache:!1});case 8:if(a=e.sent,this._state.developer.log({message:"From Schedules Class searchResourcesByResIdEventId RESP",data:a}),!(200===a.statusCode&&a.body&&Array.isArray(a.body)&&a.body.length>0)){e.next=14;break}return e.abrupt("return",a.body);case 14:return e.abrupt("return",[]);case 15:case"end":return e.stop()}}),e,this)}))),function(t,e){return c.apply(this,arguments)})},{key:"getAvailableTimeSlots",value:(s=tn(Hr().mark((function e(r,n,o,i,a){var s,c,u,l,h;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this._state,c=s._,r&&n&&o&&i){e.next=4;break}return e.abrupt("return",[]);case 4:return e.next=6,s.db.getDataFromCollection({collection:t.SCHD_DETAIL_DB(),query:{origId:r,bookedStartTime:{$gte:o},bookedEndTime:{$lte:i}},projection:{projection:{bookedStartTime:1,bookedEndTime:1}}});case 6:u=e.sent,u=c.get(u,"body",[]),l=[],h=Hr().mark((function t(){var e,r;return Hr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=!1,r=o+n,c.forEach(u,(function(t){var n=t.bookedStartTime<=o&&t.bookedEndTime>o,i=t.bookedStartTime<r&&t.bookedEndTime>r,a=o<t.bookedStartTime&&r>=t.bookedEndTime;(n||i||a)&&(e=!0)})),e||l.push({start:o,end:o+n}),o+=n;case 5:case"end":return t.stop()}}),t)}));case 10:if(!(i-o>=n)){e.next=14;break}return e.delegateYield(h(),"t0",12);case 12:e.next=10;break;case 14:return e.abrupt("return",l);case 15:case"end":return e.stop()}}),e,this)}))),function(t,e,r,n,o){return s.apply(this,arguments)})},{key:"blockResource",value:(a=tn(Hr().mark((function e(r,n,o,i){var a,s,c,u,l,h,f;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=Array.isArray(r)?r:[r],a=Qr(new Set(a)),!(n>=o||a.length<1)){e.next=4;break}return e.abrupt("return",!1);case 4:s=[],c=0;case 6:if(!(c<a.length)){e.next=28;break}return u=a[c],l={},e.next=11,this._checkConflictingBookings(u,n,o);case 11:if(!e.sent){e.next=16;break}return l[u]=void 0,s.push(l),e.abrupt("continue",25);case 16:return(h={})._id=this._state.getUniqueId(),h.origId=u,h.bookedStartTime=n,h.bookedEndTime=o,h.eventId=i,e.next=22,this._state.db.insertDocumentInCollection({collection:t.SCHD_DETAIL_DB(),document:h,audit:!1,sync:!1});case 22:200===(f=e.sent).statusCode&&"success"===f.body?l[u]=h._id:l[u]=void 0,s.push(l);case 25:c++,e.next=6;break;case 28:return e.abrupt("return",s);case 29:case"end":return e.stop()}}),e,this)}))),function(t,e,r,n){return a.apply(this,arguments)})},{key:"_internalUnblocker",value:(i=tn(Hr().mark((function e(r){var n,o;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._state.developer.log({message:"From Schedules, _internalUnblocker with",data:r}),n={_id:r},e.next=4,this._state.db.deleteDataFromCollection({collection:t.SCHD_DETAIL_DB(),query:n,audit:!1,sync:!1});case 4:if(200!==(o=e.sent).statusCode||"success"!==o.body){e.next=10;break}return this._state.developer.log({message:"From Schedules Class _internalUnblocker success",data:o}),e.abrupt("return",{result:"success",msg:"Resource released"});case 10:return this._state.developer.log({message:"From Schedules Class _internalUnblocker ERROR",data:o}),e.abrupt("return",{result:"error",msg:"Resource was not released"});case 12:case"end":return e.stop()}}),e,this)}))),function(t){return i.apply(this,arguments)})},{key:"unBlockResource",value:(o=tn(Hr().mark((function t(e){var r,n,o,i,a;return Hr().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._state.developer.log({message:"From Schedules, unBlockResource with",data:{resIdArrayIn:e}}),r=[],n=Array.isArray(e)?e:[e],!((n=Qr(new Set(n))).length<1)){t.next=6;break}return t.abrupt("return",!1);case 6:o=0;case 7:if(!(o<n.length)){t.next=17;break}return i=n[o],a={},t.next=12,this._internalUnblocker(i);case 12:a[i]=t.sent,r.push(a);case 14:o++,t.next=7;break;case 17:return this._state.developer.log({message:"From Schedules, unBlockResource final",data:r}),t.abrupt("return",r);case 19:case"end":return t.stop()}}),t,this)}))),function(t){return o.apply(this,arguments)})}],n=[{key:"SCHD_INDEX",value:function(){return"scheduler"}},{key:"SCHD_MASTER_DB",value:function(){return"schedulerMaster"}},{key:"SCHD_DETAIL_DB",value:function(){return"schedulerDetail"}}],r&&en(e.prototype,r),n&&en(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function nn(t){return nn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},nn(t)}function on(){on=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==nn(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(nn(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function an(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function sn(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){an(i,n,o,a,s,"next",t)}function s(t){an(i,n,o,a,s,"throw",t)}a(void 0)}))}}function cn(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==nn(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==nn(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===nn(o)?o:String(o)),n)}var o}var un=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._state=e,this.botContext=e.context,this._state.developer;try{this.deviceStorageCapability=this.botContext.getCapability("DeviceStorage"),this.sha1=e.context.getCapability("sha1")}catch(t){console.log("Problems creating device storage")}}var e,r,n,o,i,a;return e=t,r=[{key:"getKeyFromStorage",value:function(t){return this.deviceStorageCapability.get(t).then((function(t){return t}))}},{key:"saveKeyInStorage",value:function(t,e){return this.deviceStorageCapability.save(t,e)}},{key:"removeKeyFromStorage",value:function(t){return this.deviceStorageCapability.delete(t)}},{key:"getStateForConversation",value:function(t){if(t)return this.getKeyFromStorage.get(t)}},{key:"saveConversationState",value:function(t){if(t)return this.saveKeyInStorage(t.conversationId,t)}},{key:"saveDocument",value:(a=sn(on().mark((function t(e,r,n){var o,i,a,s,c;return on().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return o=this._state._,this._state.developer,i="".concat(e,"_").concat(r),a="Collection_".concat(e),t.next=6,this.getKeyFromStorage(a);case 6:if(t.t0=t.sent,t.t0){t.next=9;break}t.t0=[];case 9:if(s=t.t0,(c=o.findIndex(s,(function(t){return t===i})))>-1&&s.splice(c,1),s.push(i),!(s.length>10)){t.next=17;break}return s.splice(0,1),t.next=17,this.removeKeyFromStorage(i);case 17:return t.next=19,this.saveKeyInStorage(a,s);case 19:return t.next=21,this.saveKeyInStorage(i,n);case 21:case"end":return t.stop()}}),t,this)}))),function(t,e,r){return a.apply(this,arguments)})},{key:"deleteDocument",value:(i=sn(on().mark((function t(e,r){var n,o,i,a,s;return on().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=this._state._,this._state.developer,o="".concat(e,"_").concat(r),i="Collection_".concat(e),t.next=6,this.getKeyFromStorage(i);case 6:if(t.t0=t.sent,t.t0){t.next=9;break}t.t0=[];case 9:return a=t.t0,(s=n.findIndex(a,(function(t){return t===o})))>-1&&a.splice(s,1),t.next=14,this.saveKeyInStorage(i,a);case 14:return t.next=16,this.removeKeyFromStorage(o);case 16:case"end":return t.stop()}}),t,this)}))),function(t,e){return i.apply(this,arguments)})},{key:"loadDocument",value:(o=sn(on().mark((function t(e,r){var n,o;return on().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,this._state._,n="".concat(e,"_").concat(r),t.next=5,this.getKeyFromStorage(n);case 5:return o=t.sent,t.abrupt("return",o);case 9:t.prev=9,t.t0=t.catch(0),console.log("DeviceStorage class error: Error stringifying primary key");case 12:case"end":return t.stop()}}),t,this,[[0,9]])}))),function(t,e){return o.apply(this,arguments)})},{key:"queryCollection",value:(n=sn(on().mark((function t(e,r){var n,o,i,a,s,c,u,l,h;return on().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,n=this._state._,this._state.developer,!r){t.next=13;break}return r="".concat(e,"_").concat(r),t.next=7,this.getKeyFromStorage(r);case 7:if(!(o=t.sent)){t.next=12;break}return t.abrupt("return",o);case 12:return t.abrupt("return",{statusCode:200,body:[]});case 13:return i="Collection_".concat(e),t.next=16,this.getKeyFromStorage(i);case 16:if(t.t0=t.sent,t.t0){t.next=19;break}t.t0=[];case 19:a=t.t0,s=[],c=0;case 22:if(!(c<a.length)){t.next=32;break}return u=a[c],t.next=26,this.getKeyFromStorage(u);case 26:l=t.sent,(h=n.get(l,"body"))&&(s=s.concat(h));case 29:c++,t.next=22;break;case 32:return t.abrupt("return",{statusCode:200,body:s});case 35:t.prev=35,t.t1=t.catch(0),console.log("DeviceStorage class error: Error stringifying primary key");case 38:case"end":return t.stop()}}),t,this,[[0,35]])}))),function(t,e){return n.apply(this,arguments)})}],r&&cn(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function ln(t){return ln="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ln(t)}function hn(){hn=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==ln(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(ln(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function fn(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function dn(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){fn(i,n,o,a,s,"next",t)}function s(t){fn(i,n,o,a,s,"throw",t)}a(void 0)}))}}function pn(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,bn(n.key),n)}}function yn(t,e){return yn=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},yn(t,e)}function vn(t,e){if(e&&("object"===ln(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return mn(t)}function mn(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function gn(t){return gn=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},gn(t)}function bn(t){var e=function(t,e){if("object"!==ln(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==ln(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===ln(e)?e:String(e)}var _n=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&yn(t,e)}(s,t);var e,r,n,o,i,a=(o=s,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=gn(o);if(i){var r=gn(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return vn(this,t)});function s(t,e){var r,n=e.tabId,o=e.doc,i=e.primaryKey,c=void 0!==i&&i,u=e.title,l=e.activeIconUrl,h=e.inactiveIconUrl,f=e.type,d=e.mandatory,p=void 0!==d&&d,y=e.validation,v=void 0!==y&&y,m=e.readOnly,g=void 0!==m&&m,b=e.value,_=e.options,w=e.info,S=e.minLength,k=e.maxLength,E=e.height,x=e.maxSelectionOptions,I=e.section,T=e.column,O=void 0===T?0:T,C=e.hidden,L=void 0!==C&&C,P=e.quickView,D=void 0===P||P,F=e.lookup,A=void 0!==F&&F,R=e.lookUpCollection,N=e.lookUpFilter,j=e.valueFromLookUp,M=e.lookUpForeignKey,U=e.searchKey,B=void 0!==U&&U,G=e.temp,q=void 0!==G&&G,V=e.includeInQuickEdit,K=void 0!==V&&V,Y=e.onMessage,W=void 0===Y?function(t){}:Y,z=e.onResponse,H=void 0===z?function(t){}:z,Q=e.onInit,J=void 0===Q?function(){var t=dn(hn().mark((function t(e){return hn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}():Q,$=e.state,X=e.onlineStatus,Z=void 0===X?0:X,tt=e.pointType,et=e.iconType,rt=e.routeId,nt=e.iconColor,ot=e.iconUrl,it=e.fileScope,at=e.encrypted,st=void 0!==at&&at,ct=e.dbName;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),function(t,e,r){(e=bn(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r}(mn(r=a.call(this,t,$,n)),"dataType",kt),r.onMoveOut=dn(hn().mark((function t(){return hn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onClick=dn(hn().mark((function t(){return hn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onSearch=dn(hn().mark((function t(){return hn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onCompletion=dn(hn().mark((function t(){return hn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onInit=J,r.onMessage=W,r.onResponse=H,"boolean"==typeof c&&u&&f||A||f===ir.COLOR_FIELD?(r.title=u,r.type=f,r.primaryKey=c,r.mandatory=p,r.validation=v,r.readOnly=g,r._originalValue=b,r.options=_,r.info=w,r.maxLength=k,r.minLength=S,r.maxSelectionOptions=x,I&&!I.forCollection&&(r.section=I),r.column=O,r.hidden=L,r.temp=q,r.lookup=A,r.onlineStatus=Z,r._changed=!1,r.fileScope=it,r._defaultValue=b,r.quickView=D,r.lookUpCollection=R,r.includeInQuickEdit=K,r.activeIconUrl=l,r.inactiveIconUrl=h,r._encrypted=st,r._height=E,r._dbName=ct||r.intentId,N&&(Array.isArray(N)?r.lookUpFilter=N:r.lookUpFilter=[N]),Array.isArray(M)?r.lookUpForeignKey=M:r.lookUpForeignKey=[M],r.valueFromLookUp=j,r.searchKey=B,r._doc=null,r._pointType=tt,r._iconType=et,r._routeId=rt,r._iconColor=nt,r._iconUrl=ot,r.disableHistoryLogging(),o&&(r.formId=o.intentId,r._doc=o,r._index=o.addField(mn(r))),b&&(r.value=b),r):($.addSystemErrorToStack(7,"Field title or type missing on field "+t),vn(r))}return e=s,r=[{key:"resetProperties",value:function(){this._value=this._originalValue}},{key:"cloneField",value:function(t,e){var r=new s(void 0===e?this.intentId:this.intentId+e,{doc:t,tabId:this.tabId,primaryKey:this.primaryKey,title:this.title,type:this.type,mandatory:this.mandatory,validation:this.validation,readOnly:this.readOnly,options:this.options,info:this.info,minLength:this.minLength,maxLength:this.maxLength,maxSelectionOptions:this.maxSelectionOptions,section:this.section,fileScope:this.fileScope,column:this.column,hidden:this.hidden,quickView:this.quickView,lookup:this.lookup,lookUpCollection:this.lookUpCollection,lookUpFilter:this.lookUpFilter,valueFromLookUp:this.valueFromLookUp,lookUpForeignKey:this.lookUpForeignKey,searchKey:this.searchKey,temp:this.temp,state:t._state,onResponse:this.onResponse,onInit:this.onInit,onMessage:this.onMessage,dbName:this.dbName,activeIconUrl:this.activeIconUrl,inactiveIconUrl:this.inactiveIconUrl,routeId:this._routeId,height:this._height});return r._changed=this._changed,r}},{key:"message",value:function(t,e){this.runOnResponseLogic(t);var r=this._state._,n=this.value,o=this.type,i="";return"object"===ln(this.value)&&null!==r&&r.get(this.value,"fileName")&&(n=r.get(this.value,"value"),i=r.get(this.value,"fileName")),this.type===ir.COORDINATES&&(n="".concat(n[0],", ").concat(n[1]),o=ir.TEXT_FIELD),{id:this.intentId,tabId:this.tabId,title:this.title,type:o,info:this.info,mandatory:this.mandatory,validation:this.validation,readOnly:this.readOnly,primaryKey:this.primaryKey,value:e?this._defaultValue:n,fileName:i,maxLength:this.maxLength,minLength:this.minLength,maxSelectionOptions:this.maxSelectionOptions,section:r.get(this.section,"intentId"),column:this.column,options:this.options,search:this.search,hidden:this.hidden,index:this._index,onlineStatus:this.onlineStatus,pointType:this._pointType,iconType:this._iconType,fileScope:this.fileScope,quickView:this.quickView,activeIconUrl:this.activeIconUrl,inactiveIconUrl:this.inactiveIconUrl,routeId:this._routeId,iconColor:this._iconColor,iconUrl:this._iconUrl,height:this._height}}},{key:"runOnResponseLogic",value:function(t){t||(this.onMessage(this),this.onResponse(this))}},{key:"shortMessage",value:function(t,e){var r=this._state._;this.runOnResponseLogic(t);var n=this.value,o=this.type,i="";return"object"===ln(this.value)&&null!==r&&r.get(this.value,"fileName")&&(n=r.get(this.value,"value"),i=r.get(this.value,"fileName")),this.type===ir.COORDINATES&&(n="".concat(n[0],", ").concat(n[1]),o=ir.TEXT_FIELD),[this.intentId,this.tabId,this.title,o,this.info,this.mandatory,this.validation,this.readOnly,this.primaryKey,e?this._defaultValue:n,i,this.maxLength,this.minLength,r.get(this.section,"intentId"),this.column,this.options,this.search,this.hidden,this._index,this.onlineStatus,this._pointType,this._iconType,this.fileScope,this.quickView,this.maxSelectionOptions,this.height]}},{key:"updateFieldFromMessage",value:function(t){var e=this._state._;t&&t.hasOwnProperty("id")&&t.id===this.id&&(this.tabId=e.get(t,"tabId",this.tabId),this.title=e.get(t,"title",this.title),this.type=e.get(t,"type",this.type),this.info=e.get(t,"info",this.info),this.mandatory=e.get(t,"mandatory",this.mandatory),this.validation=e.get(t,"validation",this.validation),this.readOnly=e.get(t,"readOnly",this.readOnly),this.primaryKey=e.get(t,"primaryKey",this.primaryKey),this.maxLength=e.get(t,"maxLength",this.maxLength),this.minLength=e.get(t,"minLength",this.minLength),this.maxSelectionOptions=e.get(t,"maxSelectionOptions",this.maxSelectionOptions),this.column=e.get(t,"column",this.column),this.options=e.get(t,"options",this.options),this.search=e.get(t,"search",this.search),this.hidden=e.get(t,"hidden",this.hidden),this._index=e.get(t,"index",this._index),this.onlineStatus=e.get(t,"onlineStatus",this.onlineStatus),this._pointType=e.get(t,"pointType",this._pointType),this._iconType=e.get(t,"iconType",this._iconType),this.fileScope=e.get(t,"fileScope",this.fileScope),this.quickView=e.get(t,"quickView",this.quickView),this.height=e.get(t,"height",this.height))}},{key:"dbName",get:function(){return this._dbName},set:function(t){this._dbName=t}},{key:"encrypted",get:function(){return this._encrypted}},{key:"pointType",get:function(){return this._pointType},set:function(t){this._pointType=t}},{key:"iconType",get:function(){return this._iconType},set:function(t){this._iconType=t}},{key:"height",get:function(){return this._height},set:function(t){this._height=t}},{key:"routeId",get:function(){return this._routeId},set:function(t){this._routeId=t}},{key:"doc",get:function(){return this._doc},set:function(t){this.formId=t.formId,this._doc=t,this._index=t.addField(this)}},{key:"value",get:function(){var t=this._state._;if(t.isArray(this._value)||"object"!==ln(this._value)||0!==t.size(this._value))return this._value},set:function(t){if(this._state.stateInitialized){if(this._doc){var e=this._state._;if(this.type!==ir.COORDINATES||Array.isArray(t)||this._state.addSystemErrorToStack(41),Array.isArray(t)||"object"!==ln(t)||0!==e.size(t)){var r=t;"string"!=typeof r||this.type!==ir.DATE&&this.type!==ir.DATETIME||(r="#date"===r.substring(0,5)?parseInt(r.substring(6,19)):parseInt(r)),this.type===ir.LOOKUP&&"object"===ln(r)&&e.size(r)>1&&(r=e.get(r,"text")),this.type!==ir.COLOR_FIELD&&(r!==this.tempValue&&(this._change=!0),this.setAutoSaveFieldValue(r),this.temp||(this._doc._document[this._intentId]=r,this._doc._dbDocument[this.dbName||this._intentId]=r)),this._doc._documentForShortResponse[this._intentId]=r,this._value=r}}}else this._state.initializationErrorMessages.push("Values cannot be initialized outside a function. Default value ignored. Field ".concat(this.intentId))}},{key:"tempValue",get:function(){return this.getAutoSavedValue()}},{key:"getAutoSavePath",value:function(t,e){var r=this._state;r._;try{var n=this.doc.getAutoSavePath(t,e);if(n)return"".concat(n,".").concat(this.id)}catch(t){r.addSystemErrorToStack(999,"Error in field getAutoSavePath",this.id)}}},{key:"setAutoSaveFieldValue",value:function(t){var e=this._state;if(this.doc.autoSave&&this.doc.docId){var r=e._,n=this.getAutoSavePath();if(!n)return;t||0===t?r.set(this.doc._state.autoSaveBuffer,n,t):r.get(this.doc._state.autoSaveBuffer,n)&&r.unset(this.doc._state.autoSaveBuffer,n),this.doc._state.duringBuild||r.set(this.doc._state.autoSaveBufferChanges,n,!0)}}},{key:"getAutoSavedValue",value:function(t,e){var r=this.doc._state;if(this.doc.autoSave){var n=r._,o=this.getAutoSavePath(t,e);if(o)return n.get(this.doc._state.autoSaveBuffer,o),n.get(this.doc._state.autoSaveBuffer,o)}}},{key:"getAutoSavedValueChanged",value:function(t,e){var r=this.doc._state;if(this.doc.autoSave){var n=r._,o=this.getAutoSavePath(t,e);if(o)return n.get(this.doc._state.autoSaveBufferChanges,o)}}},{key:"clearAutoSavedValue",value:function(){this.setAutoSaveFieldValue()}},{key:"setValueFromAutoSave",value:function(t,e){var r=this._state._,n=this.getAutoSavedValue(t,e);this.value=r.isNil(n)?this.value:n}},{key:"id",get:function(){return this.intentId}},{key:"onMatching",get:function(){var t=this;return function(e){e._;var r=e.messageFromUser.controlId||e.messageFromUser.formId;return t.doc&&(e.messageTypeFromUser===k||e.messageTypeFromUser===E||e.messageTypeFromUser===x)&&e.messageFromUser.currentField===t.id&&(r===t.formId||r===t.doc._filteredCollectionName||r===t.doc._collection)}}},{key:"autoSaveLogic",value:function(t,e){if(this._doc){var r=this._state._;if(this._state.developer,this._doc.autoSave&&null!=e)if("object"===ln(e)&&r.size(e)>0&&this.type===ir.LOOKUP&&this.lookUpCollection){this.value=r.get(e,"text");var n=t.getField(v+this.id),o=r.findIndex(n,(function(t){return r.get(t,"info")===r.get(e,"info")}));if(o>-1){var i=r.get(n[o],"doc"),a=[];r.forEach(this._doc.fields,(function(t){t.valueFromLookUp&&r.forEach(i,(function(e,r){r===t.valueFromLookUp&&(t.value=i[r],a.push(t.message(!0)))}))})),a.length>0&&(t.messageTypeFromUser===E?t.addInLineFormChangeResponse(this._doc.message(B,a,null,!0,!0)):t.addFormChangeResponse(this._doc.message(B,a,null,null,!0)))}}else""===e||""===r.get(e,"text")?this.clearAutoSavedValue():this.value=e,t.storeAutoSaveBuffer()}}},{key:"lookupLogic",value:(n=dn(hn().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d=this;return hn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._doc){t.next=2;break}return t.abrupt("return");case 2:if(r=e._,""===(n=r.get(e.messageFromUser,"currentFieldValue",r.get(e.messageFromUser,"content.currentFieldValue")))||!this.lookUpCollection){t.next=22;break}return o={},i=[],this.lookUpFilter&&(a=0,r.forEach(this.lookUpFilter,(function(t){var e=t.tempValue;if(null!==e){var r={};r[d.lookUpForeignKey[a]]=e,i.push(r)}a++}))),s={},c=[],this.lookUpCollection.document.fields.forEach((function(t){var e={};if(t.type===ir.NUMBER_FIELD)e[t.id]=t.value;else{var r={};r.$regex="^(.*?)".concat(n),r.$options="i",e[t.id]=r}c.push(e)})),s.$or=c,i.push(s),o.$and=i,t.next=16,this.lookUpCollection.loadCollectionWithQuery({query:o});case 16:t.sent,u=[],l=[],r.forEach(this.lookUpCollection.rows,(function(t){var e=d.valueFromLookUp?t.document[d.valueFromLookUp]:t.getPrimaryKeyAsStringForSearch(t.getPrimaryKey()),n=t.getPrimaryKeyAsStringForSearch(t.getNonPrimaryKey()),o={text:e,info:""!==n?n:null};u.push(o);var i=r.cloneDeep(o);i.doc=t.document,l.push(i)})),r.get(this.doc,"_state.messageTypeFromUser")===E?(h=this._doc.message(U,{field:this.id,results:u},null,!0,!0),e.addInLineFormChangeResponse(h)):(f=this._doc.message(U,{field:this.id,results:u},null,null,!0),e.addFormChangeResponse(f)),e.setField(v+this.id,l);case 22:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"onResolution",get:function(){var t=this;return function(){var e=dn(hn().mark((function e(r){var n,o,i,a,s,c;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r._,r.developer,o=n.get(r.messageFromUser,"currentFieldValue",n.get(r.messageFromUser,"content.currentFieldValue")),(i=n.get(r.messageFromUser,"fileName",n.get(r.messageFromUser,"content.fileName")))&&(o={value:o,fileName:i}),t._doc&&t._doc._parent&&t._doc._parent._intentId===r.currentControlId?r.currentControlId=t._doc._parent._intentId:r.currentControlId=t._doc.intentId,(a=n.get(r.messageFromUser,"docId"))&&(s=n.get(r.messageFromUser,"tabId"),c=n.get(r.messageFromUser,"parentDocId"),t.doc.loadDocFromAutoSaveBuffer(s,a,c)),r.messageFromUser.action!==P){e.next=16;break}if(r.messageFromUser.oldFieldValue=t.tempValue,!t.validation&&o===r.messageFromUser.oldFieldValue&&t.type!==ir.RADIOBUTTON){e.next=14;break}return o!==r.messageFromUser.oldFieldValue&&t.autoSaveLogic(r,o),e.next=14,t.onMoveOut();case 14:e.next=37;break;case 16:if(r.messageFromUser.action!==F){e.next=22;break}return t.autoSaveLogic(r,o),e.next=20,t.onClick();case 20:e.next=37;break;case 22:if(r.messageFromUser.action!==T){e.next=30;break}return t.autoSaveLogic(r,o),e.next=26,t.lookupLogic(r);case 26:return e.next=28,t.onSearch();case 28:e.next=37;break;case 30:if(r.messageFromUser.action!==A){e.next=36;break}return t.autoSaveLogic(r,o),e.next=34,t.onCompletion();case 34:e.next=37;break;case 36:r.addSystemErrorToStack(46,Ht.getErrorMessageforCodeAndLang(46));case 37:r.developer.debug({message:"About to leave onResolution"}),0===r.responsesArray.length&&r.addSilentResponse();case 39:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}},{key:"onResponse",get:function(){return this._onResponse},set:function(t){this._onResponse=t}},{key:"sendValidationResponse",value:function(t){var e=t.result,r=void 0===e||e,n=t.message,o={field:this.id,validationResult:r,validationMessage:n};this._state.addFormChangeResponse(this.doc.message(K,o))}}],r&&pn(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),s}(At);function wn(t){return wn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},wn(t)}function Sn(){Sn=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==wn(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(wn(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function kn(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function En(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){kn(i,n,o,a,s,"next",t)}function s(t){kn(i,n,o,a,s,"throw",t)}a(void 0)}))}}function xn(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==wn(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==wn(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===wn(o)?o:String(o)),n)}var o}var In=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}var e,r,n,o,a,s;return e=t,null,r=[{key:"IsFieldAction",value:function(t){return t===P||t===F}},{key:"createNewDynamicField",value:function(t,e,r){var n=new _n(t.id,{title:t.title,tabId:t.tabId,type:t.type,doc:e,state:r,primaryKey:t.primaryKey,value:t.value,hidden:t.hidden});t.doc=e.intentId;var o={id:t.id,type:"Field",options:t};return r.addDynamicIntent(o),n}},{key:"BuildRowsFromArrayOfArrays",value:function(t,e){var r=Hn._,n=[];return r.forEach(t,(function(t){var o={};r.forEach(e.keysForShortMessage,(function(e,r){t[0][r]&&(o[e]=t[0][r])})),o.docId=t[1][0],o.allowEdit=t[1][1],o.allowDelete=t[1][2],o.rowMenu=t[1][3],n.push(o)})),n}},{key:"BuildCollection",value:function(t,e,r){t.clearRows(),t.buildRowsFromArray(e);var n=Object.keys(t._preserveFieldData);t._rows.map((function(e,o){n.map((function(n,i){t._preserveFieldData[n].map((function(t,a){e.f[n][t]=r[o][2][i][a]}))}))}))}},{key:"ExpandShortTableResponse",value:(s=En(Sn().mark((function e(r,n){var o,a,s,c,u,l,h,f,d,p,y,v,m,g,b;return Sn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=n._,e.next=3,n.deviceStorage.getKeyFromStorage(i);case 3:if(a=e.sent,!(s=o.get(r,"options.controlId"))){e.next=43;break}if(c="TEMP_ROWS",u=n._intents[s],l=o.get(r,"options"),h=o.get(r,"totalExpectedRows"),f=o.get(r,"asyncPages"),u.overrideOptions(l),d=o.get(r,"rows"),p=t.BuildRowsFromArrayOfArrays(d,l),y={},o.forEach(l.columnTemplate,(function(t){y[t.id]=t})),u.document._fields.map((function(t){y.hasOwnProperty(t.id)&&t.updateFieldFromMessage(y[t.id])})),!h){e.next=34;break}return e.next=20,n.deviceStorage.loadDocument(s,c);case 20:if(e.t0=e.sent,e.t0){e.next=23;break}e.t0=[];case 23:if(v=e.t0,!((m=o.union(v,p)).length<h)){e.next=31;break}return e.next=28,n.deviceStorage.saveDocument(s,c,m);case 28:return e.abrupt("return");case 31:return p=m,e.next=34,n.deviceStorage.deleteDocument(s,c);case 34:t.BuildCollection(u,p,d),g=Sn().mark((function t(){var e,r,i,c,l;return Sn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=u.rows[b],r=e.getPrimaryKey(),i=n.sha1(JSON.stringify(r)),t.next=5,n.deviceStorage.loadDocument(s,i);case 5:c=t.sent,l=0,c&&(l=1,o.forEach(a,(function(t,e){if(e===s){var i=n._intents[e];return o.forEach(t,(function(t){var e=i.document;if(e.buildDocument(t),o.isEqual(r,e.getPrimaryKey()))return l=2,!1})),!1}})),0!==l&&o.forEach(e.fields,(function(t){t.primaryKey&&(t.onlineStatus=l)})));case 8:case"end":return t.stop()}}),t)})),b=0;case 37:if(!(b<u.rows.length)){e.next=42;break}return e.delegateYield(g(),"t1",39);case 39:b++,e.next=37;break;case 42:return e.abrupt("return",u.message(f,!0));case 43:case"end":return e.stop()}}),e)}))),function(t,e){return s.apply(this,arguments)})},{key:"getGenericKeys",value:function(){return["id","tabId","title","type","info","mandatory","validation","readOnly","primaryKey","value","fileName","maxLength","minLength","section","column","options","search","hidden","index","onlineStatus","pointType","iconType","fileScope","quickView ","maxSelectionOptions","height"]}},{key:"getTermQueryForObject",value:function(t,e){var r=e._,n=[];return r.forEach(t,(function(t,e){var r={};r[e]=t;var o={term:r};n.push(o)})),{query:{bool:{must:n}}}}},{key:"formResponseAsObject",value:function(t){var e={};return t.fields?t.fields.forEach((function(t){t.fileName?e[t.id]={value:t.value,fileName:t.fileName}:e[t.id]=t.value})):t.currentField&&(e[t.currentField]=t.currentFieldValue),e}},{key:"ExpandShortFormResponse",value:(a=En(Sn().mark((function t(e,r){var n,o,i,a,s,c,u,l=this;return Sn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=r._,r.developer,o=n.get(e,"fields.fieldKeys",[]),i=n.get(e,"fields.fieldData",[]),a=n.get(e,"collectionData",{}),s=[],n.forEach(i,(function(t){var e={};n.forEach(o,(function(r,n){null!==t[n]&&(e[r]=t[n])})),s.push(e)})),!(n.get(e,"options.version",3)<4)){t.next=9;break}return t.abrupt("return",s);case 9:return c=n.map(a,(function(t){return l.ExpandShortTableResponse(t,r)})),t.next=12,Promise.all(c);case 12:return u=t.sent,n.forEach(u,(function(t){var e=n.get(t,"options.sectionId");a[e]=t})),t.abrupt("return",{fields:s,collectionData:a});case 15:case"end":return t.stop()}}),t)}))),function(t,e){return a.apply(this,arguments)})},{key:"_ProcessShortContainerResponse",value:(o=En(Sn().mark((function e(r,n){var o,i,a,s,c,u,l,h;return Sn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("table"!==(o=n._).get(r,"type")&&"calendar"!==o.get(r,"type")&&"map"!==o.get(r,"type")){e.next=13;break}i=o.get(r,"message.options"),a=o.get(i,"controlId"),s=o.get(r,"message.rows"),c=t.BuildRowsFromArrayOfArrays(s,i),(u=n._intents[a]).overrideOptions(i),t.BuildCollection(u,c,s),r.message.options=u.options,r.message.rows=u.message(!1,!1).rows,e.next=21;break;case 13:if("form2"!==o.get(r,"type")){e.next=21;break}return l=r.message.options,e.next=17,this.ExpandShortFormResponse(r.message,n);case 17:h=e.sent,Array.isArray(h)&&(h={fields:h}),r.message=h,r.message.options=l;case 21:return e.abrupt("return",r);case 22:case"end":return e.stop()}}),e,this)}))),function(t,e){return o.apply(this,arguments)})},{key:"ExpandShortContainerResponse",value:(n=En(Sn().mark((function t(e,r){var n,o,i=this;return Sn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=r._,r.developer,o=n.map(e,(function(t){return i._ProcessShortContainerResponse(t,r)})),t.next=5,Promise.all(o);case 5:return t.abrupt("return",t.sent);case 6:case"end":return t.stop()}}),t)}))),function(t,e){return n.apply(this,arguments)})}],r&&xn(e,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function Tn(t){return Tn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Tn(t)}function On(){On=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Tn(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Tn(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Cn(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Ln(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Cn(i,n,o,a,s,"next",t)}function s(t){Cn(i,n,o,a,s,"throw",t)}a(void 0)}))}}function Pn(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Nn(n.key),n)}}function Dn(t,e){return Dn=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Dn(t,e)}function Fn(t,e){if(e&&("object"===Tn(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return An(t)}function An(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function Rn(t){return Rn=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Rn(t)}function Nn(t){var e=function(t,e){if("object"!==Tn(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Tn(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===Tn(e)?e:String(e)}var jn=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Dn(t,e)}(g,t);var e,r,n,o,i,a,d,p,y,v=(p=g,y=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=Rn(p);if(y){var r=Rn(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return Fn(this,t)});function g(t,e){var r,n,o,i,a=e.tabId,s=e.name,c=e.shared,u=void 0!==c&&c,l=e.title,h=e.description,f=e.emptyStateMessage,d=e.columnNames,p=void 0===d?[]:d,y=e.keys,m=void 0===y?[]:y,b=e.selectableRows,_=void 0!==b&&b,w=e.actionableRows,S=void 0!==w&&w,k=e.addNewRows,E=void 0!==k&&k,x=e.addNewRowsLabel,I=e.allowMinimize,T=void 0===I||I,O=e.allowClose,C=void 0===O||O,L=e.minimizeOnAction,P=void 0!==L&&L,D=e.updateInBackground,F=void 0!==D&&D,A=e.topTableMenu,R=void 0!==A&&A,N=e.promptOnClose,j=e.footer,M=e.rowMenu,U=e.pages,B=e.zone,G=e.allowEdit,q=void 0!==G&&G,V=e.allowDelete,K=void 0!==V&&V,Y=e.allowDeleteWhileOffline,W=void 0!==Y&&Y,z=e.allowRefresh,H=void 0!==z&&z,Q=e.allowDownload,J=void 0!==Q&&Q,$=e.allowSearch,X=void 0!==$&&$,Z=e.allowQuickAction,tt=void 0===Z||Z,et=e.confirmAction,rt=e.selectionAction,nt=e.parentDoc,ot=e.temp,it=void 0!==ot&&ot,at=e.document,st=e.modal,ct=e.style,lt=e.calendarEntry,ht=e.activeFilterName,ft=e.availableFilters,dt=e.filterDoc,pt=e.state,yt=e.version,vt=void 0===yt?4:yt,mt=e.cache,gt=void 0===mt||mt,bt=e.local,_t=void 0!==bt&&bt,St=e.timeScaleView,kt=e.startDate,Et=e.activeQueryString,xt=e.mapOptions,It=e.acceptAttachments,Tt=e.fileScope,Ot=e.system,Ct=void 0!==Ot&&Ot,Lt=e.searchPlaceholder,Pt=e.onInit,Dt=void 0===Pt?function(){var t=Ln(On().mark((function t(e){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}():Pt;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,g),!at)return Fn(r,null);n=An(r=v.call(this,t,pt,a)),i=wt,(o=Nn(o="dataType"))in n?Object.defineProperty(n,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[o]=i,r.onAction=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onQuickAction=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onFieldAction=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onSelection=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onRefresh=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onSearch=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onDownload=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onConfirm=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onTopMenuAction=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onDelete=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onSave=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onClose=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onMenuAction=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onPreviousPage=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onNextPage=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onFilter=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onFilterDelete=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onFilterEdit=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onRenameFilter=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onMultipleSelection=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onDiscard=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onClearFilter=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onClearSearch=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onCreateOverlay=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onEditOverlay=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onDeleteOverlay=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onShowAreas=Ln(On().mark((function t(){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onInit=Dt,r.title=l,r.description=h,r.columnNames=p,r.keys=m,r.selectableRows=_,r.actionableRows=S,r.addNewRows=E,r.addNewRowsLabel=x,r.allowMinimize=T,r.allowClose=C,r.allowSearch=X,r.minimizeOnAction=P,r.updateInBackground=F,r.promptOnClose=N,r.style=ct,r.calendarEntry=lt,r.footer=j,r.rowMenu=M,r.pages=U,r.zone=B,r.modal=st,r.allowChange=q,r.allowEdit=q,r.allowDelete=K,r.allowDeleteWhileOffline=W,r.allowRefresh=H,r.allowDownload=J,r.confirmAction=et,r.emptyStateMessage=f,r._activeFilterName=ht,r._availableFilters=ft,r._filteredColumns=[],r._version=vt,r._columns=[],r._action=null,r._activeQueryString=Et,r._columnTemplate=[],r._preserveFieldData={},r._mapOptions=xt,r.selectionAction=rt,r._keysForShortMessage=[],r.allowQuickAction=tt,r.acceptAttachments=It,r.fileScope=Tt,r.parentDocId=r.intentId,r.topTableMenu=R,r.searchPlaceholder=Lt,ct===ut&&(r._timeScaleView=St,r._startDate=kt),r._shared=u;var Ft="".concat(s||t);return r._collectionName=Ft,r._state=at._state,r._=at._state._,r._rows=[],r._document=at,r.documentId=at.intentId,r._cache=gt,r._system=Ct,r.temp=it,r._local=_t,r._document&&(r._state=r._document._state),r._subCollection=!1,r.filterDoc=dt,r._sectionId=null,nt&&r.setParentDoc(nt),at._state._,r.addNewRows&&(r.newRowFieldsOptions=at.message(!0).fields||[]),r._document.setCollection(An(r)),r}return e=g,r=[{key:"resetProperties",value:function(){this._action=null,this.activeQueryString=null,this.activeFilterName=null,this._name=this._shared?"".concat(this._collectionName,"_").concat(this._state.systemId):"".concat(this._collectionName,"_").concat(this._state.botId),this._document.setCollection(this)}},{key:"cloneCollection",value:function(t,e){return new g(e||this.intentId,{title:this.title,description:this.description,columnNames:this.columnNames,keys:this.keys,selectableRows:this.selectableRows,actionableRows:this.actionableRows,addNewRows:this.addNewRows,addNewRowsLabel:this.addNewRowsLabel,allowMinimize:this.allowMinimize,allowClose:this.allowClose,minimizeOnAction:this.minimizeOnAction,updateInBackground:this.updateInBackground,promptOnClose:this.promptOnClose,footer:this.footer,rowMenu:this.rowMenu,pages:this.pages,allowEdit:this.allowEdit||this.allowChange,allowDelete:this.allowDelete,allowDeleteWhileOffline:this.allowDeleteWhileOffline,allowRefresh:this.allowRefresh,allowDownload:this.allowDownload,allowSearch:this.allowSearch,confirmAction:this.confirmAction,parentDoc:this.parentDoc,document:this._document,modal:this.modal,style:this.style,calendarEntry:this.calendarEntry,activeFilterName:this._activeFilterName,availableFilters:this._availableFilters,filterDoc:this._filterDoc,state:this.document._state,version:this._version,cache:this._cache,timeScaleView:this._timeScaleView,startDate:this._startDate,activeQueryString:this._activeQueryString,mapOptions:this._mapOptions,selectionAction:this.selectionAction,acceptAttachments:this.acceptAttachments,fileScope:this.fileScope,topTableMenu:this.topTableMenu,searchPlaceholder:this.searchPlaceholder,system:this._system,emptyStateMessage:this.emptyStateMessage,onInit:this.onInit})}},{key:"overrideOptions",value:function(t){var e=this._state._;this.tabId=t.tabId,this.title=e.get(t,"title"),this.columnNames=e.get(t,"columnNames"),this._columns=e.get(t,"columns"),this._filteredColumns=t.filteredColumns,this.keys=t.keys,this.selectableRows=t.selectableRows,this.actionableRows=t.actionableRows,this.addNewRows=t.addNewRows,this.addNewRowsLabel=t.addNewRowsLabel,this.allowMinimize=t.allowMinimize,this.allowClose=t.allowClose,this.minimizeOnAction=t.minimizeOnAction,this.updateInBackground=t.updateInBackground,this.promptOnClose=t.promptOnClose,this.footer=t.footer,this.rowMenu=t.rowMenu,this.pages=t.pages,this.zone=t.zone,this.modal=t.modal,this.allowChange=t.allowChange,this.allowEdit=t.allowEdit,this.allowDelete=t.allowDelete,this.allowDeleteWhileOffline=t.allowDeleteWhileOffline,this.allowRefresh=t.allowRefresh,this.allowDownload=t.allowDownload,this.confirmAction=t.confirmAction,this.allowSearch=t.allowSearch,this.allowQuickAction=t.allowQuickAction,this.style=t.style,this.calendarEntry=t.calendarEntry,this._activeFilterName=t.activeFilterName,this._availableFilters=t.availableFilters,this._filterActive=t.filterActive,this.newRowFieldsOptions=t.newRowFieldsOptions,this._timeScaleView=t.timeScaleView,this._startDate=t.startDate,this._activeQueryString=t.activeQueryString,this._columnTemplate=t.columnTemplate,this._preserveFieldData=t.preserveFieldData,this._mapOptions=t.mapOptions,this._keysForShortMessage=t.keysForShortMessage,this.parentDocId=t.parentDocId,this.emptyStateMessage=t.emptyStateMessage,this._state&&(t.parent?this._parent=this._state.intents[t.parent]:delete this._parent),this.selectionAction=e.get(t,"selectionAction"),this.topTableMenu=e.get(t,"topTableMenu")}},{key:"options",get:function(){var t,e=null;return this._parent&&(e=this._parent._intentId),this._state&&(t=this._state._.get(this._state,"messageFromUser.parentDocId")||this.parentDocId),{parent:e,tableId:this.intentId,controlId:this.intentId,documentId:this.documentId,action:this._action,tabId:this.tabId,title:this.title,description:this.description,columnNames:this.columnNames,columns:this._columns,filteredColumns:this._filteredColumns,keys:this.keys,selectableRows:this.selectableRows,actionableRows:this.actionableRows,addNewRows:this.addNewRows,addNewRowsLabel:this.addNewRowsLabel,allowMinimize:this.allowMinimize,allowClose:this.allowClose,minimizeOnAction:this.minimizeOnAction,updateInBackground:this.updateInBackground,promptOnClose:this.promptOnClose,footer:this.footer,rowMenu:this.rowMenu,pages:this.pages,zone:this.zone,modal:this.modal,allowChange:this.allowChange,allowEdit:this.allowEdit,allowDelete:this.allowDelete,allowDeleteWhileOffline:this.allowDeleteWhileOffline,allowRefresh:this.allowRefresh,allowDownload:this.allowDownload,confirmAction:this.confirmAction,allowSearch:this.allowSearch,style:this.style,calendarEntry:this.calendarEntry,activeFilterName:this._activeFilterName,availableFilters:this._availableFilters,filterActive:this._filterActive,newRowFieldsOptions:this.newRowFieldsOptions,timeScaleView:this._timeScaleView,startDate:this._startDate,activeQueryString:this._activeQueryString,columnTemplate:this._columnTemplate,preserveFieldData:this._preserveFieldData,mapOptions:this._mapOptions,selectionAction:this.selectionAction,keysForShortMessage:this._keysForShortMessage,acceptAttachments:this.acceptAttachments,fileScope:this.fileScope,allowQuickAction:this.allowQuickAction,topTableMenu:this.topTableMenu,searchPlaceholder:this.searchPlaceholder,emptyStateMessage:this.emptyStateMessage,parentDocId:t,sectionId:this.sectionId}}},{key:"document",get:function(){return this._document},set:function(t){this._document=t}},{key:"parentDoc",get:function(){return this._parentDoc},set:function(t){this._parentDoc=t}},{key:"sectionId",get:function(){return this._sectionId},set:function(t){this._sectionId=t}},{key:"system",get:function(){return this._system}},{key:"name",get:function(){return this._shared?"".concat(this._collectionName,"_").concat(this._state.systemId):"".concat(this._collectionName,"_").concat(this._state.botId)}},{key:"filterDoc",get:function(){return this._filterDoc},set:function(t){this._filterDoc=t,this._filterDoc?(this._filterActive=!0,this._filterDoc._filteredCollectionName=this.intentId):this._filterActive=!1}},{key:"isSubCollection",get:function(){return this._subCollection},set:function(t){this._subCollection=t}},{key:"sendResponse",value:function(t){this._state.addTableResponse(this.message(!1,t))}},{key:"generateTableColumnLabels",value:function(){var t=this,e=this._state._,r=[],n={};return e.forEach(this._document.fields,(function(e){e.hidden||(e.type===ir.FILE_FIELD?1===t._version?r.push("".concat(e.title,"_attachment")):n[e.id]=e.title:1===t._version?r.push(e.title):n[e.id]=e.title)})),1===this._version?r:n}},{key:"generateTableColumnTemplate",value:function(){var t=this._state._,e=[];return t.forEach(this._document.fields,(function(t){e.push(t.message(!0,!0))})),e}},{key:"generateTableKeyLabels",value:function(){var t=this._state._,e=[];return t.forEach(this._document.fields,(function(t){t.primaryKey&&e.push(t.title)})),e}},{key:"generateKeysForShortMessage",value:function(){var t=this._state._,e=[];return t.forEach(this._document.fields,(function(t){e.push(t.id)})),e}},{key:"generateTableRows",value:function(t){var e=this,r=this._state._,n=(this._state.developer,[]);return r.forEach(this._rows,(function(o){o.document;var i={};if(2===e._version)i=r.get(o.message(null,null,null,null,t),"fields");else if(e._version>2){var a=o.message(null,null,null,null,t),s={};!1===o.allowEdit&&(s.allowEdit=!1),!1===o.allowDelete&&(s.allowDelete=!1),s.rowMenu=o.rowMenu,i[o.docId]={fields:r.get(a,"fields"),rowOptions:s}}else r.forEach(o.fields,(function(e){e&&e.onMessage(t),!e.primaryKey&&e.hidden||(e.type===ir.DATE||e.type===ir.DATETIME?i[e.title]="#date(".concat(e.value,")"):i[e.title]=e.value)}));n.push(i)})),n}},{key:"setFilterColumns",value:function(){var t=this._state._;if(this._filterDoc&&0===this._filteredColumns.length){var e=[];t.forEach(this._filterDoc.fields,(function(t){if(!t.hidden){var r=t.message();r&&e.push(r)}})),this._filteredColumns=e}}},{key:"prepareCollectionOptions",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=this._document._autoSave;this.allowChange||this.allowEdit||this.addNewRows||this.allowDelete||this._parentDoc||(this._document._autoSave=!1),this.setFilterColumns(),this.columnNames=this.generateTableColumnLabels(),this._columnTemplate=this.generateTableColumnTemplate(),this._keysForShortMessage=this.generateKeysForShortMessage(),this._preserveFieldData=t,2===this._version?this.keys=[]:this.keys=this.generateTableKeyLabels(),this._document._autoSave=e}},{key:"getRowsForShortResponse",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=this._state._;this.message(void 0,void 0,e);var n=[];return r.forEach(this._rows,(function(o){var i=[];r.forEach(t._keysForShortMessage,(function(t){i.push(o._documentForShortResponse[t])}));var a=[];r.forEach(Object.keys(e),(function(t){var n=[];r.forEach(e[t],(function(e){n.push(o.f[t][e])})),a.push(n)})),n.push([i,[o.docId,o.allowEdit,o.allowDelete,o.rowMenu],a])})),n}},{key:"sendShortResponse",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._state._,this.prepareCollectionOptions(r),this._state.addShortTableResponse({options:this.options,asyncPages:t,totalExpectedRows:e,rows:this.getRowsForShortResponse(r)})}},{key:"message",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this._state._,this.prepareCollectionOptions(r),t?(this._action=s,{rows:{append:this.generateTableRows(e)},options:this.options}):(this._action=null,{rows:this.generateTableRows(e),options:this.options})}},{key:"sendEditFilterResponse",value:function(){this._state.developer,this._action=c,this.setFilterColumns(),this._state.addTableResponse({rows:[],options:this.options})}},{key:"sendFilterChangeResponse",value:function(t,e){this._state.developer,this._action=t,this._filteredColumns=e,this._state.addTableResponse({rows:[],options:this.options})}},{key:"getFilterCriteriaWithName",value:function(t){return this._state.getField(m+t)}},{key:"addRow",value:function(t){t.index=this._rows.length,this._rows.push(t)}},{key:"clearRows",value:function(){this._rows=[]}},{key:"rowAsDocumentsArray",value:function(){var t=this._state._,e=[];return t.forEach(this.rows,(function(t){e.push(t.document)})),e}},{key:"buildRowsFromArray",value:function(t){var e=this;this._state._,Array.isArray(t)&&(this.clearRows(),t.forEach((function(t){var r=e._document.cloneDoc();e.addRow(r),r.hasSubDocs?r.buildDocumentFromContainer(t,!0):r.buildDocument(t,!0)})))}},{key:"buildRowsFromUserMessage",value:function(t,e,r){this._state.duringBuild=!0,this._state._.unset(this._state.autoSaveBuffer,this.getAutoSavePath(t)),this.buildRowsFromArray(e.rows),this._state.duringBuild=!1}},{key:"getAutoSavePath",value:function(t,e){var r=this._state;try{r._,r.developer;var n=t||r.currentTabId||this.document.tabId;if(this._parentDoc){var o=this._parentDoc.getAutoSavePath(n,e);return"".concat(o,".").concat(this.intentId)}return"".concat(n,".").concat(this.intentId)}catch(t){r.addSystemErrorToStack(999,t.message,this.intentId)}}},{key:"loadRowsFromAutoSaveBuffer",value:function(t){var e=this,r=this.document._state,n=r._,o=(r.developer,this.getAutoSavePath(t)),i=n.get(r.autoSaveBuffer,o);n.forEach(i,(function(t,r){var n=e.document.cloneDoc();n.docId=r,e.addRow(n),e.document._subDocs?n.buildDocumentFromContainer(t):n.buildDocument(t)}))}},{key:"generateAutoSaveBufferFromCollection",value:function(){this._rows.forEach((function(t){t.generateAutoSaveBufferFromDoc()}))}},{key:"clearAutoSaveBuffer",value:function(t){var e=this.document._state,r=e._,n=this.getAutoSavePath(t);r.unset(e.autoSaveBuffer,n)}},{key:"clearAutoSaveBufferChanges",value:function(t){var e=this.document._state,r=e._,n=this.getAutoSavePath(t);r.unset(e.autoSaveBufferChanges,n)}},{key:"buildTheDocsFromPayload",value:(d=Ln(On().mark((function t(e){var r,n,o,i,a,s=this;return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this._state._,this._state.developer,t.next=4,this._state.online();case 4:if(t.sent,r=this._document._autoSave,!(Array.isArray(e)&&e.length>0)){t.next=20;break}n=[],this._rows=[],o={},this.allowChange||this.allowEdit||this.addNewRows||this.allowDelete||(this._document._autoSave=!1),i=On().mark((function t(){var r,i,c,u;return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e[a],i=s._document.cloneDoc(),n.push(r),s._document.hasSubDocs?i.buildDocumentFromContainer(r):i.buildDocument(r),t.next=6,i.onPostLoad(i);case 6:c=function(t){o[t]||(s.addRow(i),o[t]=!0)},u=s.document._state.sha1(JSON.stringify(i.getPrimaryKey())),c(u);case 9:case"end":return t.stop()}}),t)})),a=0;case 13:if(!(a<e.length)){t.next=18;break}return t.delegateYield(i(),"t0",15);case 15:a++,t.next=13;break;case 18:return this._document._autoSave=r,t.abrupt("return",n);case 20:case"end":return t.stop()}}),t,this)}))),function(t){return d.apply(this,arguments)})},{key:"loadCollectionWithQuery",value:(a=Ln(On().mark((function t(e){var r,n,o,i,a,s,c,u,l,h,f,d,p,y,v,m,g;return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.action,o=void 0===n?"query":n,i=e.query,a=void 0===i?{}:i,s=e.projection,c=void 0===s?{}:s,u=e.sort,l=void 0===u?{}:u,h=e.skip,f=void 0===h?0:h,d=e.limit,p=void 0===d?20:d,y=e.collation,v=void 0===y?{}:y,!this._subCollection){t.next=4;break}return this._state.addErrorToStack(7,"We cannot retrieve data from subCollections"),t.abrupt("return");case 4:if(!this._local){t.next=10;break}return t.next=7,this._state.deviceStorage.queryCollection(this.name);case 7:m=t.sent,t.next=15;break;case 10:return this._state._,this._state.developer,t.next=14,this._state.db.getDataFromCollection({collection:this.name,action:o,query:a,projection:c,sort:l,skip:f,limit:p,collation:v,system:this._system,cache:this._cache,securedFields:this.document.getSecuredFieldsArray()});case 14:m=t.sent;case 15:if(200!==(null===(r=m)||void 0===r?void 0:r.statusCode)){t.next=18;break}return g=m.body,t.abrupt("return",this.buildTheDocsFromPayload(g));case 18:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"countCollectionWithQuery",value:(i=Ln(On().mark((function t(e){var r,n,o,i,a,s,c;return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.query,n=void 0===r?{}:r,o=e.projection,i=void 0===o?{}:o,a=e.collation,s=void 0===a?{}:a,t.next=3,this._state.db.countDataFromCollection({collection:this.name,query:n,projection:i,collation:s});case 3:if(200!==(c=t.sent).statusCode){t.next=6;break}return t.abrupt("return",c.body);case 6:case"end":return t.stop()}}),t,this)}))),function(t){return i.apply(this,arguments)})},{key:"loadCollectionFromIndex",value:(o=Ln(On().mark((function t(e,r){var n,o,i;return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=this._state._,o=this._state.developer,r||(r=this.intentId),t.next=5,this._state.db.getDataFromIndexWithQueryObject(r,e);case 5:if(i=t.sent,o.log({message:"Results from ES query",data:i}),!n.get(i,"errorMessage")&&!n.get(i,"error")){t.next=11;break}return t.abrupt("return");case 11:return t.abrupt("return",this.buildTheDocsFromPayload(i));case 12:case"end":return t.stop()}}),t,this)}))),function(t,e){return o.apply(this,arguments)})},{key:"getQueryForSearch",value:function(t){var e=this._state._,r={$or:[]};return e.forEach(this._document.fields,(function(n){if(n.searchKey||n.primaryKey){var o={};if(n.type===ir.NUMBER_FIELD)o[n.dbName||n.id]=parseInt(t,10);else{var i={};i.$regex="^(.*?)".concat(t),i.$options="i",o[n.dbName||n.id]=i}e.size(o)>0&&r.$or.push(o)}})),r}},{key:"setParentDoc",value:function(t){t.dataType===St?(this.isSubCollection=!0,this.parentDoc=t,this._document.parentDocId=this._state.user.userId,t.addChildDoc(this)):this._state.addSystemErrorToStack(7,"Sub documents cannot be saved ".concat(this._intentId))}},{key:"mapOptions",get:function(){return this._mapOptions}},{key:"activeQueryString",get:function(){return this._activeQueryString},set:function(t){this._activeQueryString=t}},{key:"startDate",get:function(){return this._startDate},set:function(t){this._startDate=t}},{key:"timeScaleView",get:function(){return this._timeScaleView},set:function(t){this._timeScaleView=t}},{key:"availableFilters",get:function(){return this._availableFilters},set:function(t){this._availableFilters=t}},{key:"activeFilterName",get:function(){return this._activeFilterName},set:function(t){this._activeFilterName=t}},{key:"parent",set:function(t){this._parent=t}},{key:"tableId",get:function(){return this.intentId}},{key:"rows",get:function(){return this._rows},set:function(t){this._rows=t}},{key:"shared",get:function(){return this._rows},set:function(t){this._shared=t}},{key:"filteredColumns",get:function(){return this._filteredColumns},set:function(t){this._filteredColumns=t}},{key:"local",get:function(){return this._local},set:function(t){this._local=t}},{key:"insertRow",value:function(t,e){this._rows.splice(t,0,e)}},{key:"onMatching",get:function(){var t=this;return function(e){var r=e._,n=(e.developer,"no value"),o=r.get(e.messageFromUser,"action"),i=r.get(e.messageFromUser,"currentFieldValue",r.get(e.messageFromUser,"content.currentFieldValue",n));return!(e.messageTypeFromUser!==E||e.messageFromUser.controlId!==t.intentId&&e.messageFromUser.tableId!==t.intentId||i!==n||o&&In.IsFieldAction(o))}}},{key:"_callEvents",value:(n=Ln(On().mark((function t(e){return On().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._parent&&this._parent._intentId===e.currentControlId?e.currentControlId=this._parent._intentId:e.currentControlId=this.intentId,e.messageFromUser.action!==O){t.next=6;break}return t.next=4,this.onAction();case 4:t.next=137;break;case 6:if(e.messageFromUser.action!==Y){t.next=11;break}return t.next=9,this.onQuickAction();case 9:t.next=137;break;case 11:if(e.messageFromUser.action!==z){t.next=16;break}return t.next=14,this.onSelection();case 14:t.next=137;break;case 16:if(e.messageFromUser.action!==$){t.next=21;break}return t.next=19,this.onSave();case 19:t.next=137;break;case 21:if(e.messageFromUser.action!==L){t.next=26;break}return t.next=24,this.onDiscard();case 24:t.next=137;break;case 26:if(e.messageFromUser.action!==M){t.next=31;break}return t.next=29,this.onClose();case 29:t.next=137;break;case 31:if(e.messageFromUser.action!==T){t.next=36;break}return t.next=34,this.onSearch();case 34:t.next=137;break;case 36:if(e.messageFromUser.action!==H){t.next=41;break}return t.next=39,this.onMenuAction();case 39:t.next=137;break;case 41:if(e.messageFromUser.action!==W){t.next=46;break}return t.next=44,this.onFieldAction();case 44:t.next=137;break;case 46:if(e.messageFromUser.action!==C){t.next=51;break}return t.next=49,this.onRefresh();case 49:t.next=137;break;case 51:if(e.messageFromUser.action!==Q){t.next=56;break}return t.next=54,this.onDownload();case 54:t.next=137;break;case 56:if(e.messageFromUser.action!==N){t.next=61;break}return t.next=59,this.onConfirm();case 59:t.next=137;break;case 61:if(e.messageFromUser.action!==J){t.next=66;break}return t.next=64,this.onDelete();case 64:t.next=137;break;case 66:if(e.messageFromUser.action!==X){t.next=71;break}return t.next=69,this.onPreviousPage();case 69:t.next=137;break;case 71:if(e.messageFromUser.action!==Z){t.next=76;break}return t.next=74,this.onNextPage();case 74:t.next=137;break;case 76:if(e.messageFromUser.action!==tt){t.next=81;break}return t.next=79,this.onFilter();case 79:t.next=137;break;case 81:if(e.messageFromUser.action!==rt){t.next=86;break}return t.next=84,this.onFilterDelete();case 84:t.next=137;break;case 86:if(e.messageFromUser.action!==et){t.next=91;break}return t.next=89,this.onFilterEdit();case 89:t.next=137;break;case 91:if(e.messageFromUser.action!==l){t.next=96;break}return t.next=94,this.onMultipleSelection();case 94:t.next=137;break;case 96:if(e.messageFromUser.action!==u){t.next=101;break}return t.next=99,this.onRenameFilter();case 99:t.next=137;break;case 101:if(e.messageFromUser.action!==h){t.next=106;break}return t.next=104,this.onClearFilter();case 104:t.next=137;break;case 106:if(e.messageFromUser.action!==f){t.next=111;break}return t.next=109,this.onClearSearch();case 109:t.next=137;break;case 111:if(e.messageFromUser.action!==nt){t.next=116;break}return t.next=114,this.onCreateOverlay();case 114:t.next=137;break;case 116:if(e.messageFromUser.action!==ot){t.next=121;break}return t.next=119,this.onEditOverlay();case 119:t.next=137;break;case 121:if(e.messageFromUser.action!==it){t.next=126;break}return t.next=124,this.onDeleteOverlay();case 124:t.next=137;break;case 126:if(e.messageFromUser.action!==st){t.next=131;break}return t.next=129,this.onShowAreas();case 129:t.next=137;break;case 131:if(e.messageFromUser.action!==at){t.next=136;break}return t.next=134,this.onTopMenuAction();case 134:t.next=137;break;case 136:e.addSystemErrorToStack(28,Ht.getErrorMessageforCodeAndLang(28));case 137:0===e.responsesArray.length&&e.addSilentResponse();case 138:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"onResolution",get:function(){var t=this,e=this.document._state._,r=this.document._state.developer;return function(){var n=Ln(On().mark((function n(o){var i,a,s,c,u,l,h,f,d,p;return On().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return i=e.get(o.messageFromUser,"docId"),a=e.get(o.messageFromUser,"parentDocId"),!i&&a&&(i=a),i&&(s=e.get(o.messageFromUser,"tabId"),t.document.loadDocFromAutoSaveBuffer(s,i,a),o.messageFromUser.action===J||o.messageFromUser.action===L&&o.messageFromUser.newRow?(c=e.get(o.messageFromUser,"content.".concat(i)),u=In.formResponseAsObject(c),t.document.docId=i,t.document.buildDocument(u,!0),t.document.clearAutoSaveBuffer(s,i,a)):o.messageFromUser.action!==L||o.messageFromUser.newRow?o.messageFromUser.action===$?(f=e.get(o.messageFromUser,"content"),r.log({message:"rawDocToRestore",data:f}),d=In.formResponseAsObject({fields:f}),r.log({message:"docToRestore",data:d}),t.document.docId=i,t.document.buildDocument(d,!0,!0),r.log({message:"builtDocument",data:t.document.document})):o.messageFromUser.action===H&&(p=e.get(o.messageFromUser,"content.row"),t.document.docId=i,t.document.buildDocument(p,!0,!0)):(l=e.get(o.messageFromUser,"content.".concat(i)),h=In.formResponseAsObject(l),t.document.docId=i,t.document.buildDocument(h,!0))),n.next=6,t._callEvents(o);case 6:case"end":return n.stop()}}),n)})));return function(t){return n.apply(this,arguments)}}()}}],r&&Pn(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),g}(At);function Mn(t){return Mn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Mn(t)}function Un(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function Bn(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?Un(Object(r),!0).forEach((function(e){var n,o,i;n=t,o=e,i=r[e],(o=Wn(o))in n?Object.defineProperty(n,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[o]=i})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Un(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function Gn(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function qn(){qn=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Mn(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Mn(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Vn(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Kn(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Vn(i,n,o,a,s,"next",t)}function s(t){Vn(i,n,o,a,s,"throw",t)}a(void 0)}))}}function Yn(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Wn(n.key),n)}}function Wn(t){var e=function(t,e){if("object"!==Mn(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Mn(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===Mn(e)?e:String(e)}var zn=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.initStateProperties(),this.user={},this.conversationId="",this.conversation={},this.lang="en",this._conversational=!0,this._version=4,this._background={type:0},this._sidebar={hidden:!1,frozen:!1},this._navbar={hidden:!1,frozen:!1},this.onlineRequired=!1,this._intents={},this.messageTypes={},this.logoutInProcess=!1,this.compatibilityMode=!1,this.waitingIcon={},this._suggestionsLayout="horizontal",this.chatButtonHidden=!1,this._unitTestMode=!1,this._cssFilePath=null,this._modal=!1,this.v1Compatibility=!1,this.appVersion="",this.autoResponse=!1,this.isRunning=!1,this._persistentState=!0,this._persistentOfflineData=!0,this._systemId=null,this.developer||(this.developer=new re(this))}var e,i,s,c,u,l,h,f,d,p,y,v,m,g,b,_,w,S,k;return e=t,i=[{key:"initStateProperties",value:function(){this._activeIntent="",this._intentHistory=[],this._intentStats={},this.error=!1,this.errorStack=[],this.responsesArray=[],this.smartSuggestionsArray=[],this.client="",this._blockSuggestions=!1,this.toCustomCap=!1,this._silentIntent=!1,this.intentResolved=!1,this.waitingCustomCap=0,this.location={},this.requestIdsArray=[],this.context=null,this._=null,this.R=null,this.Immutable=null,this.moment=null,this.momentTimezone=null,this.lastGreetingTime=0,this.lastUserActivity=0,this.MessageCapability=null,this.fields={},this.sessionFields={},this.fieldsChanged={},this.fieldsCleared=[],this._oldFields={},this.currentWorkspace="",this.botId="",this.botName="",this.botDescription="",this.lastSession=Date.now(),this.amIOnline=!0,this.sendMessageParam=null,this.disambiguate=!1,this.disambiguationNLPId="",this._nlpResults={},this._lastNLPResults={},this._inputHistory=[],this._currentControlId=null,this.fromGreeting=!1,this._inSilence=!1,this._routesQueue={},this._dynamicIntents={},this._autoSavePresent=!1,this._syncToEdge={},this._syncToCloud={},this.autoSaveBuffer={},this.autoSaveBufferChanges={},this.duringBuild=!1,this._delayedNotification=[],this.apiResponse=!1,this.messageTypeFromUser="",this.messageFromUser="",this.stateInitialized=!1,this.initializationErrorMessages=[],this.osVersion="",this.brand="",this.phoneModel="",this.platform="",this.timeSensitiveMode=!1,this.userAgent="",this.reportActivityOnMain=!1}},{key:"init",value:function(e,r,n,o,i,a,s){var c,u,l,h,f=this;if(this.initStateProperties(),this.ipDetails=r.ipDetails,this.conversationId=r.conversationId,this.conversation=r,this.client=this.conversation.client,this.responseToClient=this.client,this.messageId=this.getUniqueId(),this.client===yt?(this.osVersion=null==r?void 0:r.OSVersion,this.brand=null==r?void 0:r.brand,this.phoneModel=null==r?void 0:r.model,this.platform=null==r?void 0:r.platform):this.userAgent=null==r?void 0:r.userAgent,this.user=n,this.location=o,this.developer.init(this),this.setContext(a),this.notification||(this.notification=new Ee(this),this.accounts=new ie(this),this.orders=new ce(this),this.sftp=o===bt?new pe(this):{},this.marketplace=new Te(this),this.jobScheduler=new Fe(this),this.contacts=new Me(this),this.api=new ze(this),this.db=new Ze(this),this.file=o===bt?new dr(this):{},this.sites=new vr(this),this.sensors=new br(this),this.locationServices=new xr(this),this.security=new Pr(this),this.nlp=new jr(this),this.cc=new Vr(this),this.companies=new Wr(this),this.schedules=new rn(this)),this.backendResponseType=0,this.botId=(null===(c=this.conversation)||void 0===c?void 0:c.bot)||(null===(u=this.context)||void 0===u||null===(u=u.botManifest)||void 0===u?void 0:u.botId),this.botName=null===(l=this.context)||void 0===l||null===(l=l.botManifest)||void 0===l?void 0:l.botName,this.botDescription=null===(h=this.context)||void 0===h||null===(h=h.botManifest)||void 0===h?void 0:h.description,this.client!==yt&&this.client!==mt||this.location!==gt||(this.deviceStorage=new un(this)),i)for(var d in i)this[d]=i[d];if(e){if(e.messageType)this.messageTypeFromUser=e.messageType,this.messageFromUser=e.messageFromUser||"";else if(this.messageTypeFromUser=e.getMessageType(),this.messageFromUser=e.getMessage()||{},this.messageTypeFromUser===this.messageTypes.MESSAGE_TYPE_STRING){this.messageTypeIntFromUser=function(t){return f.context.getCapability("MessageTypeConstantsToInt")[t.getMessageType()]||0}(e),this.messageCreatedOnFromUser=e.getMessageDate().valueOf(),this.messageCreatedByFromUser=e.getCreatedBy();var p=e.getMessage(),y=JSON.stringify(p);y=y.replace(/\"\"/g,'" "'),p=JSON.parse(y),this.messageContentFromUser=Array.isArray(p)?p:[p],this.messageOptionsFromUser=e.getMessageOptions()}this._inputHistory.push({type:JSON.stringify(this.messageTypeFromUser),content:JSON.stringify(this.messageFromUser)}),this._oldFields=this.fields,this._inputHistory.length>5&&this._inputHistory.splice(0,1)}this.autoResponse=this.messageTypeFromUser===t.SOCKET_RECONNECTION_EVENT(),this.messageFromUser&&!this.messageFromUser.intentId&&(this.lastUserActivity=Date.now()),this.currentTabId=this._.get(this.messageFromUser,"tabId"),void 0===this.onStart&&(this.onStart=Kn(qn().mark((function t(){return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)})))),this.defaultOnError=function(){f.developer.runProfile!==re.PROD()?f._.forEach(f.errorStack,(function(t){40===t.errorCode?f.addCriticalNotificationResponse(t.errorMessage):f.addStringResponse(t.errorMessage)})):f.addStringResponse("Requested information is currently unavailable. Please check back later")},this.stateInitialized=!0,this.resetOnErrorMethod()}},{key:"runAllOnInits",value:function(){this.developer.info({message:"Running onInits events"}),this.initializationErrorMessages.forEach((function(t){Qn.warning({message:t})}));var t=[];return Object.values(this._intents).forEach((function(e){e.resetProperties(),t.push(e.onInit(e))})),Promise.all(t)}},{key:"version",set:function(t){this._version=t}},{key:"callCapability",value:function(t){try{var e=this.context.capabilities.capabilities,r=this.context.capabilities;e||(e=this.context.capabilities,r=this.context);var n=e[t.capabilityFileName];if(n)return n.execute(t,r)}catch(t){this.addSystemErrorToStack(26,"4 "+t.name+": "+t.message)}}},{key:"callLambda",value:(k=Kn(qn().mark((function t(e,r){var n,o=arguments;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=o.length>2&&void 0!==o[2]?o[2]:"RequestResponse",this.location===bt){t.next=5;break}return this.developer.warning({message:"".concat(e," cannot be called from ").concat(this.location)}),this.addSystemErrorToStack(26,""),t.abrupt("return");case 5:return t.abrupt("return",this.frontmlib.invokeLambda(e,n,r));case 6:case"end":return t.stop()}}),t,this)}))),function(t,e){return k.apply(this,arguments)})},{key:"resetOnErrorMethod",value:function(){this.clearError(),this._onError=this.defaultOnError}},{key:"lastMainTimeStamp",get:function(){return this.getField(dt)}},{key:"onError",get:function(){return this._onError},set:function(t){this._onError=t}},{key:"silentIntent",get:function(){return this._silentIntent}},{key:"activeIntent",get:function(){return this._activeIntent}},{key:"getNlpResultsForId",value:function(t){return this._nlpResults&&this._nlpResults[t]?this._nlpResults[t]:{}}},{key:"getMultipleStaticDataKeys",value:(S=Kn(qn().mark((function t(e,r){var n,o,i,a,s=this;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Array.isArray(e)||1!==e.length){t.next=4;break}return t.abrupt("return",this.getStaticData(e[0],r));case 4:if(Array.isArray(e)){t.next=7;break}return this.developer.warning(Ht.getErrorMessageforCodeAndLang(62)),t.abrupt("return");case 7:return n=[],e.forEach((function(t){n.push({key:t})})),o={$or:n},t.next=13,this.db.getDataFromCollection({collection:"_keyValues",query:o,cache:!0,system:r});case 13:return i=t.sent,a={},null!=i&&i.body&&Array.isArray(i.body)&&i.body.forEach((function(t){a[t.key]=t.value})),0===Object.keys(a).length?this.developer.warning({message:"Missing static data for all keys"}):e.forEach((function(t){a[t]||s.developer.warning({message:"Missing static data for key ",data:t})})),t.abrupt("return",a);case 18:case"end":return t.stop()}}),t,this)}))),function(t,e){return S.apply(this,arguments)})},{key:"getStaticData",value:(w=Kn(qn().mark((function t(e,r){var n,o,i,a,s=arguments;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=s.length>3&&void 0!==s[3]&&s[3],s.length>2&&void 0!==s[2]&&s[2]&&(e="".concat(e,"_").concat(this._systemId)),o={key:e},t.next=7,this.db.getDataFromCollection({collection:"_keyValues",query:o,cache:!0,system:r,securedFields:n?["value"]:null});case 7:return i=t.sent,(a=this._.get(i,"body[0].value"))||this.developer.warning({message:"Missing static data for key",data:e}),t.abrupt("return",a);case 11:case"end":return t.stop()}}),t,this)}))),function(t,e){return w.apply(this,arguments)})},{key:"getEncryptedStaticData",value:(_=Kn(qn().mark((function t(e,r){var n,o=arguments;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=o.length>2&&void 0!==o[2]&&o[2],t.abrupt("return",this.getStaticData(e,r,n,!0));case 2:case"end":return t.stop()}}),t,this)}))),function(t,e){return _.apply(this,arguments)})},{key:"getSystemStaticData",value:(b=Kn(qn().mark((function t(e){var r,n=arguments;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=n.length>1&&void 0!==n[1]&&n[1],t.abrupt("return",this.getStaticData(e,!0,r));case 2:case"end":return t.stop()}}),t,this)}))),function(t){return b.apply(this,arguments)})},{key:"saveStaticData",value:(g=Kn(qn().mark((function t(e,r){var n,o;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n={key:e},o={value:r},t.next=5,this.db.updateDataInCollection({collection:"_keyValues",document:o,query:n,cache:!0});case 5:case"end":return t.stop()}}),t,this)}))),function(t,e){return g.apply(this,arguments)})},{key:"recordActivity",value:(m=Kn(qn().mark((function t(e){var r,n,o,i,s,c,u,l,h,f,d,p,y,v,m,g;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.onMatching,n=void 0!==r&&r,o=e.stamp,t.next=3,this.developer.debug({message:"Logging activity",data:{activeIntent:this.activeIntent,toCustomCap:this.toCustomCap}});case 3:if(""===this.activeIntent||this.toCustomCap){t.next=17;break}return f=Object.keys(this.responsesArray).length>0,d=f||n?0:1,p={controlId:null===(i=this.messageFromUser)||void 0===i?void 0:i.controlId,formId:null===(s=this.messageFromUser)||void 0===s?void 0:s.formId,action:null===(c=this.messageFromUser)||void 0===c?void 0:c.action,tableId:null===(u=this.messageFromUser)||void 0===u?void 0:u.tableId,currentField:null===(l=this.messageFromUser)||void 0===l?void 0:l.currentField,selectedEntry:null===(h=this.messageFromUser)||void 0===h?void 0:h.selectedEntry,messageTypeFromUser:this.messageTypeFromUser},y={botId:this.botId,userId:this.user.userId,botName:this.botName,userEmail:this.user.userEmail,timestamp:Date.now(),intent:this.activeIntent,migrated:!1,messageId:this.messageId,domain:this.currentUserDomain,messageFromUserMetadata:p,location:this.location,client:this.client,appVersion:this.appVersion,osVersion:this.osVersion,brand:this.brand,phoneModel:this.phoneModel,platform:this.platform,userAgent:this.userAgent,direction:d,stamp:o},f&&!n&&(v=[],this.responsesArray.forEach((function(t){var e,r,n={type:null==t?void 0:t.type,controlId:null==t||null===(e=t.message)||void 0===e||null===(e=e.options)||void 0===e?void 0:e.controlId,action:null==t||null===(r=t.message)||void 0===r||null===(r=r.options)||void 0===r?void 0:r.action};v.push(n)})),y.responsesArray=v),m={messageId:y.messageId,direction:d},g={upsert:!0},t.next=13,this.developer.debug({message:"Storing activity",data:y});case 13:return t.next=15,this.db.updateDataInCollection({collection:a,document:y,query:m,options:g,audit:!1,cache:!1,system:!0,asyncCall:!0});case 15:return t.next=17,this.db.updateDataInCollection({collection:a,document:y,query:m,options:g,audit:!0,cache:!0,asyncCall:!0});case 17:case"end":return t.stop()}}),t,this)}))),function(t){return m.apply(this,arguments)})},{key:"nlpResults",get:function(){return this._nlpResults},set:function(t){this._nlpResults=t}},{key:"previousActiveIntent",get:function(){var t=this._intentHistory.length,e="";return t>1?e=""===this._activeIntent?this._intentHistory[t-1]:this._intentHistory[t-2]:1===t&&""===this._activeIntent&&(e=this._intentHistory[0]),e}},{key:"online",value:function(){if(this.client!==yt&&this.client!==mt||this.location!==gt||this.v1Compatibility)return Promise.resolve(!0);try{var t;return"function"==typeof(null===(t=this.context.getCapability("Network"))||void 0===t?void 0:t.isOnline)?Promise.resolve(this.context.getCapability("Network").isOnline()):this.context.getCapability("Network").isConnected().then((function(t){return t})).catch((function(){return!1}))}catch(t){console.log("Error checking for online status "+t.message)}}},{key:"logout",value:(v=Kn(qn().mark((function t(e){return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.logoutInProcess=!0,t.prev=1,t.next=4,this.context.getCapability("authContext").logout(this.context);case 4:console.log("Logout executed"),this.addResponse("silent",{}),t.next=12;break;case 8:t.prev=8,t.t0=t.catch(1),console.log("Error during logout"),console.log(JSON.stringify(t.t0));case 12:case"end":return t.stop()}}),t,this,[[1,8]])}))),function(t){return v.apply(this,arguments)})},{key:"runLocationVerification",value:function(t,e){var r=e===this.location;return r||this.addErrorToStack(1,"Method "+t+" cannot run on the "+this.location),r}},{key:"getUserRolesForDomain",value:function(t){var e,r=function(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return Gn(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Gn(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return a=t.done,t},e:function(t){s=!0,i=t},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw i}}}}(this.userDomains);try{for(r.s();!(e=r.n()).done;){var n=e.value;if(n.domain===t)return n.roles}}catch(t){r.e(t)}finally{r.f()}}},{key:"setContext",value:function(t){var e,r;if(this.context=t,this.location===gt){this.userName=this.user.info.userName,this.user.userName=this.user.info.userName;var n=this.context.getCapability("Utils");if(this._=n.Lodash,this.R=this.context.getCapability("R")||{},this.immutable=this.context.getCapability("Immutable")||{},this.messageTypes=this.context.getCapability("MessageTypeConstants"),this.MessageCapability=this.context.getCapability("Message"),this.userDomains=this.user.info.domains,this.moment=this.context.getCapability("Moment"),this.momentTimezone=this.context.getCapability("MomentTimezone"),this.client===vt){this.aws=this.context.getCapability("aws"),this.frontmlib=this.context.getCapability("frontmlib");var o=this.context.capabilities.capabilities;this.sha1=o?this.context.capabilities.sha1:this.context.sha1}else this.sha1=this.context.getCapability("sha1");this.currentWorkspace=this.user.info.lastLoggedInDomain}else this._=this.context._,this.R=this.context.R||{},this.immutable=this.context.immutable||{},this.userDomains=this.user.userDomains,this.moment=this.context.moment,this.momentTimezone=this.context.momentTimeZone,this.aws=this.context.aws,this.frontmlib=this.context.frontmlib,this.sha1=this.context.sha1,this.marked=this.context.marked;this.user.roles=this.getUserRolesForDomain(this.currentUserDomain),this.systemId=(null===(e=this.context)||void 0===e||null===(e=e.botManifest)||void 0===e?void 0:e.systemId)||null,this.developer.runProfile=(null===(r=this.context)||void 0===r||null===(r=r.botManifest)||void 0===r?void 0:r.buildType)||re.DEV()}},{key:"syncWithBackendState",value:function(t){var e=this,r=this._;this.messageTypeFromUser===Le.BACKEND_RESPONSE()&&(t.intentResolved&&(this.intentResolved=t.intentResolved),t.responsesArray&&r.each(t.responsesArray,(function(t){if("form2"===t.type){var r={};r.options=t.message.options,r.fields=t.message.fields,e.addResponse("form2",r)}else e.responsesArray.push(t)})),t._activeIntent&&this.addActiveIntent(t._activeIntent),t._silentIntent&&(this._silentIntent=!0),t.nlpResponse&&(this.nlpResponse=t.nlpResponse),t._nlpResults&&(this._nlpResults=t._nlpResults,this._lastNLPResults=t._nlpResults),t.errorStack&&r.each(t.errorStack,(function(t){e.addErrorToStack(t._errorCode,t._errorMessage)})),t.smartSuggestionsArray&&(this.smartSuggestionsArray=t.smartSuggestionsArray),r.size(t.fieldsChanged)&&(this.fields=this.R.merge(this.fields,t.fieldsChanged)),t.fieldsCleared&&Array.isArray(t.fieldsCleared)&&t.fieldsCleared.length>0&&r.forEach(t.fieldsCleared,(function(t){delete e.fields[t]})),t.sendMessageParam&&(this.sendMessageParam=t.sendMessageParam),t._blockSuggestions&&(this.blockSuggestions=!0),Array.isArray(t.requestIdsArray)&&(this.requestIdsArray=this.requestIdsArray.concat(t.requestIdsArray)),t._intentDurations&&(this._intentDurations=t._intentDurations),"boolean"==typeof t._conversational&&(this._conversational=t._conversational),t._background&&(this._background=t._background),t._sidebar&&(this._sidebar=t._sidebar),t._navbar&&(this._navbar=t._navbar),t.fromGreeting&&(this.fromGreeting=t.fromGreeting),t._inSilence&&(this._inSilence=t._inSilence),t.currentTabId&&(this.currentTabId=t.currentTabId),r.size(t._dynamicIntents)>0&&(this._dynamicIntents=t._dynamicIntents),this._syncToEdge=t._syncToEdge,this.autoSaveBufferChanges=t.autoSaveBufferChanges,t.backendResponseType&&(this.backendResponseType=t.backendResponseType),this.responseToClient=t.responseToClient)}},{key:"getNewRequestId",value:function(){return this.getUniqueId}},{key:"getAllProperties",value:function(){var t=this._,e={conversationId:this.conversationId,toCustomCap:this.toCustomCap,intentResolved:this.intentResolved,waitingCustomCap:this.waitingCustomCap,lastGreetingTime:this.lastGreetingTime,lastUserActivity:this.lastUserActivity,_intentDurations:this._intentDurations};return e.errorStack=this.errorStack,e.requestIdsArray=this.requestIdsArray,e.fields=this.fields,e._silentIntent=this._silentIntent,e._lastNLPResults=this._lastNLPResults,e._background=this._background,e._conversational=this._conversational,e._sidebar=this._sidebar,e._inputHistory=this._inputHistory,e._routesQueue=this._routesQueue,this.developer._debugMode&&(e._debugMode=!0),e._intentHistory=this._intentHistory,e.fromGreeting=this.fromGreeting,e._inSilence=this._inSilence,t.size(this._dynamicIntents)>0&&(e._dynamicIntents=this._dynamicIntents),e._delayedNotification=t.clone(this._delayedNotification)||[],e._syncToCloud=t.clone(this._syncToCloud),e.autoSaveBufferChanges=this.autoSaveBufferChanges,e}},{key:"autoSaveBufferKey",get:function(){return this.currentTabId?"".concat(n,"_").concat(this.currentTabId):n}},{key:"loadAutoSaveBuffer",value:function(){var t=this,e=this._;return this.developer,this.getPersistedField(this.autoSaveBufferKey).then((function(r){r&&e.forEach(e.keys(r),(function(e){t.autoSaveBuffer[e]=r[e]}))}))}},{key:"storeAutoSaveBuffer",value:function(){if(this.autoSaveBuffer)return this.setPersistedField(this.autoSaveBufferKey,this.autoSaveBuffer)}},{key:"clearAutoSaveBuffer",value:function(){this.autoSaveBuffer={}}},{key:"clearAutoSaveBufferChanges",value:function(){this.autoSaveBufferChanges={}}},{key:"resetAutoSaveBuffer",value:(y=Kn(qn().mark((function t(){return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.clearPersistedField(this.autoSaveBufferKey);case 2:case"end":return t.stop()}}),t,this)}))),function(){return y.apply(this,arguments)})},{key:"addObjectToSyncMessage",value:function(t,e,r){var n=this.sha1(e);if(this.location===bt){var o=this._syncToEdge[t]||{};o[n]=r,this._syncToEdge[t]=o}else{var i=this._syncToCloud[t]||{};i[n]=r,this._syncToCloud[t]=i}}},{key:"addDelayedNotification",value:function(t){Array.isArray(this._delayedNotification)?this._delayedNotification.push(t):this._delayedNotification=[t]}},{key:"syncDataToDB",value:function(){var t=this,e=this._;if(this.client!==vt){var r=[];return e.forEach(this._syncToCloud,(function(n,i){var a=t._intents[i];(a||i===o)&&e.forEach(n,(function(n,s){if(i===o)r.push(t.db.setOneValueInCacheWithExpiry(s,n,604800).catch((function(e){t.addSystemErrorToStack(42,"",e)})));else{var c=e.get(n,"body");e.forEach(c,(function(e){var n=a.document;n.hasSubDocs?n.buildDocumentFromContainer(e):n.buildDocument(e),r.push(n.save(!0).catch((function(e){t.addSystemErrorToStack(42,"",e)})))}))}}))})),r.length>0?Promise.all(r).then((function(){t._syncToCloud={}})).catch((function(e){t.addSystemErrorToStack(42,"",e)})):Promise.resolve()}}},{key:"sendDelayedNotifications",value:function(){var t=this;if(this.location===bt&&this.client!==vt){var e=[];return this._.forEach(this._delayedNotification,(function(r){"aagehempel"!==r.userDomain&&"aagehempeltest"!==r.userDomain||t.developer.log({message:"AHG sendDelayedNotifications",data:JSON.stringify(r)}),e.push(t.notification.sendDelayedNotification(r))})),this._delayedNotification=[],e.length>0?Promise.all(e):Promise.resolve()}return Promise.resolve()}},{key:"removeObjectFromSyncMessage",value:function(t,e){var r=this.sha1(e);this.location===bt?delete this._syncToEdge[t][r]:delete this._syncToCloud[t][r]}},{key:"runFunctionOnceAnHour",value:function(t){var e=this._,r=e.now();if(e.toNumber(r)-e.toNumber(this.lastGreetingTime)>36e5)return this.lastGreetingTime=r,t()}},{key:"runFunctionOnceADay",value:function(t){var e=this._,r=e.now();if(e.toNumber(r)-e.toNumber(this.lastGreetingTime)>864e5)return this.lastGreetingTime=r,t()}},{key:"getDeviceLocation",value:function(){return this.context.getCapability("DeviceLocation").getDeviceLocation()}},{key:"sendMessage",value:function(t){this.developer.log({message:"User sending message with "+JSON.stringify(t)}),this.sendMessageParam=t}},{key:"continueInIntentWithIdAndMessage",value:function(t,e){var r={intentId:t};this.sendMessage(Bn(Bn({},r),e))}},{key:"processIntentWithIdAndMessage",value:function(t,e){this.continueInIntentWithIdAndMessage(t,e)}},{key:"processIntentWithId",value:function(t){var e={intentId:t};this.sendMessage(e)}},{key:"cleanFieldsForSave",value:function(t){var e=this,r=this._,n={};if("string"==typeof t)return""===t&&(t=" "),t;if("object"!==Mn(t))return t;if(Array.isArray(t)){var o=[];return r.each(t,(function(t){var r=e.cleanFieldsForSave(t);o.push(r)})),o}for(var i in t){var a=t[i];switch(Mn(a)){case"string":case"object":n[i]=this.cleanFieldsForSave(a);break;default:n[i]=a}}return n}},{key:"save",value:function(t){var e=this;if(this._persistentState)return this.fields=this.cleanFieldsForSave(this.fields),this._lastNLPResults=this.cleanFieldsForSave(this._lastNLPResults),t.setInContext(this.getAllProperties(),this.context).then((function(){e.developer.info({message:"State saved"}),e.error=!1})).catch((function(t){e.developer.info({message:"Error saving the state: ".concat(t.message)}),e.error=!0}))}},{key:"getUniqueId",value:function(){try{return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("y"===t?3&e|8:e).toString(16)}))}catch(t){console.log("Error generating UUID"),console.log(JSON.stringify(t))}}},{key:"setField",value:function(t,e){this.fields[t]=e,this.fieldsChanged[t]=e;var r=this.fieldsCleared.indexOf(t);r>-1&&this.fieldsCleared.splice(r,1)}},{key:"commonSetFieldLogic",value:function(t,e,r){this.addObjectToSyncMessage(o,t,e);var n=this.sha1(t);if(this.location===bt||this.client===vt||this.location===gt&&this.v1Compatibility){var i=r||604800;return this.db.setOneValueInCacheWithExpiry(n,e,i)}return this.deviceStorage.saveKeyInStorage(n,e)}},{key:"commonGetFieldLogic",value:(p=Kn(qn().mark((function t(e){var r,n,o;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=this._,!(this.location===bt||this.client===vt||this.location===gt&&this.v1Compatibility)){t.next=15;break}return t.next=4,this.db.getValueFromCache(e);case 4:if(!(n=t.sent)){t.next=13;break}return t.prev=6,t.abrupt("return",JSON.parse(r.get(n,"content")));case 10:return t.prev=10,t.t0=t.catch(6),t.abrupt("return",r.get(n,"content"));case 13:t.next=19;break;case 15:return t.next=17,this.deviceStorage.getKeyFromStorage(e);case 17:return o=t.sent,t.abrupt("return",o);case 19:case"end":return t.stop()}}),t,this,[[6,10]])}))),function(t){return p.apply(this,arguments)})},{key:"commonClearFieldLogic",value:(d=Kn(qn().mark((function t(e){return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(this.location===bt||this.client===vt||this.location===gt&&this.v1Compatibility)){t.next=5;break}return t.next=3,this.db.deleteOneKeyInCache(e);case 3:t.next=7;break;case 5:return t.next=7,this.deviceStorage.removeKeyFromStorage(e);case 7:case"end":return t.stop()}}),t,this)}))),function(t){return d.apply(this,arguments)})},{key:"setSharedField",value:function(t,e,n){var o="".concat(r,"_").concat(t);return this.commonSetFieldLogic(o,e,n)}},{key:"getSharedField",value:function(t){var e=this.sha1("".concat(r,"_").concat(t));return this.commonGetFieldLogic(e)}},{key:"clearSharedField",value:function(t){var e="".concat(r,"_").concat(t);return this.commonClearFieldLogic(this.sha1(e))}},{key:"setPersistedField",value:function(t,e){var n="".concat(r).concat(this.conversationId,"_").concat(t);return this.commonSetFieldLogic(n,e,604800)}},{key:"getPersistedField",value:function(t){var e="".concat(r).concat(this.conversationId,"_").concat(t);return this.commonGetFieldLogic(this.sha1(e))}},{key:"clearPersistedField",value:function(t){var e="".concat(r).concat(this.conversationId,"_").concat(t);return this.commonClearFieldLogic(this.sha1(e))}},{key:"getPersistedFields",value:(f=Kn(qn().mark((function t(e){var n,o,i,a,s,c,u,l,h,f=this;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=this._,!Array.isArray(e)){t.next=26;break}if(o=[],i={},!(this.location===bt||this.client===vt||this.location===gt&&this.v1Compatibility)){t.next=13;break}for(a=0;a<e.length;a++)s="".concat(r).concat(this.conversationId,"_").concat(e[a]),o.push(this.sha1(s));return t.next=8,this.db.getMultipleValuesFromCache(o);case 8:c=t.sent,this.developer.log({message:"Content from Redis",data:c}),c&&n.forEach(o,(function(t){var o=c[t];if(o)try{var a="",s=n.findIndex(e,(function(e){var n="".concat(r).concat(f.conversationId,"_").concat(e);return a=e,t===f.sha1(n)}));-1!==s&&(i[a]=JSON.parse(n.get(o,"content")))}catch(t){f.addSystemErrorToStack(39,null,t.message),f.developer.log({message:"Data from Redis",data:n.get(o,"content")})}})),t.next=23;break;case 13:u=0;case 14:if(!(u<e.length)){t.next=23;break}return l="".concat(r).concat(this.conversationId,"_").concat(e[u]),t.next=18,this.deviceStorage.getKeyFromStorage(this.sha1(l));case 18:(h=t.sent)&&(i[e[u]]=h);case 20:u++,t.next=14;break;case 23:return t.abrupt("return",i);case 26:return this.addSystemErrorToStack(7,"getPersistedFields: fieldNames parameter must be an array"),t.abrupt("return",null);case 28:case"end":return t.stop()}}),t,this)}))),function(t){return f.apply(this,arguments)})},{key:"clearField",value:function(t){delete this.fields[t],this.fieldsCleared.push(t)}},{key:"getField",value:function(t){var e=this.fields[t];return void 0!==e?e:null}},{key:"hasFieldInPath",value:function(t){return!!this.R.path(t,this.fields)}},{key:"addSmartSuggestions",value:function(t){this.smartSuggestionsArray.push(t)}},{key:"addSmartSuggestionsArray",value:function(t){var e=this;this.developer.log({message:"Adding smart suggestions",data:t}),this._.each(t,(function(t){t.lang===e.lang&&(e.smartSuggestionsArray=e.smartSuggestionsArray.concat(t.list))}))}},{key:"addEnglishSmartSuggestions",value:function(t){var e=[{lang:"en",list:t}];this.addSmartSuggestionsArray(e)}},{key:"blockSuggestions",get:function(){return this._blockSuggestions},set:function(t){this._blockSuggestions=t}},{key:"clearSmartSuggestionsArray",value:function(){this.smartSuggestionsArray=[],this._blockSuggestions=!1}},{key:"addActiveIntent",value:function(t){var e=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._silentIntent=n,this._activeIntent=t,r&&this._intentHistory.push(t),function t(){e._intentHistory.length>10&&(e._intentHistory.splice(0,1),t())}()}},{key:"removeActiveIntent",value:function(){""!==this._activeIntent&&(this._activeIntent="")}},{key:"addSystemErrorToStack",value:function(t,e,r){var n=new Ht(this,t,e);this.developer.systemError({message:n.errorMessage,errorCode:t,data:r}),this.errorStack.push(n)}},{key:"addErrorToStack",value:function(t,e,r){var n;n=new Ht(this,t<999?1e3:t,e),this.developer.userError({message:n.errorMessage,errorCode:t,data:r}),this.errorStack.push(n)}},{key:"inError",get:function(){return this._.size(this.errorStack)>0}},{key:"clearError",value:function(){this.errorStack=[]}},{key:"addStringResponse",value:function(t){this.addResponse("string",t)}},{key:"addStandardNotificationResponse",value:function(t){this.addResponse("standard_notification",t)}},{key:"addCriticalNotificationResponse",value:function(t){this.addResponse("critical_notification",t)}},{key:"addAuthorizationRequestResponse",value:function(t){this.addResponse("authorization_request",t)}},{key:"addFormResponse",value:function(t){this.addResponse("form2",t)}},{key:"addShortFormResponse",value:function(t){this.addResponse(Le.SHORT_FORM_RESPONSE(),t)}},{key:"addFormChangeResponse",value:function(t){this.addResponse("form_live_changes",t)}},{key:"addInLineFormChangeResponse",value:function(t){this.addResponse("table_live_changes",t)}},{key:"addMapResponse",value:function(t){this.addResponse("map",t)}},{key:"addChartResponse",value:function(t){this.addResponse("chart",t)}},{key:"addTableResponse",value:function(t){this.addResponse("table",t)}},{key:"addShortTableResponse",value:function(t){this.addResponse(Le.SHORT_TABLE_RESPONSE(),t)}},{key:"addTrackingViewResponse",value:function(t){this.addResponse("trackerForm",t)}},{key:"addCardsResponse",value:function(t){this.addResponse("cards",t)}},{key:"addHTMLResponse",value:function(t){this.addResponse("html",{message:{},options:t})}},{key:"addContainerResponse",value:function(t){this.addResponse("container",t)}},{key:"addVideoCallResponse",value:function(t){this.addResponse("videoCall",t)}},{key:"addVoiceCallResponse",value:function(t){this.addResponse(Le.MESSAGE_VOICE_CALL(),t)}},{key:"addMenuResponse",value:function(t){this.addResponse("menuMessage",t)}},{key:"addTimelinesResponse",value:function(t){this.addResponse(Le.MESSAGE_TYPE_TIMELINE_LIST(),t)}},{key:"addTimelinePostResponse",value:function(t){this.addResponse(Le.MESSAGE_TYPE_TIMELINE_POST(),t)}},{key:"addSoundResponse",value:function(t){var e=t;t||(e={sound:"FrontM_Ring.mp3"}),this.addResponse("sound",e)}},{key:"addCsvResponse",value:function(t){this.addResponse("csv",t)}},{key:"addSurveyResponse",value:function(t){this.addResponse(Le.MESSAGE_TYPE_SURVEY(),t)}},{key:"addDashboardResponse",value:function(t){this.addResponse(Le.DASHBOARD(),t)}},{key:"addTCPResponse",value:function(t,e,r){if(this.client===yt){var n={dest_ip:e,dest_port:r,msg:t};this.context.getCapability("TCP").sendMessage(n)}else this.addSystemErrorToStack(5,"Message type not supported on this client")}},{key:"addAiccResponse",value:function(t){this.addResponse(Le.MESSAGE_TYPE_AICC_STRING(),t)}},{key:"addRunModeResponse",value:(h=Kn(qn().mark((function t(){var e,r,n;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.client!==vt||this.v1Compatibility){t.next=2;break}return t.abrupt("return");case 2:return e={background:this.background,sidebar:this.sidebar,navbar:this.navbar,chatButtonHidden:this.chatButtonHidden,waitingIcon:this._waitingIcon,cssFilePath:this._cssFilePath,suggestionsLayout:this._suggestionsLayout,modal:this._modal},r=this.context.getCapability("Message"),(n=new r).runMode(e),t.next=8,this.context.tell(n);case 8:case"end":return t.stop()}}),t,this)}))),function(){return h.apply(this,arguments)})},{key:"addStringResponseFromArray",value:function(t){var e=!1;if(Array.isArray(t)){var r=t[Math.round(Math.random()*(t.length-1))];"string"==typeof r?this.addResponse("string",r):e=!0}else e=!0;e&&this.addErrorToStack(23,Ht.getErrorMessageforCodeAndLang(23,this.lang))}},{key:"addSilentResponse",value:function(){this.developer.info({message:"Adding Silent response"}),this.addResponse("silent",{})}},{key:"addResponse",value:function(t,e){this.developer.runProfile&&("string"===t?this.developer.info({message:"Added response "+e}):this.developer.info({message:"Added message type "+t})),e?(e.options?(null!==this.currentControlId&&(e.options.parentControlId=this.currentControlId),this.currentTabId&&(e.options.tabId=this.currentTabId),e.options.controlId||(e.options.controlId=this.getUniqueId())):e.tabId&&this.currentTabId&&(e.tabId=this.currentTabId),this.responsesArray.push({type:t,message:e,messageId:this.getUniqueId()})):this.addSystemErrorToStack(14,t)}},{key:"clearRoutesQueue",value:function(){this._routesQueue={}}},{key:"clearResponseArray",value:function(){this.responsesArray=[]}},{key:"setWaitingCustomCap",value:function(){this.silentIntent||(this.waitingCustomCap+=1)}},{key:"resetWaitingForCustomCapCounter",value:function(){this.waitingCustomCap=0}},{key:"addRequestId",value:function(t){this.requestIdsArray.unshift(t),this.requestIdsArray.length>10&&this.requestIdsArray.pop()}},{key:"markRequestIdProcessed",value:function(t){return-1===this.requestIdsArray.indexOf(t)&&(this.addRequestId(t),this.waitingCustomCap>0&&(this.waitingCustomCap-=1),!0)}},{key:"stateToBackEnd",value:function(){var t=this._,e={lang:this.lang,intentResolved:this.intentResolved,messageTypeFromUser:this.messageTypeFromUser,messageFromUser:this.messageFromUser,messageIdFromUser:this.messageIdFromUser,messageTypeIntFromUser:this.messageTypeIntFromUser,messageCreatedOnFromUser:this.messageCreatedOnFromUser,messageCreatedByFromUser:this.messageCreatedByFromUser,messageContentFromUser:this.messageContentFromUser,messageOptionsFromUser:this.messageOptionsFromUser,userName:this.userName,tz:this.user.tz,fields:this.fields,_intentHistory:this._intentHistory};return this.fromGreeting&&(e.fromGreeting=this.fromGreeting),""!==this._activeIntent&&(e._activeIntent=this._activeIntent),""!==this._intentDurations&&(e._intentDurations=this._intentDurations),this.developer._debugMode&&(e._debugMode=!0),e.client=this.client,e.client=this.client,e.currentWorkspace=this.currentWorkspace,e._inSilence=this._inSilence,t.size(this._dynamicIntents)>0&&(e._dynamicIntents=this._dynamicIntents),e._syncToCloud=this._syncToCloud,Array.isArray(this._delayedNotification)&&this._delayedNotification.length>0&&(e._delayedNotification=t.clone(this._delayedNotification),this._delayedNotification=[]),e.autoSaveBufferChanges=this.autoSaveBufferChanges,e.osVersion=this.osVersion,e.brand=this.brand,e.phoneModel=this.phoneModel,e.platform=this.platform,e.userAgent=this.userAgent,e.reportActivityOnMain=this.reportActivityOnMain,{state:e}}},{key:"getFinalResponsesArray",value:function(){var t=this._,e={};return this.nlpResponse&&(e.nlpResponse=this.nlpResponse),this._nlpResults&&(e._nlpResults=this._nlpResults),t.size(this.errorStack)>0&&(e.errorStack=this.errorStack),t.size(this.responsesArray)>0&&(e.responsesArray=this.responsesArray),this.smartSuggestionsArray&&t.size(this.smartSuggestionsArray)>0&&(e.smartSuggestionsArray=this.smartSuggestionsArray),this.intentResolved&&(e.intentResolved=this.intentResolved),e.responseToClient=this.client,this.sendMessageParam&&(e.sendMessageParam=this.sendMessageParam),e}},{key:"getFinalResponseState",value:function(){var t=this._,e={};return""!==this._activeIntent&&(e._activeIntent=this._activeIntent),e.fieldsChanged=this.fieldsChanged,e.fieldsCleared=this.fieldsCleared,this.developer._debugMode&&(e._debugMode=!0),this.blockSuggestions&&(e._blockSuggestions=!0),this.silentIntent&&(e._silentIntent=!0),this.clearPrompt&&(e.clearPrompt=!0),this.requestIdsArray.length>0&&(e.requestIdsArray=this.requestIdsArray),this._intentDurations&&(e._intentDurations=this._intentDurations),this._autoSavePresent&&(e._autoSavePresent=this._autoSavePresent),this.fromGreeting&&(e._conversational=this._conversational,e._background=this._background,e._sidebar=this._sidebar,e.fromGreeting=this.fromGreeting),this._inSilence&&(e._inSilence=this._inSilence),t.size(this._dynamicIntents)>0&&(e._dynamicIntents=this._dynamicIntents),this.currentTabId&&(e.currentTabId=this.currentTabId),e.backendResponseType=1,e.responseToClient=this.client,e}},{key:"getFinalResponseSync",value:function(){this._;var t={};return t._syncToEdge=this._syncToEdge,t.autoSaveBufferChanges=this.autoSaveBufferChanges,t.backendResponseType=2,t.responseToClient=this.client,t}},{key:"sizeOfObject",value:function(t){try{var e={symbol:function(){return 0},function:function(){return 0},undefined:function(){return 0},boolean:function(){return 4},number:function(){return 8},string:function(t){return 2*t.length},object:function(t){return t?Object.keys(t).reduce((function(e,n){return r(n)+r(t[n])+e}),0):0}},r=function(t){return e[Mn(t)](t)};return r(t)}catch(t){return 0}}},{key:"conversational",get:function(){return this._conversational},set:function(t){this._conversational=t}},{key:"waitingIcon",get:function(){return this._waitingIcon},set:function(t){this._waitingIcon=t}},{key:"background",get:function(){return this._background},set:function(t){this._background=t}},{key:"sidebar",get:function(){return this._sidebar},set:function(t){this._sidebar=t}},{key:"navbar",get:function(){return this._navbar},set:function(t){this._navbar=t}},{key:"systemId",get:function(){return this._systemId},set:function(t){this._systemId=t}},{key:"cssFilePath",get:function(){return this._cssFilePath},set:function(t){this._cssFilePath=t}},{key:"intentHistory",get:function(){return this.intentHistory}},{key:"getGreetingIntent",value:function(){if(this._intents[Ot])return this._intents[Ot]}},{key:"currentUserDomain",get:function(){return this.conversation.userDomain}},{key:"isPublic",get:function(){return"Anon_"===this.user.userName.substring(0,5)}},{key:"unitTestMode",get:function(){return this._unitTestMode},set:function(t){this._unitTestMode=!0}},{key:"silenceBot",value:function(){this._inSilence=!0}},{key:"wakeUpBot",value:function(){this._inSilence=!1}},{key:"resumeBot",value:function(){this._inSilence=!1}},{key:"setVerticalSuggestions",value:function(){this._suggestionsLayout="vertical"}},{key:"inSilence",get:function(){return this._inSilence}},{key:"modal",get:function(){return this._modal},set:function(t){this._modal=t}},{key:"currentControlId",get:function(){return this._currentControlId},set:function(t){this._currentControlId=t}},{key:"addUserToConversation",value:(l=Kn(qn().mark((function t(e){var r,n,o,i;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.conversationId,n=void 0===r?this.conversationId:r,o=e.userEmail,t.next=3,this.frontmlib.getUserByEmail(o);case 3:if(null==(i=t.sent)||!i.userId){t.next=9;break}return t.next=7,this.addMeToTheConversation(n,i.userId);case 7:t.next=10;break;case 9:Qn.warning({message:"User ".concat(o," doesn't exist")});case 10:case"end":return t.stop()}}),t,this)}))),function(t){return l.apply(this,arguments)})},{key:"addMeToTheConversation",value:(u=Kn(qn().mark((function t(e,r){var n,o,i,a,s,c,u,l,h,f;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=this._,o="Conversations",i=[{operand:"conversationId",value:e,operator:"eq"},{operand:"userDomain",value:this.currentUserDomain,operator:"eq"}],t.next=5,this.db.getData(o,i);case 5:if(!(a=t.sent).items){t.next=22;break}if(s=n.get(a.items[0],"participants"),c=r||this.user.userId,-1!==s.indexOf(c)){t.next=22;break}return s.push(c),u=[{key:{conversationId:e,userDomain:this.currentUserDomain},document:{participants:s}}],t.next=14,this.db.writeData(o,u);case 14:return l="Conversations_"+e+"_"+this.currentUserDomain,t.next=17,this.db.getValueFromCache(l);case 17:return h=t.sent,(f=JSON.parse(h.content)).participants=s,t.next=22,this.db.setOneValueInCache(l,f);case 22:case"end":return t.stop()}}),t,this)}))),function(t,e){return u.apply(this,arguments)})},{key:"setIntentWithId",value:function(t,e){this._intents[t]||(this._intents[t]=e)}},{key:"addDynamicIntent",value:function(t){this._dynamicIntents[t.id]=t}},{key:"clearDynamicIntents",value:function(){this._dynamicIntents={}}},{key:"dynamicIntents",get:function(){return this._dynamicIntents}},{key:"intents",get:function(){return this._intents}},{key:"createAutoSaveIntent",value:function(t,e){var r=this,n=this._,o=new At(t);e===gt?o.onMatching=function(){return r.client!==vt&&"autoSaveIntentEdge"===n.get(r.messageFromUser,"intentId")}:(o.runOnCloud(),o.onMatching=function(){return r.client!==vt&&"autoSaveIntentCloud"===n.get(r.messageFromUser,"intentId")}),o.onResolution=Kn(qn().mark((function t(){var e,n,o,i,a,s;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=r._,n=e.get(r.messageFromUser,"tabId"),o=e.get(r.messageFromUser,"value"),i=e.get(r.messageFromUser,"field"),a=r.autoSaveBuffer,n&&(s=e.get(a,n,{}),o?s[i]=o:s[i]&&delete s[i],a[n]=s);case 6:case"end":return t.stop()}}),t)}))),this.setIntentWithId(o.intentId,o),this.addSilentResponse()}},{key:"bot",value:function(t){var e=this,r=this._,n=(this.developer,t(this));if(Array.isArray(n)&&n.length>0)return r.forEach(n,(function(t){e.setIntentWithId(t.intentId,t)})),n;var o,i,a=(i={},r.forEach(e._dynamicIntents,(function(t){if("Doc"===r.get(t,"type")){var n=t.id,o=t.options,a=new Doc(n,e,{title:o.title,description:o.description,confirm:o.confirm,cancel:o.cancel});a.onSubmit=Kn(qn().mark((function t(){return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a.save();case 2:case"end":return t.stop()}}),t)}))),i[n]=a}})),r.forEach(e._dynamicIntents,(function(t){if("Field"===r.get(t,"type")){var n=r.get(t,"options.doc"),a=e._intents[n];if(a){var s=In.createNewDynamicField(r.get(t,"options"),a,e);i[r.get(t,"id")]=s}}else if("Collection"===r.get(t,"type")){var c=r.get(t,"id"),u=r.get(t,"options.title"),l=r.get(t,"options.description"),h=r.get(t,"options.document");e._intents[h]&&(o=new jn(c,{document:e._intents[h],title:u,description:l,state:e}),i[c]=o)}})),i),s=Bn(Bn({},this._intents),a);return r.values(s)}},{key:"sendMessageToQueue",value:(c=Kn(qn().mark((function t(e,r){var n;return qn().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.location!==bt){t.next=12;break}return t.prev=1,n={message:JSON.stringify(r),sqsQueue:e},t.next=5,this.frontmlib.invokeLambda("SendSQSMessages","Event",n);case 5:t.next=10;break;case 7:t.prev=7,t.t0=t.catch(1),this.addSystemErrorToStack(7,"Error sending SQS message",t.t0);case 10:t.next=13;break;case 12:this.addSystemErrorToStack(55);case 13:case"end":return t.stop()}}),t,this,[[1,7]])}))),function(t,e){return c.apply(this,arguments)})},{key:"sendResponseToClient",value:function(t){try{if(this.reportActivityOnMain)return;var e=Date.now(),r="AgentM",n=this.getUniqueId(),o={createdOn:e,createdBy:r,contentType:150,messageId:n,message:t},i={queueMsgs:[{userId:this.user.userId,userEmail:this.user.userEmail,conversation:this.conversationId,bot:this.botId,requestUuid:this.getUniqueId(),createdOn:e,createdBy:r,contentType:150,messageId:n,conversational:this.conversational,timeSensitiveMessage:this.timeSensitiveMode,details:[o]}]};return this.frontmlib.invokeLambda("RedisWriteQueue","RequestResponse",i)}catch(t){this.addSystemErrorToStack(7,"Error responding to backend",JSON.stringify(t))}}},{key:"persistentState",get:function(){return this._persistentState},set:function(t){this._persistentState=t}},{key:"persistentOfflineData",get:function(){return this._persistentOfflineData},set:function(t){this._persistentOfflineData=t}}],s=[{key:"SOCKET_RECONNECTION_EVENT",value:function(){return"onSocketReconnection"}}],i&&Yn(e.prototype,i),s&&Yn(e,s),Object.defineProperty(e,"prototype",{writable:!1}),t}(),Hn=new zn,Qn=Hn.developer;function Jn(t){return Jn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Jn(t)}function $n(){$n=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Jn(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Jn(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Xn(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function Zn(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Xn(i,n,o,a,s,"next",t)}function s(t){Xn(i,n,o,a,s,"throw",t)}a(void 0)}))}}function to(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Jn(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Jn(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Jn(o)?o:String(o)),n)}var o}function eo(t,e){return eo=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},eo(t,e)}function ro(t){return ro=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},ro(t)}Hn._,String.prototype.sendResponse=function(){Hn.addStringResponse(this.toString())};var no=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&eo(t,e)}(s,t);var e,r,n,o,i,a=(o=s,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=ro(o);if(i){var r=ro(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===Jn(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(this,t)});function s(t,e){var r,n=e.tabId,o=e.id,i=e.name,c=e.description,u=e.color,l=e.coordinates,h=e.state;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),(r=a.call(this,t,h,n)).onSave=Zn($n().mark((function t(){return $n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r.onDelete=Zn($n().mark((function t(){return $n().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))),r._id=o,r._name=i,r._description=c,r._color=u,r._coordinates=l,r}return e=s,r=[{key:"message",value:function(t){return{options:{controlId:this.intentId,tabId:this.tabId,id:this._id,name:this._name,description:this._description,color:this._color,action:t},coordinates:this._coordinates}}},{key:"onMatching",get:function(){var t=this;return function(e){return e.messageTypeFromUser===s.GEOFENCE_RESPONSE()&&e.messageFromUser.controlId===t.intentId}}},{key:"onResolution",get:function(){var t=this;return function(){var e=Zn($n().mark((function e(r){return $n().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.currentControlId=t.intentId,r.messageFromUser.action!==s.SAVE_ACTION()){e.next=6;break}return e.next=4,t.onSave();case 4:e.next=12;break;case 6:if(r.messageFromUser.action!==s.DELETE_ACTION()){e.next=11;break}return e.next=9,t.onDelete();case 9:e.next=12;break;case 11:r.addSystemErrorToStack(49,Ht.getErrorMessageforCodeAndLang(49));case 12:0===r.responsesArray.length&&r.addSilentResponse();case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}}],n=[{key:"GEOFENCE_MESSAGE",value:function(){return"geofence"}},{key:"GEOFENCE_RESPONSE",value:function(){return"geofence_response"}},{key:"SAVE_ACTION",value:function(){return"save"}},{key:"NEW_ACTION",value:function(){return"new"}},{key:"UPDATE_ACTION",value:function(){return"update"}},{key:"DISPLAY_ACTION",value:function(){return"display"}},{key:"DELETE_ACTION",value:function(){return"delete"}}],r&&to(e.prototype,r),n&&to(e,n),Object.defineProperty(e,"prototype",{writable:!1}),s}(At);function oo(t){return oo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},oo(t)}function io(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==oo(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==oo(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===oo(o)?o:String(o)),n)}var o}function ao(t,e){return function(t,e){return e.get?e.get.call(t):e.value}(t,so(t,e,"get"))}function so(t,e,r){if(!e.has(t))throw new TypeError("attempted to "+r+" private field on non-instance");return e.get(t)}var co=new WeakMap,uo=function(){function t(){var e,r,n;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),n={writable:!0,value:void 0},function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}(e=this,r=co),r.set(e,n),function(t,e,r){(function(t,e,r){if(e.set)e.set.call(t,r);else{if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=r}})(t,so(t,e,"set"),r)}(this,co,[])}var e,r;return e=t,(r=[{key:"isEmpty",value:function(){return 0===ao(this,co).length}},{key:"addMessage",value:function(t,e){if(!t||!e)return!1;ao(this,co).push({message:t,action:e})}},{key:"pollMessage",value:function(){return!this.isEmpty()&&ao(this,co).shift()}}])&&io(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),t}();function lo(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function ho(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?lo(Object(r),!0).forEach((function(e){wo(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):lo(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function fo(t){return fo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},fo(t)}function po(){po=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==fo(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(fo(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function yo(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function vo(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){yo(i,n,o,a,s,"next",t)}function s(t){yo(i,n,o,a,s,"throw",t)}a(void 0)}))}}function mo(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,So(n.key),n)}}function go(t,e){return go=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},go(t,e)}function bo(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _o(t){return _o=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},_o(t)}function wo(t,e,r){return(e=So(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function So(t){var e=function(t,e){if("object"!==fo(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==fo(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===fo(e)?e:String(e)}var ko=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&go(t,e)}(v,t);var e,r,n,o,i,a,s,c,u,l,h,f,d,p=(f=v,d=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=_o(f);if(d){var r=_o(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===fo(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return bo(t)}(this,t)});function v(t,e,r){var n,o=r.tabId,i=r.title,a=void 0===i?"Lookup":i,s=r.description,c=void 0===s?"lookup":s,u=r.allowMinimize,l=void 0===u||u,h=r.allowClose,f=void 0===h||h,d=r.minimizeOnConfirm,y=void 0===d||d,m=r.updateInBackground,g=void 0!==m&&m,b=r.promptOnClose,_=r.confirm,w=r.cancel,S=r.icon,k=r.readOnly,E=void 0!==k&&k,x=r.allowEdit,I=void 0===x||x,T=r.zone,O=r.parentDoc,C=r.temp,L=void 0!==C&&C,P=r.subDocs,D=r.autoSave,F=void 0!==D&&D,A=r.modal,R=r.onResponse,N=void 0===R?function(){}:R,j=r.audit,M=r.autoIndex,U=void 0!==M&&M,B=r.docId,G=void 0===B?e.user.userId:B,q=r.rowMenu,V=r.allowDelete,K=r.allowDeleteWhileOffline,Y=r._id,W=r.version,z=r.onPostBuild,H=void 0===z?function(t,e){}:z,Q=r.onPostBuildContainer,J=void 0===Q?function(t,e){}:Q,$=r.onSave,X=void 0===$?function(){var t=vo(po().mark((function t(e){return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}():$,Z=r.onPostLoad,tt=void 0===Z?function(){var t=vo(po().mark((function t(e){return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}():Z,et=r.onSubmit,rt=void 0===et?vo(po().mark((function t(){return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))):et,nt=r.onCancel,ot=void 0===nt?vo(po().mark((function t(){return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))):nt,it=r.onClose,at=void 0===it?vo(po().mark((function t(){return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))):it,st=r.onInit,ct=void 0===st?vo(po().mark((function t(){return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:case"end":return t.stop()}}),t)}))):st;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,v),wo(bo(n=p.call(this,t,e,o)),"dataType",St),n._state.developer,n._state=e,n._children={},n._document={},n._dbDocument={},n._documentForShortResponse={},n._subDoc=!1,n._subDocs=P||[],n._subCollections=[],n._sectionCollections={},n._autoSave=F,n._audit=j,n.index=-1,n._filteredCollectionName="",n._sections={},n._id=Y,n.temp=L,n._autoIndex=U,n.title=a,n.description=c,n.allowMinimize=l,n.allowClose=f,n.minimizeOnConfirm=y,n.updateInBackground=g,n.confirm=_,n.cancel=w,n.icon=S,n.modal=A,n.readOnly=E,n.allowEdit=I,n.promptOnClose=b,n._rowMenu=q,n._allowDelete=V,n._allowDeleteWhileOffline=K,n._version=W,n.zone=T,n._fields=[],n._f={},n.docId=G,n.onPostBuild=H,n.onPostBuildContainer=J,n.onSave=X,n.onPostLoad=tt,n.onSubmit=rt,n.onCancel=ot,n.onClose=at,n.onResponse=N,n.onInit=ct,O&&(O.dataType===St?(n._subDoc=!0,n._parentDoc=O,O.addChildDoc(bo(n))):n._state.addSystemErrorToStack(7,"Sub documents cannot be saved ".concat(n._intentId))),n}return e=v,r=[{key:"resetProperties",value:function(){this.docId=this._state.user.userId}},{key:"cloneDoc",value:function(t,e){var r=this._state._,n=(this._state.developer,new v(t||this.intentId,this._state,{title:this.title,description:this.description,allowMinimize:this.allowMinimize,allowClose:this.allowClose,minimizeOnConfirm:this.minimizeOnConfirm,updateInBackground:this.updateInBackground,promptOnClose:this.promptOnClose,confirm:this.confirm,cancel:this.cancel,icon:this.icon,readOnly:this.readOnly,allowEdit:this.allowEdit,zone:this.zone,autoSave:this.autoSave,modal:this.modal,onResponse:this.onResponse,onPostBuild:this.onPostBuild,onPostBuildContainer:this.onPostBuildContainer,audit:this._audit,allowDelete:this.allowDelete,allowDeleteWhileOffline:this.allowDeleteWhileOffline,rowMenu:this.rowMenu,onInit:this.onInit,docId:this._state.getUniqueId()}));return n._sections=this._sections,n.onPostBuild=this.onPostBuild,n.onSave=this.onSave,n.onPostBuildContainer=this.onPostBuildContainer,n.onPostLoad=this.onPostLoad,this._collection&&(n._collection=this._collection,n._collectionDBName=this._collectionDBName),this._state.duringBuild=!0,r.forEach(this.fields,(function(t){t.cloneField(n,e)})),this._state.duringBuild=!1,r.forEach(this._subDocs,(function(t){var e=t.cloneDoc();e._autoSave=n._autoSave,e._parentDoc=n,e._subDoc=!0,n.addChildDoc(e)})),n}},{key:"options",value:function(t,e){return{parent:t,formId:this.intentId,controlId:this.intentId,docId:this.docId,tabId:this.tabId,title:this.title,description:this.description,allowMinimize:this.allowMinimize,allowClose:this.allowClose,minimizeOnConfirm:this.minimizeOnConfirm,updateInBackground:this.updateInBackground,promptOnClose:this.promptOnClose,confirm:this.confirm,cancel:this.cancel,icon:this.icon,readOnly:this.readOnly,allowEdit:this.allowEdit,zone:this.zone,allowDelete:this._allowDelete,allowDeleteWhileOffline:this._allowDeleteWhileOffline,rowMenu:this._rowMenu,modal:!!e,sections:this._sections,version:this.version}}},{key:"getCollectionData",value:function(){this._state.developer;var t=this._state._,e={};return t.map(this._sectionCollections,(function(t,r){t.prepareCollectionOptions(),e[r]={rows:t.getRowsForShortResponse(),options:t.options}})),e}},{key:"formResponseWithAction",value:function(t,e,r,n,o){var i,a=this._allowDelete,s=this.allowEdit,c=e,u=t;if(t===B&&Array.isArray(c))c={fields:e};else if(t===G)c={deleteRow:[this.docId]},u=B;else if(t===q&&Array.isArray(c))c={append:e},u=B;else if(t===V){c=[];var l=this.collection;l&&(i=l.generateTableColumnTemplate())}var h,f,d,p=this.collection;n&&p&&(h=p.intentId,this._state&&this._state.messageFromUser&&(f=this._state.messageFromUser.parentDocId),!this._state||this._state.messageFromUser.action===P||this._state.messageFromUser.action===T||a===this._allowDelete&&s===this.allowEdit||(d={allowDelete:this._allowDelete,allowEdit:this.allowEdit,rowMenu:this.rowMenu}));var y=this.options(o,r);return y.tableId=h,y.parentDocId=f,y.action=u,y.rowOptions=d,y.columnTemplate=i,y.sectionId=null==p?void 0:p.sectionId,{result:c,options:y}}},{key:"getParentForMessage",value:function(t){t||this.onResponse(this);var e=null;return this._parent&&(e=this._parent._intentId),e}},{key:"message",value:function(t,e,r,n,o){var i=this.getParentForMessage(o);if(t)return this.formResponseWithAction(t,e,r,n,i);var a=[];return this._fields.forEach((function(t){var e=t.message(o);e&&(!r||r&&t.includeInQuickEdit)&&a.push(e)})),{fields:a,options:this.options(i,r)}}},{key:"shortMessage",value:function(t,e,r,n,o){var i=this.getParentForMessage(o);if(t)return this.formResponseWithAction(t,e,r,n,i);var a=In.getGenericKeys(),s=[];return this._fields.forEach((function(t){var e=t.shortMessage(o);e&&(!r||r&&t.includeInQuickEdit)&&s.push(e)})),{fields:{fieldKeys:a,fieldData:s},options:this.options(i,r),collectionData:this.getCollectionData()}}},{key:"parent",set:function(t){this._parent=t}},{key:"formId",get:function(){return this.intentId}},{key:"fields",get:function(){return this._fields},set:function(t){this._fields=[],this.addFields(t)}},{key:"f",get:function(){return this._f}},{key:"version",get:function(){return this._version},set:function(t){this._version=t}},{key:"addField",value:function(t){if(t.dataType===kt)return this._fields.push(t),this._f[t._intentId]=t,this._fields.length>0?this._fields.length-1:0;state.addSystemErrorToStack(Ht.getErrorMessageforCodeAndLang(28))}},{key:"addFields",value:function(t){var e=this;Array.isArray(t)&&t.forEach((function(t){e.addField(t)}))}},{key:"removeFieldWithId",value:function(t){delete this._f[t];var e=this._state._.findIndex(this._fields,(function(e){return e.id===t}));e>-1&&this._fields.splice(e,0,1)}},{key:"addSection",value:function(t){this._sections[t.sectionId]=t.message()}},{key:"allowDelete",get:function(){return this._allowDelete},set:function(t){this._allowDelete=t}},{key:"rowMenu",get:function(){return this._rowMenu},set:function(t){this._rowMenu=t}},{key:"sendResponse",value:function(){this._state.addFormResponse(this.message())}},{key:"sendShortResponse",value:function(){this._state.addShortFormResponse(this.shortMessage())}},{key:"sendChangeResponse",value:function(t){this._state.addFormChangeResponse(this.message(B,t))}},{key:"sendQuickDocResponse",value:function(){this._state.addFormResponse(this.message(null,null,!0))}},{key:"setCollection",value:function(t){this._collection=t.intentId,this._collectionDBName=t.name}},{key:"collection",get:function(){return this._state.intents[this._collection]}},{key:"getPrimaryKey",value:function(){var t=this._state._,e=(this._state.developer,{});return t.forEach(this._fields,(function(t){t.primaryKey&&t.value&&!t.temp&&(e[t.dbName||t._intentId]=t.value)})),e}},{key:"getPrimaryKeyAsStringForSearch",value:function(t){var e=this,r="";return this._state._.forEach(t,(function(t){var n=t;"string"!=typeof t&&(n=e._state.R.toString(t)),""===r?r+=n:r=r+"-"+n})),r}},{key:"getNonPrimaryKey",value:function(){var t=this._state._,e=(this._state.developer,{});return t.forEach(this._fields,(function(t){!t.primaryKey&&t.value&&(e[t._intentId]=t.value)})),e}},{key:"buildDocumentFromContainer",value:function(t,e){var r=this,n=this._state._,o=(this._state.developer,t[this.intentId]);return Date.now(),void 0!==o?this.buildDocument(o,e):this.buildDocument(t,e),n.forEach(this._subDocs,(function(n){var o=t[n.intentId];o&&!n.temp&&(n.buildDocument(o,e),r._document[n.intentId]=n.document,r._dbDocument[n.intentId]=n.document)})),n.forEach(this._subCollections,(function(o){var i=t[o.intentId];if(i&&!o.temp){var a=[];o.clearRows(),n.forEach(i,(function(t){var r=o.document.cloneDoc();o.addRow(r),r.buildDocument(t,e),a.push(r.document)})),r._document[o.intentId]=a,r._dbDocument[o.intentId]=a}})),this._document}},{key:"buildDocument",value:function(t,e,r){var n=this,o=this._state._,i=this._state.developer;try{r||(this._state.duringBuild=!0);var a={};return o.forEach(t,(function(e,r){if("_id"===r)n._id=e;else if("docId"===r)n.docId=e;else if("allowEdit"===r)n.allowEdit=e;else if("allowDelete"===r)n.allowDelete=e;else if("rowMenu"===r)n.rowMenu=e;else{var i=t[r];"object"===fo(i)&&o.get(i,"text")&&(i=o.get(i,"text")),"object"===fo(i)&&o.get(i,"fileName")&&(i={value:o.get(i,"value"),fileName:o.get(i,"fileName")}),n.f[r]?(n.f[r].value=i,a[r]=n.f[r].value):o.forEach(n._fields,(function(t){t._intentId!==r&&t.title!==r&&t.dbName!==r||(t.value=i,a[t._intentId]=t.value)}))}})),e||this.onPostBuild(this,t),this._state.duringBuild=!1,this._document}catch(e){i.log({message:"Error building document",data:t}),this._state.addSystemErrorToStack(45,null,e.message)}}},{key:"buildDocumentFromUserMessage",value:function(t){var e=this._state._;this._state.duringBuild=!0;var r={};e.forEach(t.fields,(function(t){r[t.id]=t})),e.forEach(this._fields,(function(t){e.get(r[t.intentId],"fileName")?t.value={value:e.get(r[t.intentId],"value"),fileName:e.get(r[t.intentId],"fileName")}:t.value=e.get(r[t.intentId],"value")})),this._state.duringBuild=!1}},{key:"clearDocument",value:function(){var t=this._state._;this._state.developer,this._document={},this._dbDocument={},t.forEach(this._fields,(function(t){t.primaryKey||(t._value=t._originalValue)}))}},{key:"processDataFromDB",value:function(t){return Array.isArray(t)?1===t.length?this.hasSubDocs?this.buildDocumentFromContainer(t[0]):this.buildDocument(t[0]):t.length>1?void this._state.addErrorToStack(7,"Multiple records returned by query while expecting only one",t):{}:this.buildDocument(t)}},{key:"loadDocument",value:(h=vo(po().mark((function t(e){var r,n,o,i,a;return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Date.now(),!this._subDoc){t.next=4;break}return this._state.addSystemErrorToStack(7,"Sub documents cannot be loaded ".concat(this._intentId)),t.abrupt("return");case 4:if(this._collection){t.next=7;break}return this._state.addSystemErrorToStack(7,"Collection not assigned to document ".concat(this._intentId)),t.abrupt("return");case 7:if(r=this._state._,this._state.R,this._state.developer,this.clearDocument(),this.docId=this._state.user.userId,this.clearAutoSaveBuffer(),{},n=e||this.getPrimaryKey(),!(r.size(n)>0)){t.next=30;break}return t.next=18,this._state.db.getDataFromCollection({collection:this._collectionDBName,local:this.collection.local,query:n,expectOneResult:!0,system:r.get(this.collection,"system"),cache:r.get(this.collection,"_cache"),securedFields:this.getSecuredFieldsArray()});case 18:if(o=t.sent,200!==r.get(o,"statusCode")){t.next=27;break}return i=o.body,a=this.processDataFromDB(i),t.next=24,this.onPostLoad(this);case 24:return t.abrupt("return",a);case 27:this._state.addSystemErrorToStack(7,"Error reading MongoDB");case 28:t.next=31;break;case 30:this._state.addErrorToStack(7,"You need to add some values to the primary key or passing a value in query before calling loadDocument(query)");case 31:case"end":return t.stop()}}),t,this)}))),function(t){return h.apply(this,arguments)})},{key:"deltaDoc",get:function(){var t=this._state._,e={};return this._state.developer,t.forEach(this._fields,(function(t){t.getAutoSavedValueChanged()&&(e[t.dbName||t._intentId]=t.value)})),this.hasSubDocs&&(t.forEach(this._subDocs,(function(r){var n=r.deltaDoc;t.size(n)>0&&t.forEach(n,(function(t,n){e["".concat(r.intentId,".").concat(n)]=t}))})),t.forEach(this._subCollections,(function(t){e[t.intentId]=t.rowAsDocumentsArray()}))),e}},{key:"saveDelta",value:(l=vo(po().mark((function t(e,r){var n,o,i,a;return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=this._state.developer,o=this._state._,t.next=4,this.onSave(this);case 4:if(!this._subDoc){t.next=7;break}return this._state.addSystemErrorToStack(7,"Sub documents cannot be saved ".concat(this._intentId)),t.abrupt("return");case 7:if(i={},i=r||this.getPrimaryKey(),a={upsert:!0},n.info({message:"Saving doc delta",data:{collection:this._collectionDBName,document:this.deltaDoc,query:i}}),!this._autoIndex){t.next=14;break}return t.next=14,this.saveToIndex();case 14:return t.next=16,this._state.db.updateDataInCollection({collection:this._collectionDBName,document:this.deltaDoc,query:i,options:a,audit:this._audit,sync:e,system:o.get(this.collection,"system"),securedFields:this.getSecuredFieldsArray(),cache:this.collection.cache});case 16:case"end":return t.stop()}}),t,this)}))),function(t,e){return l.apply(this,arguments)})},{key:"save",value:(u=vo(po().mark((function t(e,r,n,o){var i,a,s,c,u,l;return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=this._state.developer,s=this._state._,t.next=4,this.onSave(this);case 4:if(!this._subDoc){t.next=7;break}return this._state.addSystemErrorToStack(7,"Sub documents cannot be saved ".concat(this._intentId)),t.abrupt("return");case 7:if(c={},c=r||this.getPrimaryKey(),u={upsert:!0},l=n?this._document:this._dbDocument,o&&(l=ho(ho({},l),{},{$unset:this.getClearedFields(n)})),a.info({message:"Saving doc",data:{collection:this._collectionDBName,document:this._dbDocument,query:c}}),!this._autoIndex){t.next=16;break}return t.next=16,this.saveToIndex();case 16:return t.next=18,this._state.db.updateDataInCollection({collection:this._collectionDBName,document:l,local:null===(i=this.collection)||void 0===i?void 0:i.local,query:c,options:u,audit:this._audit,sync:e,system:s.get(this.collection,"system"),securedFields:this.getSecuredFieldsArray(),cache:this.collection.cache});case 18:case"end":return t.stop()}}),t,this)}))),function(t,e,r,n){return u.apply(this,arguments)})},{key:"legacySave",value:(c=vo(po().mark((function t(e,r){return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.save(e,r,!0);case 2:case"end":return t.stop()}}),t,this)}))),function(t,e){return c.apply(this,arguments)})},{key:"indexName",get:function(){return"".concat(y,"_").concat(this._state.currentUserDomain,"_").concat(this._collectionDBName)}},{key:"queryKeyFromIndex",value:(s=vo(po().mark((function t(){var e,r,n,o;return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this._state.developer,e=this._state._,r=this.getPrimaryKey(),n=In.getTermQueryForObject(r,this._state),t.next=6,this._state.db.getDataFromIndexWithQueryObject(this.indexName,n);case 6:if(o=t.sent,e.get(o,"errorMessage")||e.get(o,"error")){t.next=9;break}return t.abrupt("return",o);case 9:case"end":return t.stop()}}),t,this)}))),function(){return s.apply(this,arguments)})},{key:"loadDocumentFromIndex",value:(a=vo(po().mark((function t(){var e,r;return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this._state._,this._state.developer,this.clearDocument(),t.next=5,this.queryKeyFromIndex();case 5:return e=t.sent,t.next=8,this.processDataFromDB(e);case 8:return r=t.sent,t.abrupt("return",r);case 10:case"end":return t.stop()}}),t,this)}))),function(){return a.apply(this,arguments)})},{key:"saveToIndex",value:(i=vo(po().mark((function t(){var e,r,n,o;return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=this._state._,r=this._state.developer,t.next=4,this.queryKeyFromIndex();case 4:if(!(n=t.sent)){t.next=13;break}return r.info({message:"Updating record in ES"}),(o=e.cloneDeep(this._dbDocument)).id=e.get(n[0],"_id"),t.next=11,this._state.db.updateDataInIndex({index:this.indexName,doc:o});case 11:t.next=16;break;case 13:return r.info({message:"Inserting record in ES"}),t.next=16,this._state.db.writeDataIntoIndex({index:this.indexName,doc:this._dbDocument});case 16:case"end":return t.stop()}}),t,this)}))),function(){return i.apply(this,arguments)})},{key:"delete",value:(o=vo(po().mark((function t(){var e,r,n,o;return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=this._state.developer,n=this._state._,r.info({message:"Deleting doc",data:{collection:this._collectionDBName,document:this._dbDocument}}),o=this.getPrimaryKey(),t.next=6,this._state.db.deleteDataFromCollection({collection:this._collectionDBName,document:this._dbDocument,query:o,local:null===(e=this.collection)||void 0===e?void 0:e.local,system:n.get(this.collection,"system")});case 6:case"end":return t.stop()}}),t,this)}))),function(){return o.apply(this,arguments)})},{key:"rebuildDocumentObject",value:function(){var t=this,e=this._state._;return 0===e.size(this._document)&&e.forEach(this._fields,(function(e){e.temp||(t._document[e._intentId]=e.value,t._dbDocument[e.dbName||e._intentId]=e.value)})),this.hasSubDocs&&(e.forEach(this._subDocs,(function(e){e.temp||(t._document[e.intentId]=e.rebuildDocumentObject(),t._dbDocument[e.intentId]=t._document[e.intentId])})),e.forEach(this._subCollections,(function(r){if(!r.temp){var n=[];e.forEach(r.rows,(function(t){n.push(t.rebuildDocumentObject())})),t._document[r.intentId]=n,t._dbDocument[r.intentId]=t._document[r.intentId]}}))),this._document}},{key:"getSecuredFieldsArray",value:function(){var t=this._state._,e=(this._state.developer,[]);return t.forEach(this._fields,(function(t){t.encrypted&&e.push(t.dbName||t.id)})),this.hasSubDocs&&(t.forEach(this._subDocs,(function(r){var n=r.getSecuredFieldsArray();t.forEach(n,(function(t){e.push("".concat(r.intentId,".").concat(t))}))})),t.forEach(this._subCollections,(function(r){var n=r.document,o=n.getSecuredFieldsArray();t.forEach(o,(function(t){e.push("".concat(n.intentId,".").concat(t))}))}))),e}},{key:"getClearedFields",value:function(t){var e=this._state._,r=(this._state.developer,{});return e.forEach(this._fields,(function(e){void 0!==e.value&&null!==e.value||(r[t?e.intentId:e.dbName]=1)})),this.hasSubDocs&&e.forEach(this._subDocs,(function(n){var o=n.getClearedFields(t);e.forEach(o,(function(t,e){r["".concat(n.intentId,".").concat(e)]=1}))})),r}},{key:"document",get:function(){var t=this,e=this._state._;return 0===e.size(this._document)&&e.forEach(this._fields,(function(e){t._document[e._intentId]=e.value})),this._document},set:function(t){this._document=t}},{key:"hasSubDocs",get:function(){return this._subDocs.length>0||this._subCollections.length>0}},{key:"autoSave",get:function(){return this._autoSave},set:function(t){this._autoSave=t}},{key:"addChildDoc",value:function(t){if(this.docId=this._state.user.userId,t.dataType===St)this._subDocs.push(t);else{if(t.dataType!==wt)return this._state.addSystemErrorToStack(7,"Child must be instance of either Doc or Collection classes ".concat(this._intentId)),!1;this._subCollections.push(t)}return this._children[t.intentId]=t,!0}},{key:"children",get:function(){return this._children}},{key:"onMatching",get:function(){var t=this;return function(e){var r=e.messageFromUser.controlId||e.messageFromUser.formId;return e.messageTypeFromUser===k&&!e.messageFromUser.currentField&&r===t.formId}}},{key:"_callEvents",value:(n=vo(po().mark((function t(e){return po().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._parent&&this._parent._intentId===e.currentControlId?e.currentControlId=this._parent._intentId:e.currentControlId=this.intentId,e.messageFromUser.action!==R){t.next=6;break}return t.next=4,this.onSubmit();case 4:t.next=17;break;case 6:if(e.messageFromUser.action!==j){t.next=11;break}return t.next=9,this.onCancel();case 9:t.next=17;break;case 11:if(e.messageFromUser.action!==M){t.next=16;break}return t.next=14,this.onClose();case 14:t.next=17;break;case 16:e.addSystemErrorToStack(29,Ht.getErrorMessageforCodeAndLang(29));case 17:0===e.responsesArray.length&&e.addSilentResponse();case 18:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"onResolution",get:function(){var t=this;return function(){var e=vo(po().mark((function e(r){var n,o,i,a,s;return po().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("In Doc resolution"),n=r._,o=n.get(r.messageFromUser,"docId"),i=n.get(r.messageFromUser,"tabId"),o&&(a=n.get(r.messageFromUser,"parentDocId"),t.loadDocFromAutoSaveBuffer(i,o,a)),o&&n.get(r.messageFromUser,"action")!==R||(s=In.formResponseAsObject(r.messageFromUser),t.buildDocument(s)),r.currentControlId=t.intentId,i&&(t.tabId=i),e.next=10,t._callEvents(r);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}},{key:"overrideParentDocId",value:function(t){var e=this._state._;if(this._parentDoc)this._parentDoc.overrideParentDocId(t);else if(this._collection){var r=e.get(this._state.intents,this._collection);r._parentDoc?r._parentDoc.overrideParentDocId(t):e.size(this._children)>0&&(this.docId=t)}}},{key:"loadDocFromAutoSaveBuffer",value:function(t,e,r){var n=this;if(this.autoSave){var o,i=this._state._;e&&(this.docId=e),r&&this.overrideParentDocId(r),this._state.duringBuild=!0,i.forEach(this._fields,(function(e){e.setValueFromAutoSave(t,r)})),(null===(o=this._subCollections)||void 0===o?void 0:o.length)>0&&i.forEach(this._subCollections,(function(e){e.clearRows(),e.loadRowsFromAutoSaveBuffer(t),n._document[e.intentId]=e.rowAsDocumentsArray(),n._dbDocument[e.intentId]=e.rowAsDocumentsArray()})),this._state.duringBuild=!1}}},{key:"generateAutoSaveBufferFromDoc",value:function(){this.docId||(this.docId=this._state.getUniqueId(),this._fields.forEach((function(t){t.setAutoSaveFieldValue(t.value)})))}},{key:"getAutoSavePath",value:function(t,e){var r=this._state;try{var n=r._,o=(r.developer,t||r.currentTabId||this.tabId);if(this._parentDoc){var i=this._parentDoc.getAutoSavePath(o,e);return"".concat(i,".").concat(this.intentId)}var a=n.get(this,"_collection");if(a){var s=n.get(r.intents,a);if(s){var c=s.getAutoSavePath(o,e),u=this.docId;return s._parentDoc||e&&(u=e),r._version>=3?"".concat(c,".").concat(u):"".concat(c,".").concat(this.intentId)}}}catch(t){r.addSystemErrorToStack(999,t.message,this.intentId)}}},{key:"clearAutoSaveBuffer",value:function(t,e,r){if(this.autoSave){var n=this._state._,o=this._state.autoSaveBuffer,i=t||this._state.currentTabId||this.tabId;if(e&&(this.docId=e),r&&this.overrideParentDocId(r),n.get(o,i)){var a=this.getAutoSavePath(i,r);a&&n.unset(o,a)}}}},{key:"clearAutoSaveBufferChanges",value:function(t,e,r){var n=this._state._,o=this._state.autoSaveBufferChanges,i=t||this._state.currentTabId||this.tabId;if(e&&(this.docId=e),r&&this.overrideParentDocId(r),n.get(o,i)){var a=this.getAutoSavePath(i,r);a&&n.unset(o,a)}}},{key:"addCollectionToSection",value:function(t,e){var r=this._state.developer;if(e.forCollection){if(t.isSubCollection){if(t.parentDoc.intentId!==this.intentId)return r.systemError({message:"Trying to add a collection with other parentDoc"})}else t.setParentDoc(this);this.version=4,t.sectionId=e.intentId,this._sectionCollections[e.intentId]=t}else r.systemError({message:"Trying to add a collection in a normal section"})}}],r&&mo(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),v}(At);function Eo(t){return Eo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Eo(t)}function xo(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Eo(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Eo(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Eo(o)?o:String(o)),n)}var o}function Io(t,e){return Io=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Io(t,e)}function To(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function Oo(t){return Oo=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Oo(t)}var Co=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Io(t,e)}(a,t);var e,r,n,o,i=(n=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=Oo(n);if(o){var r=Oo(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===Eo(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return To(t)}(this,t)});function a(t,e){var r,n=e.state,o=e.label,s=e.collapsable,c=void 0!==s&&s,u=e.defaultCollapsableState,l=void 0!==u&&u,h=e.columns,f=e.doc,d=e.hidden,p=void 0!==d&&d,y=e.forCollection,v=void 0!==y&&y;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,a),(r=i.call(this,t,n)).state=n,r.label=o,r.collapsable=c,r.defaultCollapsableState=l,r.columns=h,r.doc=f,r.hidden=p,r.forCollection=v,r.doc.addSection(To(r)),r}return e=a,(r=[{key:"sectionId",get:function(){return this.intentId}},{key:"addCollection",value:function(t){this.doc.addCollectionToSection(t,this)}},{key:"message",value:function(){return{label:this.label,collapsable:this.collapsable,hidden:this._hidden,defaultCollapsableState:this.defaultCollapsableState,columns:this.columns,forCollection:this.forCollection,sectionId:this.sectionId}}},{key:"hidden",get:function(){return this._hidden},set:function(t){this._hidden=t,this.doc.addSection(this)}}])&&xo(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),a}(At);function Lo(t){return Lo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Lo(t)}function Po(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==Lo(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==Lo(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===Lo(o)?o:String(o)),n)}var o}function Do(t,e){return Do=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Do(t,e)}function Fo(t){return Fo=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Fo(t)}var Ao=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Do(t,e)}(a,t);var e,r,n,o,i=(n=a,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=Fo(n);if(o){var r=Fo(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return function(t,e){if(e&&("object"===Lo(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(this,t)});function a(t,e){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,a),(r=i.call(this,t,e))._state=e,r}return e=a,r=[{key:"options",value:function(){return{controlId:this.controlId,tabId:this.tabId}}},{key:"sendResponse",value:function(t,e){this.controlId=t;var r={data:{courseUrl:e},options:this.options()};this._state.addAiccResponse(r)}}],r&&Po(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),a}(At),Ro=new Ao("coursePlayer",Hn),No=[{courseId:"1",courseName:"Course 1",courseDescription:"Course 1 Description",courseCatalog:"Catering",courseSkill:"Safety management",courseStatus:"Completed",courseDuration:"2 hours",courseUrl:"http://aderco.com.s3-website-us-east-1.amazonaws.com/story.html"},{courseId:"2",courseName:"Course 2",courseDescription:"Course 2 Description",courseCatalog:"OLG core catalog",courseSkill:"Personal development",courseStatus:"In progress",courseDuration:"1 hour",courseUrl:"http://aderco.com.s3-website-us-east-1.amazonaws.com/story.html"},{courseId:"3",courseName:"Course 3",courseDescription:"Course 3 Description",courseCatalog:"Singapore MPA",courseSkill:"Buisnes skill",courseStatus:"Completed",courseDuration:"3 hours",courseUrl:"http://aderco.com.s3-website-us-east-1.amazonaws.com/story.html"}];function jo(t){return jo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},jo(t)}function Mo(){Mo=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==jo(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(jo(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Uo(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}var Bo=new ko("courseDoc",Hn,{title:"Course information",allowClose:!0,confirm:"Play",minimizeOnConfirm:!1,autoSave:!0});Bo.onSubmit=function(){var t=Vo.value,e=qo.value;t?Ro.sendResponse(e,t):Hn.addStringResponse("Missing course url for ".concat(Ko.value))};var Go=new Co("section",{label:"Course Information",doc:Bo,columns:1,state:Hn}),qo=new _n("courseId",{title:"Sl No",dbName:"courseId",primaryKey:!0,type:ir.TEXT_FIELD,section:Go,readOnly:!0,column:0,doc:Bo,state:Hn}),Vo=new _n("courseUrl",{title:"Course Url",dbName:"courseUrl",type:ir.TEXT_FIELD,section:Go,readOnly:!0,column:0,doc:Bo,hidden:!0,state:Hn}),Ko=new _n("courseName",{title:"Course Name",dbName:"courseName",type:ir.TEXT_FIELD,section:Go,readOnly:!0,column:0,doc:Bo,state:Hn}),Yo=(new _n("courseDescription",{title:"Description",dbName:"courseDescription",type:ir.TEXT_FIELD,section:Go,readOnly:!0,column:0,doc:Bo,state:Hn}),new _n("courseCatalog",{title:"Catalog",dbName:"courseCatalog",type:ir.TEXT_FIELD,section:Go,readOnly:!0,column:0,doc:Bo,state:Hn}),new _n("courseSkill",{title:"Skill",dbName:"courseSkill",type:ir.TEXT_FIELD,section:Go,readOnly:!0,column:0,doc:Bo,state:Hn}),new _n("courseStatus",{title:"Status",dbName:"courseStatus",type:ir.TEXT_FIELD,section:Go,readOnly:!0,column:0,doc:Bo,state:Hn}),new _n("courseDuration",{title:"Duration",dbName:"courseDuration",type:ir.TEXT_FIELD,section:Go,readOnly:!0,column:0,doc:Bo,state:Hn}),new jn("courseCollection",{name:"courses",document:Bo,shared:!0,title:"Courses",style:lt,version:4,state:Hn}));function Wo(){return zo.apply(this,arguments)}function zo(){var t;return t=Mo().mark((function t(){return Mo().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:Hn.currentTabId=Yo.id,Yo.buildRowsFromArray(No),Yo.sendShortResponse();case 3:case"end":return t.stop()}}),t)})),zo=function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Uo(i,n,o,a,s,"next",t)}function s(t){Uo(i,n,o,a,s,"throw",t)}a(void 0)}))},zo.apply(this,arguments)}function Ho(t){return Ho="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ho(t)}function Qo(){Qo=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Ho(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Ho(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function Jo(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function $o(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){Jo(i,n,o,a,s,"next",t)}function s(t){Jo(i,n,o,a,s,"throw",t)}a(void 0)}))}}Yo.onQuickAction=function(){var t,e;e=null===(t=Hn.messageFromUser)||void 0===t?void 0:t.content,Bo.buildDocument(e),Hn.currentTabId=qo.value,Bo.sendShortResponse()};var Xo=new At("main",Hn);function Zo(t){return Zo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Zo(t)}function ti(){ti=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function l(t,e,r,n){var i=e&&e.prototype instanceof m?e:m,a=Object.create(i.prototype),s=new L(n||[]);return o(a,"_invoke",{value:I(t,r,s)}),a}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=l;var f="suspendedStart",d="suspendedYield",p="executing",y="completed",v={};function m(){}function g(){}function b(){}var _={};u(_,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(P([])));S&&S!==r&&n.call(S,a)&&(_=S);var k=b.prototype=m.prototype=Object.create(_);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function r(o,i,a,s){var c=h(t[o],t,i);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==Zo(l)&&n.call(l,"__await")?e.resolve(l.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(l).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=f;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===y){if("throw"===i)throw a;return{value:t,done:!0}}for(n.method=i,n.arg=a;;){var s=n.delegate;if(s){var c=T(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===f)throw o=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=p;var u=h(e,r,n);if("normal"===u.type){if(o=n.done?y:d,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=y,n.method="throw",n.arg=u.arg)}}}function T(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,T(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=h(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var a=i.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function C(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function P(e){if(e||""===e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(Zo(e)+" is not iterable")}return g.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:g,configurable:!0}),g.displayName=u(b,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,u(t,c,"GeneratorFunction")),t.prototype=Object.create(k),t},e.awrap=function(t){return{__await:t}},E(x.prototype),u(x.prototype,s,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var a=new x(l(t,r,n,o),i);return e.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(k),u(k,c,"Generator"),u(k,a,(function(){return this})),u(k,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(C),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:P(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function ei(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function ri(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){ei(i,n,o,a,s,"next",t)}function s(t){ei(i,n,o,a,s,"throw",t)}a(void 0)}))}}Xo.runOnCloud(),Xo.onResolution=$o(Qo().mark((function t(){return Qo().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Wo();case 2:case"end":return t.stop()}}),t)})));var ni="4.0.0",oi="asyncResult",ii="next",ai=new uo,si=function(t,e){switch(Hn.isRunning=!0,e){case ii:return Di(t.msg,t.stateParam,t.previousMessages,t.botContext);case oi:return Fi(t.result,t.stateParam,t.previousMessages,t.botContext)}},ci=function(t,e){return Hn.isRunning?ai.addMessage(t,e):si(t,e)},ui=function(){var t=ai.pollMessage();return t?si(t.message,t.action):(Hn.isRunning=!1,{status:200})},li=function(t,e,r,n){return ci({msg:t,stateParam:e,previousMessages:r,botContext:n},ii)},hi=function(t,e,r,n){return ci({result:t,stateParam:e,previousMessages:r,botContext:n},oi)},fi=function(){console.log("*************** message type: "+Hn.messageTypeFromUser),Hn.developer.info({message:"*************** message type: ",data:Hn.messageTypeFromUser}),console.log("*************** message from user: "+JSON.stringify(Hn.messageFromUser)),Hn.developer.info({message:"*************** message from user: ",data:Hn.messageFromUser})},di={conversation:"",getContext:function(t,e){return(e=e||t.getCapability("DeviceStorage")).get(di.conversation)},setInContext:function(t,e){return e.getCapability("DeviceStorage").save(t.conversationId,t)},resetContext:function(t,e){return e.getCapability("DeviceStorage").save(t,{})},removeFromContext:function(t,e){var r=e.getCapability("DeviceStorage");return di.getContext(e,r).then((function(e){return delete e[t],r.save(di.conversation,e)}))}},pi=function(){var t=ri(ti().mark((function t(e){var r,n,o,i,a;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e._,e.developer.info({message:"Starting matching event"}),n=Date.now(),o=!1,e.messageTypeFromUser===Le.BACKEND_RESPONSE()||""!==e.activeIntent?o=!0:e.developer.isDeveloperIntent()?((i=e.developer.identifyDeveloperIntent())?e.addActiveIntent(i,!1):(e.addSystemErrorToStack(12),e.addActiveIntent(_t)),o=!0):Object.values(e.intents).forEach((function(t){if(!t.intentId)return e.addSystemErrorToStack(21),o=!0,!1;if(!t.runLocation)return e.addSystemErrorToStack(2),o=!0,!1;var n;if(t.runLocation!==gt&&t.runLocation!==bt)return e.addSystemErrorToStack(1),o=!0,!1;var i=function(){console.log("Matched intent ".concat(t.intentId)),e.developer.info({message:"Intent matched to "+t.intentId}),e.addActiveIntent(t.intentId,t.logHistory,t.silentIntent),o=!0;var n=r.get(e.messageFromUser,"action");n&&(t._presentEvent=n),t.runLocation!==bt||e.client!==yt&&e.client!==mt||(e.toCustomCap=!0)};if(t.intentId===Ot&&(null===(n=e.messageFromUser)||void 0===n?void 0:n.intentId)===Ot)i();else if("function"==typeof t.onMatching&&t.onMatching(e)){if(o)return e.developer.info({message:"Second intent matched to "+t.intentId}),e.messageTypeFromUser===k||e.messageTypeFromUser===E||e.messageTypeFromUser===x?e.addSystemErrorToStack(34):e.addSystemErrorToStack(35),e.removeActiveIntent(),!1;i()}})),t.next=7,e.online();case 7:return a=t.sent,o?!a&&e.toCustomCap&&(e.toCustomCap=!1):!a||e.messageTypeFromUser!==e.messageTypes.MESSAGE_TYPE_STRING||e.client!==yt&&e.client!==mt||(e.toCustomCap=!0),t.next=11,e.developer.logCurrentEventDurationWithStartTime("runMatchers",n,Date.now());case 11:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),yi=function(t){var e=JSON.stringify(t);Hn.addSystemErrorToStack(5,e)},vi=function(){var t=ri(ti().mark((function t(e){var r,n,o,a,s,c;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,console.log("************* Calling custom cap ****************"),e.developer.info({message:"Calling cloud capabilities"}),e.context.wait(!0),r=Date.now(),n=e.context.getCapability("AgentGuard"),o=e.getNewRequestId(),a=e.stateToBackEnd(),s={capability:"BackendBotCap",parametersObject:{botId:e.context.botManifest.botId,botVersion:e.context.botManifest.version,command:"asyncRequest",data:a},requestUuid:o,sync:!1,conversation:{conversationId:e.conversationId,bot:e.context.botManifest.botId}},void 0===e.conversation.created&&(s.conversation.participants=e.conversation.participants,s.conversation.onChannels=e.conversation.onChannels,s.conversation.closed=!1),s.parameters=JSON.stringify(s.parametersObject),delete s.parametersObject,t.next=14,n.execute(s);case 14:if(!(null==(c=t.sent)?void 0:c.queued)){t.next=26;break}return t.next=19,e.online();case 19:if(!t.sent){t.next=23;break}yi(c),t.next=24;break;case 23:e.addStringResponse("Your device appears to be offline, but don't worry, I will process your message as soon as the connection is back and I will let you know.");case 24:t.next=35;break;case 26:return e.developer.info({message:"Backend call successful"}),e.setWaitingCustomCap(),t.next=30,e.developer.logCurrentEventDurationWithStartTime("callCustomCap",r,Date.now());case 30:if(e._delayedNotification={},e._syncToCloud={},!e._persistentOfflineData){t.next=35;break}return t.next=35,e.deviceStorage.removeKeyFromStorage(i);case 35:t.next=44;break;case 37:return t.prev=37,t.t0=t.catch(0),console.log("************* Some sort of problem ".concat(JSON.stringify(t.t0))),e.addSystemErrorToStack(5,t.t0),t.next=43,e.developer.logCurrentEventDurationWithStartTime("callCustomCap",start,Date.now());case 43:yi(t.t0);case 44:case"end":return t.stop()}}),t,null,[[0,37]])})));return function(e){return t.apply(this,arguments)}}(),mi=function(t){t.developer.info({message:"Starting validation event"}),Date.now();var e=t._,r=t.activeIntent;return r!==_t&&Object.values(t.intents).forEach((function(n){if(n.intentId===r){n.onError&&(t.onError=n.onError);try{n.onValidation&&(t.developer.info({message:"Starting onValidation for intent "+n.intentId}),n.onValidation(t),e.size(t.errorStack))}catch(e){var o=t.location===gt?5:7;t.addSystemErrorToStack(o,e.message)}}})),!0},gi=function(){var t=ri(ti().mark((function t(e){var r,n,o,i,a,s,c;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("************* Resolvers method ****************"),e.developer.info({message:"Starting resolution event"}),r=5,n=7,o=Date.now(),e._,""!==(i=e.activeIntent)){t.next=11;break}e.addActiveIntent(_t),t.next=34;break;case 11:if(i!==Tt){t.next=14;break}t.next=34;break;case 14:if(i===_t){t.next=34;break}if((s=null===(a=e.intents)||void 0===a?void 0:a[i])&&s.onResolution){t.next=20;break}return e.addSystemErrorToStack(3),e.developer.logCurrentEventDurationWithStartTime("runResolvers",o,Date.now()),t.abrupt("return");case 20:return e.developer.info({message:"Starting onResolution for intent "+s.intentId}),t.prev=21,t.next=24,s.onResolution(e);case 24:return e.developer.info({message:"Resolution passed"}),e.developer.logCurrentEventDurationWithStartTime("runResolvers",o,Date.now()),t.abrupt("return",e.recordActivity({stamp:1}));case 29:t.prev=29,t.t0=t.catch(21),c=e.location===gt?r:n,e.addSystemErrorToStack(c,"Error processing resolution "+t.t0.message),e.developer.logCurrentEventDurationWithStartTime("runResolvers",o,Date.now());case 34:case"end":return t.stop()}}),t,null,[[21,29]])})));return function(e){return t.apply(this,arguments)}}(),bi=function(t,e,r){var n;if(t.unitTestMode){if(Object.values(t.intents).forEach((function(e){if(e.intentId===t.activeIntent&&e.runLocation===gt)return n=e,!1})),n)return n.onVerification().then((function(){_i(Yt.VERIFICATION_RUN_MSG(),r)}))}else _i(e,r)},_i=function(t,e){return e.tell(t)},wi=function(){var t=ri(ti().mark((function t(e){var r,n,a;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.persistentOfflineData){t.next=2;break}return t.abrupt("return");case 2:if(r=e._,n=[],e.location!==gt||e.client===vt){t.next=20;break}if(r.forEach(e._syncToEdge,(function(t,i){r.forEach(t,(function(t,r){i===o?n.push(e.deviceStorage.saveKeyInStorage(r,t)):n.push(e.deviceStorage.saveDocument(i,r,t))}))})),!(n.length>0)){t.next=20;break}return t.next=9,Promise.all(n);case 9:return t.next=11,e.online();case 11:if(!t.sent){t.next=15;break}e._syncToEdge={},t.next=20;break;case 15:if(a=e.deviceStorage.getKeyFromStorage(i),r.forEach(e._syncToCloud,(function(t,e){var n=a[e]||{};r.forEach(t,(function(t,e){n[e]=t})),a[e]=n})),!(r.size(a)>0)){t.next=20;break}return t.next=20,e.deviceStorage.saveKeyInStorage(i,a);case 20:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Si=function(){var t=ri(ti().mark((function t(e){var r,n,o;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e._,n=e.developer,e.location!==gt||e.client===vt){t.next=7;break}return o=[],r.forEach(e.responsesArray,(function(t){if(t.type===Le.SHORT_TABLE_RESPONSE()){var i=function(){var t=ri(ti().mark((function t(r){var o;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n.log({message:"Calling expand table"}),t.next=3,In.ExpandShortTableResponse(r.message,e);case 3:(o=t.sent)?(r.message=o,r.type="table"):(delete r.message,r.type="silent");case 5:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();o.push(i(t))}else if(t.type===Le.SHORT_CONTAINER_RESPONSE()){var a=function(){var t=ri(ti().mark((function t(n){var o,i;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(o=r.get(n,"message.fields"))){t.next=6;break}return t.next=4,In.ExpandShortContainerResponse(o,e);case 4:(i=t.sent)&&(n.message.fields=i,n.type="container");case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();o.push(a(t))}else if(t.type===Le.SHORT_FORM_RESPONSE()){var s=function(){var t=ri(ti().mark((function t(n){var o,i;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(o=r.get(n,"message",{})).fields){t.next=6;break}return t.next=4,In.ExpandShortFormResponse(o,e);case 4:(i=t.sent)&&(n.message.fields=i,n.type="form2");case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();o.push(s(t))}})),t.next=7,Promise.all(o);case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),ki=function(t,e,r){"Greeting"===e?t.developer.info({message:"State initialised (Greeting)"}):t.developer.info({message:"State initialised (Next)"}),t.developer.info({message:"State from storage: ",data:r}),t.developer.info({message:"Message type from user: ",data:t.messageTypeFromUser}),t.developer.info({message:"Message from User: ",data:t.messageFromUser})},Ei=function(t,e,r){return console.log("Starting init"),Di({messageType:ct,messageFromUser:{intentId:Ot}},t,e,r)},xi=function(){var t=ri(ti().mark((function t(e){var r,n,o,i,a,s,c,u,l,h;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=Date.now(),n=e._,e.developer.info({message:"Starting prediction event"}),0!==n.size(e.smartSuggestionsArray)||e.blockSuggestions){t.next=33;break}o=!1,i=[],a=Object.keys(e.intents),s=0;case 8:if(!(s<a.length)){t.next=32;break}if(c=e.intents[a[s]],u={},!(n.size(c.suggestionsArray)>0)){t.next=29;break}if(!(l=c.onPrediction)){t.next=26;break}return t.prev=14,o=!0,t.next=18,l();case 18:u.weight=t.sent,t.next=24;break;case 21:t.prev=21,t.t0=t.catch(14),e.addSystemErrorToStack(27,t.t0.errorMessage);case 24:t.next=27;break;case 26:u.weight=1;case 27:u.suggestionsArray=c.suggestionsArray,u.weight>0&&(h=n.sortedIndexBy(i,u,"weight"),i.splice(h,0,u));case 29:s++,t.next=8;break;case 32:o&&(n.each(i,(function(t){e.addSmartSuggestionsArray(t.suggestionsArray)})),e.smartSuggestionsArray=n.reverse(e.smartSuggestionsArray));case 33:return t.next=35,e.developer.logCurrentEventDurationWithStartTime("runPredictors",r,Date.now());case 35:case"end":return t.stop()}}),t,null,[[14,21]])})));return function(e){return t.apply(this,arguments)}}(),Ii=function(){var t=ri(ti().mark((function t(e){var r,n,o,i;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=Date.now(),n=e._,e.developer.info({message:"Starting controller event"}),t.next=6,e.online();case 6:return e.amIOnline=t.sent,t.next=9,Ni(e);case 9:if(e.activeIntent===At.SPEECH()||e.activeIntent===_t){t.next=42;break}return t.next=12,e.onStart();case 12:if(e.activeIntent!==Ot){t.next=15;break}return t.next=15,e.addRunModeResponse();case 15:if(!e.toCustomCap){t.next=22;break}return t.next=18,vi(e);case 18:return t.next=20,e.developer.logCurrentEventDurationWithStartTime("controller",r,Date.now());case 20:t.next=42;break;case 22:if(e.developer.info({message:"Before onStart"}),e.developer.info({message:"Before onInts"}),!e.onlineRequired||e.amIOnline){t.next=27;break}return e.addSystemErrorToStack(56),t.abrupt("return");case 27:return t.next=29,e.runAllOnInits();case 29:if(fi(),!mi(e)){t.next=42;break}if(o=n.get(e,"intents.".concat(e.activeIntent,".runLocation"),gt),e.location!==o&&e.location!==gt){t.next=41;break}return t.next=35,gi(e);case 35:return t.next=37,e.developer.logCurrentEventDurationWithStartTime("controller",r,Date.now());case 37:return t.next=39,e.storeAutoSaveBuffer();case 39:t.next=42;break;case 41:e.developer.warning({message:"Bot tried to run a ".concat(o," intent in ").concat(e.location),data:e.activeIntent});case 42:t.next=49;break;case 44:t.prev=44,t.t0=t.catch(0),console.log("Error in controller"),i=e.location===gt?5:7,e.addSystemErrorToStack(i,t.t0.message);case 49:case"end":return t.stop()}}),t,null,[[0,44]])})));return function(e){return t.apply(this,arguments)}}(),Ti=function(t,e){t.developer.info({message:"Starting view event"});var r=t._,n=Date.now();return new Promise(function(){var e=ri(ti().mark((function e(o,i){var a,s,c,u;return ti().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.conversational||t.inError||!(t.waitingCustomCap>0)||0!==r.get(t.responsesArray,"length",0)){e.next=4;break}return t.developer.info({message:"Ending here",data:{conversational:t.conversational,waitingForCustomCap:t.waitingCustomCap,responsesArrayLength:r.get(t.responsesArray,"length",0)}}),o(),e.abrupt("return");case 4:if(!t.conversational||t.inSilence){e.next=7;break}return e.next=7,xi(t);case 7:if(t.developer.info({message:"Start processing responses"}),t.inError?t.onError(t):0!==t.responsesArray.length||0!==t.smartSuggestionsArray.length||t.sendMessageParam||t.toCustomCap||t.autoResponse||(a={responsesQ:t.responsesArray.length,suggestionsQ:t.smartSuggestionsArray.length,sendMSG:t.sendMessageParam,toCustomCap:t.toCustomCap,activeIntent:t.activeIntent,messageTypeFromUser:t.messageTypeFromUser,messageFromUser:t.messageFromUser},t.developer.warning({message:Ht.getErrorMessageforCodeAndLang(63),errorCode:63,data:a})),t.removeActiveIntent(),!t.silentIntent){e.next=15;break}return t.clearResponseArray(),t.clearError(),o(),e.abrupt("return");case 15:return s=t.smartSuggestionsArray,r.size(t.responsesArray)>0&&(t.intentResolved=!0,r.each(t.responsesArray,(function(e){var n=new(t.context.getCapability("Message"))({uuid:e.messageId});if(e.type===t.messageTypes.MESSAGE_TYPE_STRING)n.stringMessage(e.message),bi(t,n,t.context);else if(e.type===t.messageTypes.MESSAGE_TYPE_WEB_CARD){var o=e.message.cards,i=e.message.previews;n.webCard(o,i),bi(t,n,t.context)}else if(e.type===t.messageTypes.MESSAGE_TYPE_FORM2){var a=e.message;n.form2Message(a.fields,a.options),bi(t,n,t.context)}else if("form_live_changes"===e.type)e.message.result?n.form2Message(e.message.result,e.message.options):n.form2Message(e.message.options),bi(t,n,t.context);else if("table_live_changes"===e.type)n.tableMessage(e.message.result,e.message.options),bi(t,n,t.context);else if("form_close"===e.type)n.closeFormMessage&&(n.closeFormMessage(e.message),bi(t,n,t.context));else if(e.type===t.messageTypes.MESSAGE_TYPE_SMART_SUGGESTIONS)s=e.message;else if(e.type===t.messageTypes.MESSAGE_TYPE_TABLE){var c=e.message;c.options&&c.options.style===ut?n.calendarMessage(c.rows,c.options):c.options&&c.options.style===ht?n.mapMessage(c.rows,c.options):n.tableMessage(c.rows,c.options),bi(t,n,t.context)}else if("data_card"===e.type)if(t.conversation.client===yt){var u=e.message;n.dataCard(u),bi(t,n,t.context)}else{var l="Data cards are not yet available in your client";t.addSystemErrorToStack(5,l),bi(t,l,t.context)}else if(e.type===t.messageTypes.MESSAGE_TYPE_CARDS){var h=e.message.cards,f=e.message.options;n.cards(h,f),bi(t,n,t.context)}else if(e.type===t.messageTypes.MESSAGE_TYPE_MAP){var d=e.message,p={region:d.region,markers:r.get(d,"markers"),polylines:r.get(d,"polylines"),planeRoutes:r.get(d,"planeRoutes"),cards:r.get(d,"cards"),geoJsonUrl:r.get(d,"geoJsonUrl","")};n.mapMessage(p,d.options),bi(t,n,t.context)}else if("standard_notification"===e.type)n.standardNotification(e.message),bi(t,n,t.context);else if("critical_notification"===e.type)n.criticalNotification(e.message),bi(t,n,t.context);else if("authorization_request"===e.type)n.authorizationRequest(e.message),bi(t,n,t.context);else if("stripe"===e.type)if(t.client===yt||t.client===mt){var y="Message type not supported on this client";t.addSystemErrorToStack(5,y),bi(t,y,t.context)}else{var v=e.message,m=v.amount,g=v.currency,b=v.description,_=v.paymentCode;(r.isUndefined(_)||r.isEmpty(_))&&(_=ce.PAYMENT_CODES().TOP_UP_WALLET);var w=t.orders.createNewStripeTransaction(m,g,b);t.context.getCapability("Stripe").startPayment(w,m,g,b,t.context,_)}else if(e.type===t.messageTypes.MESSAGE_TYPE_CHART){var S=e.message;n.chartMessage(S.data,S.options),bi(t,n,t.context)}else if("slider"===e.type)n.sliderMessage(e.message.list,e.message.options),bi(t,n,t.context);else if(e.type===t.messageTypes.MESSAGE_TYPE_VIDEO)n.videoMessage(e.message),bi(t,n,t.context);else if("trackerForm"===e.type)n.trackingViewMessage(e.message.data,e.message.options),bi(t,n,t.context);else if("html"===e.type)n.htmlMessage(e.message.message,e.message.options),bi(t,n,t.context);else if("container"===e.type)n.containerMessage(e.message.fields,e.message.options),bi(t,n,t.context);else if("close_control"===e.type)n.closeControlMessage(e.message);else if(e.type===I){var k,E;n.videoCallMessage(null===(k=e.message)||void 0===k?void 0:k.data,null===(E=e.message)||void 0===E?void 0:E.options),bi(t,n,t.context)}else if("menuMessage"===e.type)n.menuMessage(e.message),bi(t,n,t.context);else if("sound"===e.type)n.soundResponse(e.message),bi(t,n,t.context);else if("image"===e.type)n.imageMessage(e.message),bi(t,n,t.context);else if(e.type===t.messageTypes.MESSAGE_TYPE_CSV)n.csvMessage(e.message),bi(t,n,t.context),bi(t,n,t.context);else if(e.type===no.GEOFENCE_MESSAGE())n.geofenceMessage(e.message.coordinates,e.message.options),bi(t,n,t.context);else if(e.type===Le.SHORT_TABLE_RESPONSE());else if(e.type===Le.SHORT_CONTAINER_RESPONSE());else if(e.type===Le.MESSAGE_TYPE_SURVEY())n.surveyMessage(e.message.data,e.message.options),bi(t,n,t.context);else if(e.type===Le.MESSAGE_VOICE_CALL())n.voiceCall(e.message),bi(t,n,t.context);else if(e.type===Le.MESSAGE_TYPE_TIMELINE_LIST())n.timelinesListMessage(e.message,e.message.options),bi(t,n,t.context);else if(e.type===Le.MESSAGE_TYPE_TIMELINE_POST())n.timelinesPostMessage(e.message),bi(t,n,t.context);else if(e.type===Le.DASHBOARD())n.dashboardMessage({},e.message.options),bi(t,n,t.context);else if(e.type===Le.MESSAGE_TYPE_AICC_STRING()){var x,T;n.aiccPlayer(null===(x=e.message)||void 0===x?void 0:x.data,null===(T=e.message)||void 0===T?void 0:T.options),bi(t,n,t.context)}else if("silent"!==e.type){var O="Message type not supported";t.addSystemErrorToStack(5,O),bi(t,O,t.context)}})),t.waitingCustomCap=0),t.clearResponseArray(),t.clearError(),c=t.context.getCapability("Message"),u=new c,r.size(t.smartSuggestionsArray)>0?(u.smartSuggestions(s),t.developer.info({message:"Displaying suggestions "+JSON.stringify(s)}),bi(t,u,t.context)):(t.blockSuggestions||t.inSilence)&&(u.smartSuggestions([]),bi(t,u,t.context)),t.clearSmartSuggestionsArray(),t.resetOnErrorMethod(),t.developer.info({message:"Finished processing responses"}),t.toCustomCap=!1,o(),e.next=29,t.developer.logCurrentEventDurationWithStartTime("view",n,Date.now());case 29:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}())},Oi=function(){var t=ri(ti().mark((function t(e){var r,n;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r={},n=e.getCapability("authContext"),0!==Object.keys(Hn.user).length){t.next=10;break}if(r="function"==typeof n.getUserData?n.getUserData():{},0!==Object.keys(r).length){t.next=8;break}return t.next=7,n.getAuthUser(e);case 7:r=t.sent;case 8:t.next=11;break;case 10:r=Hn.user;case 11:return t.abrupt("return",r);case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Ci=function(){var t=ri(ti().mark((function t(e,r){var n;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.getCapability("ConversationContext"),0!==Object.keys(Hn.conversation).length){t.next=7;break}return t.next=4,n.getConversationContext(e,r);case 4:t.t0=t.sent,t.next=8;break;case 7:t.t0=Hn.conversation;case 8:return t.abrupt("return",t.t0);case 9:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}(),Li=function(){var t=ri(ti().mark((function t(e,r){return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.messageTypeFromUser!==Le.BACKEND_RESPONSE()&&e.setField(pt,r);case 1:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}(),Pi=function(){var t=ri(ti().mark((function t(e){var r,n;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null===(r=e.getField(pt))||0!==e.backendResponseType||0!==e.waitingCustomCap){t.next=10;break}return e.developer._performanceLogs=!0,n=Date.now(),t.next=6,e.developer.logCurrentEventDurationWithStartTime(pt,r,n,"Final performance",(n-r)/1e3);case 6:if(!(n-n>3e3)){t.next=9;break}return t.next=9,e.developer.warning({message:"PERFORMANCE WARNING",data:n-n});case 9:e.clearField(pt);case 10:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Di=function(){var t=ri(ti().mark((function t(e,r,n,o){var i,a,s,c,u,l,h,f,d,p,y,v,m,g,b;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,console.log("************* Next method ****************"),i=Date.now(),a=0,s=0,c=0,u=0,l=Date.now(),h=0,t.next=11,Oi(o);case 11:return f=t.sent,d=null,p=null,h=Date.now(),c=Date.now(),t.next=18,Ci(o,f);case 18:if(y=t.sent,u=Date.now(),di.conversation=y.conversationId,a=Date.now(),!Hn._persistentState){t.next=28;break}return t.next=25,di.getContext(o);case 25:t.t0=t.sent,t.next=29;break;case 28:t.t0={};case 29:return v=t.t0,m=Date.now(),s=Date.now(),f.userName=f.info.name,f.userId=f.info.userId,f.userEmail=f.info.emailAddress,f.tz=f.info.userTimezone,Hn.init(e,y,f,gt,v,o),Hn.removeActiveIntent(),ki(Hn,"Next",v),t.next=41,Hn.developer.logCurrentEventDurationWithStartTime("loadAuthCap",l,h);case 41:return t.next=43,Hn.developer.logCurrentEventDurationWithStartTime("loadConversationCap",c,u);case 43:return t.next=45,Hn.developer.logCurrentEventDurationWithStartTime("loadStorageCap",a,s);case 45:return t.next=47,Hn.developer.logCurrentEventDurationWithStartTime("initialiseState",m,Date.now());case 47:return t.next=49,Li(Hn,i);case 49:return p=Hn._,t.next=52,Hn.loadAutoSaveBuffer();case 52:if(Hn.syncWithBackendState(r),Hn.client!==Hn.responseToClient&&Hn.responseToClient!==vt){t.next=101;break}if(0!==Hn.backendResponseType){t.next=91;break}if(!e.requestId){t.next=58;break}if(Hn.markRequestIdProcessed(e.requestId)){t.next=58;break}return t.abrupt("return");case 58:if(Hn.intentResolved||0!==p.size(Hn.errorStack)){t.next=61;break}return t.next=61,Ii(Hn);case 61:return t.next=63,Si(Hn);case 63:return t.next=65,Ti(Hn);case 65:return t.next=67,o.wait(!1);case 67:if(Hn.silentIntent||Hn.intentResolved||!(Hn.waitingCustomCap>0&&"close"!==Hn.messageFromUser.action&&"move"!==Hn.messageFromUser.action&&"cancel"!==Hn.messageFromUser.action&&Hn.messageTypeFromUser!==Le.BOT_TO_BOT()||Hn.sendMessageParam)){t.next=70;break}return t.next=70,o.wait(!0);case 70:return Hn.intentResolved&&(Hn.intentResolved=!1),Hn.sendMessageParam&&(d=Hn.sendMessageParam,Hn.sendMessageParam=null),t.next=74,Hn.developer.logCurrentEventDurationWithStartTime("totalNextMethod",i,Date.now());case 74:return t.next=76,Pi(Hn);case 76:return t.next=78,Hn.save(di);case 78:if(!d){t.next=89;break}if(g={messageFromUser:d},b=!1,"string"==typeof d?g.messageType="string":(g.messageType="object",d.intentId&&"@@reset"===d.intentId&&(b=!0)),!b){t.next=87;break}return t.next=85,Ei(void 0,{reset:!0},o);case 85:t.next=89;break;case 87:return t.next=89,Di(g,void 0,{},o);case 89:t.next=101;break;case 91:if(1!==Hn.backendResponseType){t.next=96;break}return t.next=94,Hn.save(di);case 94:t.next=101;break;case 96:if(2!==Hn.backendResponseType){t.next=101;break}return t.next=99,wi(Hn);case 99:return t.next=101,Hn.save(di);case 101:return t.next=103,ui();case 103:t.next=119;break;case 105:if(t.prev=105,t.t1=t.catch(0),!(Hn instanceof zn)){t.next=118;break}if(0!==Hn.backendResponseType){t.next=114;break}return Hn.addSystemErrorToStack(5,t.t1.message),t.next=112,Ti(Hn);case 112:return t.next=114,Hn.save(di);case 114:return t.next=116,ui();case 116:t.next=119;break;case 118:console.log("Something very wrong "+t.t1.message);case 119:return t.abrupt("return",{status:200});case 120:case"end":return t.stop()}}),t,null,[[0,105]])})));return function(e,r,n,o){return t.apply(this,arguments)}}(),Fi=function(t,e,r,n){var o=n.getCapability("Utils").Lodash,i=o.get(t,"details[0].message");if(o.get(i,"success")||o.get(i,"StatusCode"))return ui();o.get(t,"messageId"),o.get(t,"requestUuid");var a={type:"USER",entry:{userDomain:"unknown",userId:"unknown",userEmail:"unknown",botId:o.get(t,"messageId"),conversationId:o.get(t,"requestUuid"),entity:"Micro-App",intent:"unknown",client:"unknown",location:gt,timestamp:Date.now(),level:"LOG",message:"Started async_result in mobile",data:t}};n.log(a);var s=o.get(t,"requestUuid");if(console.log("************* Data Received ****************"),console.log(JSON.stringify(i)),console.log("************* Data Received ****************"),i&&s&&""!==s){var c=o.get(t,"contentType"),u={messageDate:o.get(t,"createdOn"),createdBy:o.get(t,"createdBy"),uuid:o.get(t,"messageId"),requestId:s,contentType:c};return c===Le.BACKEND_RESPONSE()?u.messageType=Le.BACKEND_RESPONSE():(u.messageType=Le.BOT_TO_BOT(),u.messageFromUser=i),Di(u,i,r,n)}},Ai=function(t){t.developer;var e,r=t.nlp.nlpIds;if(t.developer.info({message:"Starting NLP event",data:r}),!t.inSilence&&("string"===t.messageTypeFromUser||(null===(e=t.messageFromUser)||void 0===e?void 0:e.intentId)===Tt)){if(t.nlp.nlpEngine===Et.DIALOGFLOW){if(r.length>0){var n={capability:"NLP2",capabilityFileName:"nlpv2",queryString:t.messageFromUser,nlpIds:r,sync:!0,userId:t.user.userId,conversation:t.conversation};return t.callCapability(n)}return t.developer.warning({message:"No NLP Engine added to the bot"}),[]}return t.nlp.nlpEngine===Et.OPEN_AI?t.nlp.callOpenAIWithMessageFromUser({service:It}):new Promise((function(e,r){var n={botAlias:t.nlp.nlpAlias,botName:t.nlp.nlpIds[0],inputText:t.messageFromUser,userId:t.conversationId,sessionAttributes:{}};(new t.aws.LexRuntime).postText(n,(function(t,r){e(t||r)}))}))}},Ri=function(t,e){var r=t._;if(t.nlp.nlpEngine===Et.DIALOGFLOW)r.each(e,(function(e){if(t.developer.info({message:"Response from NLP",data:e}),"Invalid NLP ID"!==e.error){var n="",o=e.action,i=e.nlpId;t.developer.info({message:"Found NLP action: ",data:o}),e.parameters&&r.size(e.parameters)>0&&(n=e.parameters,t.developer.info({message:"Found NLP parameters: ",data:n}));var a=[];e.messages&&r.forEach(e.messages,(function(e){4===e.type&&e.payload.messages&&(t.addSmartSuggestionsArray([{lang:t.lang,list:e.payload.messages}]),a=e.payload.messages)})),t.nlpResults[i]={speech:""},e.speech&&""!==e.speech&&(t.nlpResults[i].speech=e.speech),t.nlpResults[i].action=o,t.nlpResults[i].nlpParameters=t.nlp.getNlpParameters(n),t.nlpResults[i].nlpSuggestions=a}else t.addSystemErrorToStack(24,e.nlpId)}));else{var n=t.nlp.nlpIds[0];t.nlpResults[n]={action:e.intentName,nlpParameters:e.slots},""!==e.message&&(t.nlpResults[n].speech=e.message)}},Ni=function(){var t=ri(ti().mark((function t(e){var r,n,o,i,a,s,c,u,l,h;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.nlpResults={},r=e._,e.R,n=e.developer,!e.developer.isDeveloperIntent()){t.next=9;break}if(!(o=e.developer.identifyDeveloperIntent())){t.next=9;break}return e.addActiveIntent(o,!1),t.abrupt("return");case 9:if(e.developer.info({message:"Starting matching logic"}),""!==e.activeIntent){t.next=31;break}return t.next=13,pi(e);case 13:if(""!==e.activeIntent){t.next=28;break}if(i=Date.now(),e.location!==bt&&e.client!==vt){t.next=21;break}return t.next=18,Ai(e);case 18:t.t0=t.sent,t.next=22;break;case 21:t.t0=[];case 22:return a=t.t0,n.logCurrentEventDurationWithStartTime("nlpCalls",i,Date.now()),n.debug({message:"Before processing NLP",data:a}),Array.isArray(a)?a.length>0&&Ri(e,a):a&&"string"==typeof a?e.nlpResults[e.nlp.assistantName]={speech:a}:a&&"object"===Zo(a)&&(e.nlpResults[e.nlp.assistantName]=a),t.next=28,pi(e);case 28:""===e.activeIntent?r.size(e.nlpResults)>0&&(s=!0,c="Sorry, I didn't get that",Object.values(e.nlpResults).forEach((function(t){""!==t.speech&&(t.action===_t?(c=t.speech,e.addActiveIntent(_t)):s?(e.addActiveIntent(At.SPEECH()),e.addStringResponse(t.speech),s=!1):e.disambiguate||e.addSystemErrorToStack(22))})),0===e.responsesArray.length&&e.addStringResponse(c)):(null===(u=e.messageFromUser)||void 0===u?void 0:u.intentId)===Tt&&((h=(null===(l=e.nlpResults[e.nlp.assistantName])||void 0===l?void 0:l.q)||[]).length>0?e.addEnglishSmartSuggestions(h):e.addSilentResponse()),t.next=32;break;case 31:e.developer.info({message:"Intent already matched ",data:e.activeIntent});case 32:return t.next=34,e.recordActivity({onMatching:!0,stamp:4});case 34:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),ji=function(){var t=ri(ti().mark((function t(e,r,n){var o,i,a,s,c,u,l,h,f,d,p,y;return ti().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,r.promise,o=r._,r.R,i=Date.now(),a=0,s=e.state,c=e.conversation,u={userId:e.userId,userEmail:e.userEmail,userDomains:e.userDomains,userName:e.state.userName,tz:e.userTimezone},r.botManifest=n.botManifest,Hn.init(null,c,u,bt,s,r),Hn.developer.debug({message:"Full params",data:e}),!Hn.reportActivityOnMain){t.next=19;break}return Hn.addSilentResponse(),t.next=17,Hn.recordActivity({onMatching:!0,stamp:5});case 17:return t.next=19,Hn.recordActivity({stamp:6});case 19:return l=Hn.getGreetingIntent(),t.next=22,Hn.onStart();case 22:return Hn.developer.info({message:"State initialised (cloud)",data:e}),fi(),t.next=26,Hn.runAllOnInits();case 26:return t.next=28,Hn.syncDataToDB();case 28:return t.next=30,Hn.sendDelayedNotifications();case 30:return t.next=32,Hn.loadAutoSaveBuffer();case 32:return t.next=34,Ni(Hn);case 34:if(!(h=l.onInitCloud)){t.next=38;break}return t.next=38,h();case 38:if(Hn.inError){t.next=56;break}if(f=Date.now(),""===Hn.activeIntent||Hn.activeIntent===At.SPEECH()||Hn.activeIntent===_t){t.next=56;break}if(t.prev=41,mi(Hn),0!==o.size(Hn.errorStack)){t.next=51;break}return t.next=46,gi(Hn);case 46:return t.next=48,Hn.developer.logCurrentEventDurationWithStartTime("backendController",f,Date.now());case 48:return a=Date.now(),t.next=51,Hn.storeAutoSaveBuffer();case 51:t.next=56;break;case 53:t.prev=53,t.t0=t.catch(41),Hn.addSystemErrorToStack(7,"Event caught by try/catch",JSON.stringify(t.t0));case 56:return t.next=58,Hn.developer.logCurrentEventDurationWithStartTime("startAutoSaveBuffer",a,Date.now());case 58:o.size(Hn.responsesArray)>0||o.size(Hn.smartSuggestionsArray)>0||Hn.inError||Hn.sendMessageParam?(Hn.intentResolved=!0,"_dev_"===Hn.activeIntent.substring(0,5)&&Hn.removeActiveIntent()):Hn.cloudIntent&&(Hn.intentResolved=!1,Hn.developer.info({message:"Found No intent"}),Hn.addActiveIntent(_t));try{o.size(Hn.errorStack)>0&&(Hn.onError(Hn),Hn.resetOnErrorMethod())}catch(t){Hn.addSystemErrorToStack(11,t.message)}return t.next=62,Hn.developer.logCurrentEventDurationWithStartTime("fullCustomCap",i,Date.now());case 62:return d=Hn.getFinalResponseState(),Hn.developer.info({message:"Sending state to queue",data:d}),t.next=66,Hn.sendResponseToClient(d);case 66:return d=Hn.getFinalResponseSync(),Hn.developer.info({message:"Sending data sync to queue",data:d}),t.next=70,Hn.sendResponseToClient(d);case 70:if(p=Hn.getFinalResponsesArray(),Hn.developer.info({message:"Sending responses to queue",data:p}),!Hn.apiResponse){t.next=76;break}t.t1=p,t.next=79;break;case 76:return t.next=78,Hn.sendResponseToClient(p);case 78:t.t1=t.sent;case 79:return y=t.t1,Hn.developer.info({message:"Ending"}),t.abrupt("return",y);case 84:return t.prev=84,t.t2=t.catch(0),Hn.addSystemErrorToStack(8,t.t2),t.abrupt("return",Hn.getFinalResponseState());case 88:case"end":return t.stop()}}),t,null,[[0,84],[41,53]])})));return function(e,r,n){return t.apply(this,arguments)}}(),Mi=function(t,e,r){},Ui=function(t,e,r,n){if(t&&n)return Di(t,e,r,n)},Bi=function(){return Hn.actyiveWithMessage}}(),botModule=e}(); 
    return botModule;
})()
